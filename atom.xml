<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Reagan&#39;s Blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blog.joshdreagan.com/"/>
  <updated>2018-03-02T07:00:51.000Z</updated>
  <id>http://blog.joshdreagan.com/</id>
  
  <author>
    <name>Josh Reagan</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Camel CXFRS Contract First</title>
    <link href="http://blog.joshdreagan.com/2018/03/02/camel_cxfrs_contract_first/"/>
    <id>http://blog.joshdreagan.com/2018/03/02/camel_cxfrs_contract_first/</id>
    <published>2018-03-02T07:00:51.000Z</published>
    <updated>2018-03-02T07:00:51.000Z</updated>
    
    <content type="html"><![CDATA[<p>I’ve recently had a rash of customers who want to do contract driven REST development. That is, they want to define the contract for their service up front, and then generate their interfaces and models. And like all subjects, if I get asked about it enough times, I’ll write it down in a blog. So here goes…<a id="more"></a></p><p>First, why would someone want to generate code from their contract? Well… we certainly don’t want to have to keep code and contract in sync manually. That would be extremely error prone (and would repeat the same mistakes we made in the early days of SOAP/WSDL). So that leaves two options: Either we generate the contract from the code (ie, code-first), or we generate the code from the contract (ie, contract-first). If we choose to go the code-first route, what we usually do is add some annotations (or add additional metadata via some language/library specific means), deploy the code to a running server, and then pull the contract by hitting (HTTP GET’ing) a special url. This seems all fine and good since it gives us a contract that is exposed for clients to consume. What more do we need right? As it turns out though, many organizations don’t do development this way. In fact, many of them will want to develop their contract well before implementation takes place. Often times, that contract is even developed by a separate team. So in these cases, we need to go contract-first. Which means that we have to figure out a way to generate the code…</p><p>Now that we’re through all of that “intro” business, let’s talk about how one might actually accomplish this. There are many competing specs for defining REST contracts (ie, WADL, RAML, API Blueprint, …), but the most popular (and the one I’ll be targeting for this post) seems to be Swagger/OpenAPI. If you check out <a href="https://swagger.io/swagger-codegen/" target="_blank" rel="noopener">Swagger’s website</a>, you’ll see that they’ve implemented some tooling to do this code generation. What’s more, the tooling is actually pretty pluggable and can be used to generate implementation/model files for <a href="https://generator.swagger.io/api/gen/servers" target="_blank" rel="noopener">many different languages</a>. It doesn’t have the best documentation, and can be a bit buggy at times. But luckily it’s open source. So we can just read through <a href="https://github.com/swagger-api/swagger-codegen" target="_blank" rel="noopener">the code</a> to figure out how it works. And after all, code is really the best documentation… ;) Here’s a snippet of what the plugin configuration might look like:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.swagger<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swagger-codegen-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;swagger-codegen-maven-plugin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">executions</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>generate-sources<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">goals</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>generate<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">inputSpec</span>&gt;</span>src/main/swagger/api.json<span class="tag">&lt;/<span class="name">inputSpec</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">language</span>&gt;</span>jaxrs-cxf<span class="tag">&lt;/<span class="name">language</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">generateSupportingFiles</span>&gt;</span>false<span class="tag">&lt;/<span class="name">generateSupportingFiles</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">modelPackage</span>&gt;</span>org.apache.camel.examples.model<span class="tag">&lt;/<span class="name">modelPackage</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">apiPackage</span>&gt;</span>org.apache.camel.examples.api<span class="tag">&lt;/<span class="name">apiPackage</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">output</span>&gt;</span>$&#123;project.build.directory&#125;/generated-sources<span class="tag">&lt;/<span class="name">output</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">generateApiTests</span>&gt;</span>false<span class="tag">&lt;/<span class="name">generateApiTests</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">configOptions</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">sourceFolder</span>&gt;</span>swagger<span class="tag">&lt;/<span class="name">sourceFolder</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">implFolder</span>&gt;</span>swagger<span class="tag">&lt;/<span class="name">implFolder</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">configOptions</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div></pre></td></tr></table></figure><p>Once we have the plugin properly configured, it will bind to the <code>generate-sources</code> lifecycle phase of our Maven build. Which means that the code it outputs will be on our classpath, and all we need to do is create our implementation. Here’s a snippet of how you might do just that using <a href="http://camel.apache.org/" target="_blank" rel="noopener">Apache Camel</a> (the most awesome framework available!):</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">from(<span class="string">"cxfrs:/camel?resourceClasses=org.apache.camel.examples.api.MyServiceApi"</span>)</div><div class="line">  .routingSlip(simple(<span class="string">"direct:$&#123;headers[operationName]&#125;"</span>))</div><div class="line">;</div><div class="line"></div><div class="line">from(<span class="string">"direct:myServiceOperation"</span>)</div><div class="line">  .log(<span class="string">"This is where you should fill in your method implementations..."</span>)</div><div class="line">;</div></pre></td></tr></table></figure><p>If you want to see what a full project looks like, I’ve created an example that uses the above tooling to generate the JAXRS/CXF annotated Java interfaces/model files from a real API JSON file that I downloaded from Swagger’s website. It then uses those generated files to create an implementation in Camel, and runs it on a <a href="https://projects.spring.io/spring-boot/" target="_blank" rel="noopener">Spring Boot</a> container. Give it a look here: <a href="https://github.com/joshdreagan/camel-swagger-contract-first" target="_blank" rel="noopener">https://github.com/joshdreagan/camel-swagger-contract-first</a>.</p><p>So now that we know how to do contract-first REST development (and even have an example), we can just copy/paste any time we want to start a new project. But can we do better? I think so… As it turns out, Maven has a baked-in mechanism for creating templates to generate new projects. They’re called Maven Archetypes. Usually, you just create an archetype project as defined by <a href="https://maven.apache.org/archetype/maven-archetype-plugin/" target="_blank" rel="noopener">the docs</a>. The archetype project contains a fairly simple descriptor XML, and a bunch of <a href="http://velocity.apache.org/" target="_blank" rel="noopener">Velocity</a> templates for each of the files you want to be included in your generated project. This allows you to do simple property expansion (ie, <code>groupId</code>, <code>artifactId</code>, <code>package</code>, …), conditionals, and even some looping inside of your template files. Once you build/install the archetype, you can crank out new projects by simply executing a command like this:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ mvn archetype:generate -DarchetypeCatalog=local \</div><div class="line">                         -DarchetypeGroupId=org.apache.camel.archetypes \</div><div class="line">                         -DarchetypeArtifactId=my-custom-archetype \</div><div class="line">                         -DarchetypeVersion=1.0.0-SNAPSHOT \</div><div class="line">                         -DgroupId=com.mycompany \</div><div class="line">                         -DartifactId=myproject \</div><div class="line">                         -Dversion=1.0.0-SNAPSHOT</div></pre></td></tr></table></figure><p>However, if you looked at the example project I gave you above, you’d notice that some of the files need values that are parsed from the Swagger API doc. So Velocity templates alone won’t cut it… We could just leave those values blank (or put in some sort of placeholder), and then have the user fill them in after the project generation. But once again, we can do better… There is a little known (and horribly under-documented) feature that we can take advantage of to automate things. If you look under the <a href="https://maven.apache.org/archetype/maven-archetype-plugin/advanced-usage.html" target="_blank" rel="noopener">“Advanced Usage”</a> section of the archetype plugin docs, you will see a reference to a “Post-generation script” (toward the bottom of the page). Basically, you can just include a <a href="http://groovy-lang.org/" target="_blank" rel="noopener">Groovy</a> script named <code>archetype-post-generate.groovy</code> inside the <code>src/main/resources/META-INF/</code> folder, and its contents will be executed during project generation (after the Velocity templates have been applied, and the files copied into their destinations). And because Groovy is super awesome and incredibly powerful, we can use it do pretty much anything we want. For instance, parsing up a JSON file and using its values to replace extra placeholders in our project files… Neat! Here’s an example archetype project to get you started: <a href="https://github.com/joshdreagan/camel-archetype-spring-boot-cxfrs-contract-first" target="_blank" rel="noopener">https://github.com/joshdreagan/camel-archetype-spring-boot-cxfrs-contract-first</a>. Enjoy!</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;I’ve recently had a rash of customers who want to do contract driven REST development. That is, they want to define the contract for their service up front, and then generate their interfaces and models. And like all subjects, if I get asked about it enough times, I’ll write it down in a blog. So here goes…
    
    </summary>
    
    
      <category term="fuse" scheme="http://blog.joshdreagan.com/tags/fuse/"/>
    
      <category term="camel" scheme="http://blog.joshdreagan.com/tags/camel/"/>
    
      <category term="jboss" scheme="http://blog.joshdreagan.com/tags/jboss/"/>
    
      <category term="cxf" scheme="http://blog.joshdreagan.com/tags/cxf/"/>
    
  </entry>
  
  <entry>
    <title>Upgrading AMQ 6 to AMQ 7</title>
    <link href="http://blog.joshdreagan.com/2017/12/01/upgrading_amq_6_to_amq_7/"/>
    <id>http://blog.joshdreagan.com/2017/12/01/upgrading_amq_6_to_amq_7/</id>
    <published>2017-12-01T22:30:03.000Z</published>
    <updated>2018-02-20T00:10:41.000Z</updated>
    
    <content type="html"><![CDATA[<p>So <a href="https://developers.redhat.com/products/amq/overview/" target="_blank" rel="noopener">Red Hat AMQ 7</a> has been out for a while now, and there have already been a lot of customers who are understandably eager to upgrade to the latest and greatest version. Many of them have been reaching out and asking for help/instructions on how to migrate. So far I’ve been replying that I already blogged about that here: <a href="/2016/08/22/decommissioning_jboss_a-mq_brokers/" title="Decommissioning JBoss A-MQ brokers">Decommissioning JBoss A-MQ brokers</a>. But that reply has been met with some confusion. So I figured I’d write up a more concrete set of instructions.<a id="more"></a></p><p>Let’s start by stating the problem: “I have a current, production system that is utilizing AMQ 6 and I’d like to upgrade it to AMQ 7 with as little downtime as possible”. Well… such things do require a bit of planning, but it’s not as difficult as it might seem. The easiest way to upgrade any app is <em>usually</em> to do a rolling upgrade. I emphasize “<em>usually</em>“ because every customer has a slightly different case, architecture, requirements, or other wrenches that can make things more difficult. But for the purpose of this blog, let’s focus on the most typical case.</p><p>For the first step, let’s walk through upgrading the brokers. First, we’ll need to install AMQ 7 and create a broker instance. No need to enumerate the steps here since that’s already been covered in the docs: [<a href="https://access.redhat.com/documentation/en-us/red_hat_jboss_amq/7.0/html/using_amq_broker/" target="_blank" rel="noopener">https://access.redhat.com/documentation/en-us/red_hat_jboss_amq/7.0/html/using_amq_broker/</a>]. For the purpose of this post, we’ll assume that you plan to match your existing setup (ie, if you currently have a master/slave pair, you will install a new AMQ 7 master/slave pair). If you’re installing to new hardware, you can go ahead and start the newly created broker instance(s). Otherwise, we’ll have to shut down the existing AMQ 6 broker before starting the AMQ 7 broker. Yes… you could modify the ports and bring it up alongside your AMQ 6 broker, but you risk causing a contention for resources if you do so. So best not to tempt fate…</p><p>Next, let’s talk about the clients. One of the awesome features in AMQ 7 is that is supports all of the same protocols that AMQ 6 did (in addition to a couple more). This means that your existing clients (with their existing client libraries) can seamlessly connect to the new AMQ 7 brokers. All you’ll need to do is give the clients the new broker URL and they can immediately begin producing/consuming. And you don’t even need to do that if you installed to the same hardware and bound to the same port. In fact, if your clients are using the “failover” protocol (and you didn’t update the host/port), they will automatically switch over as soon as you take down the AMQ 6 broker and bring the AMQ 7 broker online. Neat! <img style="display: inline; height: 15px;" src="/2017/12/01/upgrading_amq_6_to_amq_7/banana_dance.gif"> It’s worth noting that this will not be the case forever. Eventually, the OpenWire format (and potentially other formats) will be deprecated and removed from support. But that is a long ways away. So you’ll have plenty of time to go back through and update all of your client applications with the newer client libraries as time/budget permits.</p><p>But what about those in-flight messages? The messages that had been accepted by the old AMQ 6 instance, but had not yet been delivered to a consumer client. Well, that is exactly what I wrote <a href="/2016/08/22/decommissioning_jboss_a-mq_brokers/" title="my previous blog post">my previous blog post</a> about. Those messages cannot be lost. So we need to “drain” them from the old AMQ 6 KahaDB store and send them to the new AMQ 7 broker. Luckily, due to the fact that the AMQ 7 broker can still speak OpenWire, you can use the exact same drainer code that I provided in that blog: [<a href="https://github.com/joshdreagan/activemq-drainer" target="_blank" rel="noopener">https://github.com/joshdreagan/activemq-drainer</a>]. Super neat! <img style="display: inline; height: 15px;" src="/2017/12/01/upgrading_amq_6_to_amq_7/carlton_dance.gif"></p><p>That’s it! Rinse and repeat for each broker instance/pair. You can do it all at once, or in a “rolling” fashion. Up to you…</p><p>So to summarize, here are the high-level steps that you will perform:</p><ul><li>Install the new AMQ 7 broker/instance.</li><li>Stop the AMQ 6 broker.</li><li>Start the AMQ 7 broker.</li><li>Update your clients with the new broker URL (only necessary if you installed to new hardware or otherwise changed the host/port).</li><li>Drain the messages from the AMQ 6 KahaDB to the new AMQ 7 broker.</li><li>Eventually plan on upgrading your client libraries.</li><li>Optionally delete the old AMQ 6 installation once you’re satisfied that the upgrade has completed successfully.</li></ul><p>Did I cover every possible use case, permutation, and complication? No… But this should be a good starting point. And if you need more guidance, well… that’s what we have <a href="https://www.redhat.com/en/services/consulting" target="_blank" rel="noopener">Red Hat Consulting</a> for.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;So &lt;a href=&quot;https://developers.redhat.com/products/amq/overview/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Red Hat AMQ 7&lt;/a&gt; has been out for a while now, and there have already been a lot of customers who are understandably eager to upgrade to the latest and greatest version. Many of them have been reaching out and asking for help/instructions on how to migrate. So far I’ve been replying that I already blogged about that here: &lt;a href=&quot;/2016/08/22/decommissioning_jboss_a-mq_brokers/&quot; title=&quot;Decommissioning JBoss A-MQ brokers&quot;&gt;Decommissioning JBoss A-MQ brokers&lt;/a&gt;. But that reply has been met with some confusion. So I figured I’d write up a more concrete set of instructions.
    
    </summary>
    
    
      <category term="jboss" scheme="http://blog.joshdreagan.com/tags/jboss/"/>
    
      <category term="activemq" scheme="http://blog.joshdreagan.com/tags/activemq/"/>
    
      <category term="amq" scheme="http://blog.joshdreagan.com/tags/amq/"/>
    
      <category term="artemis" scheme="http://blog.joshdreagan.com/tags/artemis/"/>
    
  </entry>
  
  <entry>
    <title>Bridging Apache Artemis</title>
    <link href="http://blog.joshdreagan.com/2017/08/16/bridging_apache_artemis/"/>
    <id>http://blog.joshdreagan.com/2017/08/16/bridging_apache_artemis/</id>
    <published>2017-08-16T20:18:37.000Z</published>
    <updated>2018-02-20T00:10:41.000Z</updated>
    
    <content type="html"><![CDATA[<p>In a perfect world, every project would be a greenfield project and you could pick and choose the latest/greatest broker every time. And of course, if given the choice you’d pick <a href="https://activemq.apache.org/artemis/" target="_blank" rel="noopener">Apache Artemis</a>… ;) But in the real world, it is much more common that customers will have a very large existing codebase and will have to transition to the latest/greatest over some much longer period of time. And during that period, it’s helpful to be able to set up some sort of bridge between your brokers so that your old and new code can still communicate.<a id="more"></a></p><p>Before we get started though, there are a few things to clear up… The term “bridge” can mean may things. Artemis has something called a “<a href="https://activemq.apache.org/artemis/docs/latest/core-bridges.html" target="_blank" rel="noopener">Core Bridge</a>“. Core bridges do <strong>not</strong> use the JMS API, and are used only for bridging Artemis instances together (either explicitly, or implicitly when using cluster connections). While useful, Core bridges are not the focus of this post. Instead, we’re going to talk about how you might bridge Artemis to another JMS broker (ie, <a href="https://www.ibm.com/software/products/en/ibm-mq" target="_blank" rel="noopener">IBM MQ</a>).</p><p>There is a baked in JMS bridge implementation in the Artemis codebase that you can use if you’d like. You can check out the docs on it here: [<a href="https://activemq.apache.org/artemis/docs/latest/jms-bridge.html" target="_blank" rel="noopener">https://activemq.apache.org/artemis/docs/latest/jms-bridge.html</a>]. It’s pretty basic, but functional if you don’t require any kind of transformations or other flexibility. To use it, simply instantiate an instance of <code>org.apache.activemq.artemis.jms.bridge.JMSBridge</code>, and pass it the required arguments (ie, source/destination <code>org.apache.activemq.artemis.jms.bridge.ConnectionFactoryFactory</code> instances, source/destination <code>org.apache.activemq.artemis.jms.bridge.DestinationFactory</code> instances, source/destination credentials, …). Once you have your instance, you can call <code>start()</code> on it to begin consuming/producing messages. There’s even an example included in the distribution: [<a href="https://github.com/apache/activemq-artemis/tree/master/examples/features/standard/jms-bridge" target="_blank" rel="noopener">jms-bridge</a>]. Seems pretty straightforward right? Well… maybe not. If you’re running Artemis standalone (like most people), you don’t really have a good way to load extra code. That is, there’s no “hot deploy” folder where you can just drop a jar file with this config in it and have it automatically startup and shutdown with the broker. There has been some effort to create a plugin framework in the newer versions, but a quick look at the code showed that it still doesn’t provide hooks into start/stop or other broker lifecycle events. So what do we do?</p><p>As it turns out, there is an embedded <a href="http://www.eclipse.org/jetty/" target="_blank" rel="noopener">Jetty</a> instance that serves the web admin console. And it already starts/stops with the server. So we can just piggyback on that to bootstrap our code. But if I’m going through all of this effort to bootstrap some code, I might as well use something with a bit more power (ie, <a href="http://camel.apache.org/" target="_blank" rel="noopener">Apache Camel</a>). That way, if I have any need to perform message transformations, set unique headers for idempotent consumption, wiretap audit logs, or do anything else outside of simply copying messages, I can do so. Sounds simple enough, but how do I actually do it?</p><p>First, you’ll need to create a WAR containing all of your dependencies as well as your Spring XML defined Camel routes. We’ll refer to this as <code>jms-bridge.war</code>… In the Camel routes, you’ll place your actual JMS bridge definitions (as many as you need). In the <code>WEB-INF/web.xml</code>, you’ll boostrap the Spring ApplicationContext using the <code>org.springframework.web.context.ContextLoaderListener</code> class. This is a pretty standard way to bootstrap a Spring application into a servlet container.</p><p>Second, you’ll copy <code>jms-bridge.war</code> file into the <code>$ARTEMIS_HOME/web</code> folder.</p><p>Finally, you’ll add a definition to the <code>$ARTEMIS_INSTANCE/etc/bootstrap.xml</code> file as shown below:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">broker</span> <span class="attr">xmlns</span>=<span class="string">"http://activemq.org/schema"</span>&gt;</span></div><div class="line">  ...</div><div class="line">  <span class="tag">&lt;<span class="name">web</span> <span class="attr">bind</span>=<span class="string">"http://localhost:8161"</span> <span class="attr">path</span>=<span class="string">"web"</span>&gt;</span></div><div class="line">    ...</div><div class="line">    <span class="tag">&lt;<span class="name">app</span> <span class="attr">url</span>=<span class="string">"jms-bridge"</span> <span class="attr">war</span>=<span class="string">"jms-bridge.war"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">web</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">broker</span>&gt;</span></div></pre></td></tr></table></figure><p><em>Notice the use of <code>$ARTEMIS_HOME</code> and <code>$ARTEMIS_INSTANCE</code> in the second and third steps… <code>$ARTEMIS_HOME</code> refers to the location that you unzipped the Artemis distribution. <code>$ARTEMIS_INSTANCE</code> refers to the directory of your broker instance (created with the “<code>artemis create ...</code>“ command.</em></p><p>Now when you start the broker instance, it will load up and start the Camel routes and begin bridging. Pretty cool! But we bundled up all of our dependencies inside our WAR file (ie, all of the IBM MQ JMS client libs). And we also bundled our Camel routes definition inside the WAR as well. And since the WAR file sits in the <code>$ARTEMIS_HOME/web</code> directory, its configurations apply to any and all of the instances that we create/run on that machine. Not to mention the fact that every change to my Camel routes will require a build/deploy/restart. All of this kind of sucks and we can do better… </p><p>If you dig into the code a bit more, you’ll see that the “main” that spins up the Artemis broker will actually add several directories, JARs, &amp; ZIPs to the classpath. Specifically, it will add the <code>$ARTEMIS_HOME/etc</code> &amp; <code>$ARTEMIS_INSTANCE/etc</code> directories. It will then scan through the <code>$ARTEMIS_HOME/lib</code> &amp; <code>$ARTEMIS_INSTANCE/lib</code> directories, and add any JARs or ZIPs that it finds to the classpath (sorted by name). So that means that we can take all of our use-case specific stuff (ie, all of the IBM MQ JMS client libs) and put them in the <code>$ARTEMIS_INSTANCE/lib</code> folder. It also means that we can take the Camel routes configuration, and put it in the <code>$ARTEMIS_INSTANCE/etc</code> directory. Now we have a completely generic WAR that we deploy in the <code>$ARTEMIS_HOME/lib</code> directory. That WAR can be activated on an instance defined basis as needed. And each instance can have the dependencies and configuration that it requires completely independent of other instances. Additionally, I have the added benefit of being able to edit the Camel routes configuration and apply my changes with only a restart (ie, no re-build/re-deploy required). Neat! Want to see what it looks like? Take a look at this sample project: [<a href="https://github.com/joshdreagan/artemis-jms-bridge" target="_blank" rel="noopener">https://github.com/joshdreagan/artemis-jms-bridge</a>].</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;In a perfect world, every project would be a greenfield project and you could pick and choose the latest/greatest broker every time. And of course, if given the choice you’d pick &lt;a href=&quot;https://activemq.apache.org/artemis/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Apache Artemis&lt;/a&gt;… ;) But in the real world, it is much more common that customers will have a very large existing codebase and will have to transition to the latest/greatest over some much longer period of time. And during that period, it’s helpful to be able to set up some sort of bridge between your brokers so that your old and new code can still communicate.
    
    </summary>
    
    
      <category term="fuse" scheme="http://blog.joshdreagan.com/tags/fuse/"/>
    
      <category term="camel" scheme="http://blog.joshdreagan.com/tags/camel/"/>
    
      <category term="jboss" scheme="http://blog.joshdreagan.com/tags/jboss/"/>
    
      <category term="activemq" scheme="http://blog.joshdreagan.com/tags/activemq/"/>
    
      <category term="amq" scheme="http://blog.joshdreagan.com/tags/amq/"/>
    
      <category term="artemis" scheme="http://blog.joshdreagan.com/tags/artemis/"/>
    
  </entry>
  
  <entry>
    <title>Transactions and Alternatives With Camel</title>
    <link href="http://blog.joshdreagan.com/2017/08/14/transactions_and_alternatives_with_camel/"/>
    <id>http://blog.joshdreagan.com/2017/08/14/transactions_and_alternatives_with_camel/</id>
    <published>2017-08-14T15:54:38.000Z</published>
    <updated>2018-02-20T00:10:41.000Z</updated>
    
    <content type="html"><![CDATA[<p>There are loads of use cases which require “all or nothing” processing. And there are a bunch of different strategies for accomplishing said result. Luckily for me, they’ve already been covered many times in tons of different blogs/books/articles. So for this post I’m just going to concentrate on a few of the strategies, and more specifically, how to do them with <a href="http://camel.apache.org/" target="_blank" rel="noopener">Apache Camel</a>.<a id="more"></a></p><h2 id="Transactions"><a href="#Transactions" class="headerlink" title="Transactions"></a>Transactions</h2><p>The first (and most obvious) solution that I’d like to cover, is transactions. Usually, when people need to do a bunch of tasks in an atomic fashion, they simply use a transaction. This can be either a local transaction, or an XA one. Basically, you get to pawn off all of the complication onto a transaction manager and keep your application code clean. So it’s a great option if you’re using resources that can be transacted (ie, a relational database, or a JMS broker).</p><p>If you’re only using a single resource, you can do a local transaction. Which is a nice balance of simplicity and speed. For instance, consuming from a queue, enriching with some extra data, and then producing to another queue on the same broker. The only thing you have to be cautious of is that you maintain a single thread throughout your processing. This really only gets tricky if you do something like a <a href="http://camel.apache.org/splitter.html" target="_blank" rel="noopener">Splitter EIP</a> and turn on the <code>parallelProcessing</code> option. If you need an example of configuring a local transaction, you can just take a look at the docs [<a href="http://camel.apache.org/transactional-client.html" target="_blank" rel="noopener">http://camel.apache.org/transactional-client.html</a>].</p><p>However, if you are using multiple resources, you will need to use an XA transaction. For instance, consuming from a queue, and inserting into a database. XA transaction managers are usually provided and configured by your container. If you’re using <a href="https://developers.redhat.com/products/fuse/overview/" target="_blank" rel="noopener">Red Hat JBoss Fuse on Karaf</a>, you’ll likely use <a href="http://aries.apache.org/" target="_blank" rel="noopener">Aries</a>. If you’re on <a href="https://developers.redhat.com/products/eap/overview/" target="_blank" rel="noopener">Red Hat JBoss EAP</a>, you’ll use <a href="http://narayana.io/" target="_blank" rel="noopener">Narayana</a> (formerly JBoss TM). <a href="https://projects.spring.io/spring-boot/" target="_blank" rel="noopener">Spring Boot</a> provides no transaction manager out-of-the-box. Instead, it has hooks to auto-configure various TM’s based on which one you’ve added as a dependency. In case you’re curious and would like an example of Camel + XA + Spring Boot, take a look here [<a href="https://github.com/joshdreagan/camel-spring-boot-xa" target="_blank" rel="noopener">https://github.com/joshdreagan/camel-spring-boot-xa</a>].</p><p>Using an XA transaction manager does increase complexity a bit (at least from a configuration perspective), and comes with a handful of requirements and caveats:</p><p>The first requirement, is that you will (obviously) need to run and configure some sort of XA capable transaction manager. There are several options available (as outlined above). And because they all implement JTA, you can swap them out with no changes to your code. So you can shop around and find the one that works best.</p><p>Second, due to the requirement of a 2-phase commit, it will be significantly slower. This is usually a huge sticking point for a lot of people as they don’t want to (or can’t afford to) pay that performance penalty. Unfortunately, there is little that can be done about it. Or more accurately, I have never seen an XA transaction manager implementation that maintains the speed and simplicity of a non-XA one.</p><p>The third, and often overlooked, requirement is that you will need some sort of persistence. This is because, in the case of a crash, the recovery manager will attempt to pick up where things left off. And in order to survive a crash, we need persistence…</p><p>It’s worth noting that this third requirement (persistence) makes HA a bit of a pain. As mentioned above, transaction managers will run some sort of recovery thread in the background so that they can (as the name would suggest) recover transactions that were not yet complete at the time of a crash. But they all (or at least all of the implementations I know of) can only have a single instance of the tx and recovery manager per object store (or more specifically, per tx manager id). So that means that, if I wanted to scale out my application (to make up for the added slowness of XA), each server would likely have its own persistent store. Most people don’t even notice when they’re using a server like <a href="http://wildfly.org/" target="_blank" rel="noopener">JBoss WildFly</a> because each instance will (by default) write its logs to a subfolder of its installation. This can be (in my opinion) <strong>very</strong> dangerous because most people are unaware that that directory should be sitting on some sort of resilient storage. If, however, you’re running on a platform like <a href="https://www.openshift.com/" target="_blank" rel="noopener">OpenShift</a>, you will be immediately aware because all instances will share the same storage mount and configuration, and will simply fail to work properly. You <em>could</em> use subfolders for each pod instance, and then create a separate recovery pod that would run independent of your application and would spin up recovery managers for each downed instance. In fact, I actually had an implementation working at one point. But it was quite clunky, and after a quick conversation with Hiram Chirino at one of our meetups, I concluded that he was working on a <strong>way</strong> more elegant solution using <a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/" target="_blank" rel="noopener">Stateful Sets</a>. So for now, if you want to run XA transactions on OpenShift, I would either limit my app to a single instance (ie, no scaling), or wait a bit for Hiram’s version.</p><h2 id="Idempotent-Consumer"><a href="#Idempotent-Consumer" class="headerlink" title="Idempotent Consumer"></a>Idempotent Consumer</h2><p>So what if I can’t (or don’t want to) use XA transactions? Perhaps I value speed over application simplicity… Perhaps I’m not dealing with “transactable” resources… Perhaps I’m running on OpenShift and can’t wait on Hiram… ;) No matter what the reason, it’d be nice to have some other options. Luckily, as mentioned at the beginning of the post, there are oodles of options. So lets talk about one of the more popular ones… idempotent consumer.</p><p>With the <a href="http://www.enterpriseintegrationpatterns.com/patterns/messaging/IdempotentReceiver.html" target="_blank" rel="noopener">Idempotent Consumer EIP</a>, you give up on trying to do things atomically, and instead favor eventual consistency. In other words, I write my application in such a way that retries will not hurt anything. So if I have a failure, I can just keep retrying until I eventually succeed all the way through.</p><p>To give a concrete example… Let’s say that I wanted to read a file from an input directory, unmarshal/validate the contents, insert it as a record into a DB, and also write it out to a file in an output directory (perhaps in parallel). In this example, only the DB write can participate in a transaction. Both the consumption of and the production of files cannot. So local (or even XA) transactions are not an option. But if I put a simple check before writing the DB and also before writing the file, I can retry as many time as I’d like with no negative side-effects. To be very specific, if I was successful in writing to the DB, but failed on writing the file (maybe because the filesystem was temporarily full), I can just re-ingest the same file. The DB check will ensure that I don’t try that step again. So I’ll basically skip it and then try the file write again. Hopefully this time it succeeds…</p><p>There are a couple of ways that I can go about implementing this with Camel. One way would be to guard each step using the <a href="http://camel.apache.org/idempotent-consumer.html" target="_blank" rel="noopener">Idempotent Consumer EIP</a>. With this EIP, I select a unique id (or rather, an expression to retrieve a unique id) for each message. When that message is received, its unique id will checked against an <code>org.apache.camel.spi.IdempotentRepository</code> (of which there are many implementations to choose from). If it already exists, it will simply be skipped. If not, it will be added and then passed on to the processor. Now, I can ingest/retry my data as many times as I want and be <em>relatively</em> certain that each step will only be performed once. If you want an example of this pattern, take a look here: [<a href="https://github.com/joshdreagan/camel-idempotent-consumer" target="_blank" rel="noopener">https://github.com/joshdreagan/camel-idempotent-consumer</a>].</p><p>This pattern works great for most cases. It’s easy to implement, and maintains pretty good performance. But sometimes it just isn’t flexible or robust enough. More specifically, what do I do if I don’t have a unique message id to key off of? Also, what happens if I have a system failure after adding something to the idempotent repository, but before performing my actual processing? Or what if I have an error during my processing, but suffer a system failure before I can remove the message id from my repository? Basically, I have situations where my idempotent repository could be out-of-sync with my actual processing. If I’m using the JDBC based implementation to guard a DB insert, I could use a local transaction to make sure both of those steps occur atomically. But that doesn’t really help with my file writing use case. The margin for error is pretty small, and might be acceptable. But what if it’s not? Luckily for us, Camel usually has more than one way to solve a problem…</p><p>The Idempotent Consumer EIP is really just a specialized version of the <a href="http://camel.apache.org/message-filter.html" target="_blank" rel="noopener">Message Filter EIP</a>. The biggest difference, is that its expression will return a boolean dictating whether or not it skips or processes the message. So instead of just matching an id, I can perform any steps I’d like to determine if a message has already been processed before. Which solves my first issue… Using my example above, I would guard my DB insert with one filter check, and then my file write with another filter check. The DB filter check could query the DB to see if my message had already been inserted, and then skip processing if it had. My file writer check could similarly check to see if the destination file had already been written, and then skip processing if it had. It’s a tiny bit more complicated to use, but since I’m not maintaining a separate idempotent repository, I don’t have any chance of getting out-of-sync. So that solves my system failure issues… If you want an example of what this might look like, take a look at this example: [<a href="https://github.com/joshdreagan/camel-filter-consumer" target="_blank" rel="noopener">https://github.com/joshdreagan/camel-filter-consumer</a>].</p><p>As I said at the beginning of this post, there are several ways to tackle this issue. Of which, I’ve only covered a few. And in doing so, I used some fairly contrived use cases. But hopefully it’s still worthwhile, and at a bare minimum maybe someone will find the code examples useful…</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;There are loads of use cases which require “all or nothing” processing. And there are a bunch of different strategies for accomplishing said result. Luckily for me, they’ve already been covered many times in tons of different blogs/books/articles. So for this post I’m just going to concentrate on a few of the strategies, and more specifically, how to do them with &lt;a href=&quot;http://camel.apache.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Apache Camel&lt;/a&gt;.
    
    </summary>
    
    
      <category term="fuse" scheme="http://blog.joshdreagan.com/tags/fuse/"/>
    
      <category term="camel" scheme="http://blog.joshdreagan.com/tags/camel/"/>
    
      <category term="jboss" scheme="http://blog.joshdreagan.com/tags/jboss/"/>
    
      <category term="karaf" scheme="http://blog.joshdreagan.com/tags/karaf/"/>
    
      <category term="wildfly" scheme="http://blog.joshdreagan.com/tags/wildfly/"/>
    
      <category term="eap" scheme="http://blog.joshdreagan.com/tags/eap/"/>
    
      <category term="openshift" scheme="http://blog.joshdreagan.com/tags/openshift/"/>
    
      <category term="activemq" scheme="http://blog.joshdreagan.com/tags/activemq/"/>
    
      <category term="amq" scheme="http://blog.joshdreagan.com/tags/amq/"/>
    
      <category term="spring-boot" scheme="http://blog.joshdreagan.com/tags/spring-boot/"/>
    
      <category term="artemis" scheme="http://blog.joshdreagan.com/tags/artemis/"/>
    
      <category term="narayana" scheme="http://blog.joshdreagan.com/tags/narayana/"/>
    
  </entry>
  
  <entry>
    <title>Scaling JBoss A-MQ on OpenShift</title>
    <link href="http://blog.joshdreagan.com/2017/03/25/scaling_jboss_a-mq_on_openshift/"/>
    <id>http://blog.joshdreagan.com/2017/03/25/scaling_jboss_a-mq_on_openshift/</id>
    <published>2017-03-25T22:56:02.000Z</published>
    <updated>2018-02-20T00:10:41.000Z</updated>
    
    <content type="html"><![CDATA[<p>I frequently get asked by customers if it’s possible to run <a href="https://developers.redhat.com/products/amq/overview/" target="_blank" rel="noopener">Red Hat JBoss A-MQ</a> on <a href="https://developers.redhat.com/products/openshift/overview/" target="_blank" rel="noopener">Red Hat OpenShift</a>, and while the answer has been “yes” for quite a while now, it has always been followed by a few caveats. In particular, the issue of scaling…<a id="more"></a></p><p>But before we get into the issue of scaling, let’s talk a little about how the <a href="https://access.redhat.com/documentation/en-us/red_hat_jboss_middleware_for_openshift/3/html-single/red_hat_jboss_a-mq_for_openshift/" target="_blank" rel="noopener">official image template</a> works. Basically, it can operate in three different modes (as of this blog date). </p><p>The first, is persistent with no scaling. This is the equivalent of a single master/slave setup. Only, there is no need for an actual “slave” instance. If the master goes down, OpenShift will detect it and will spin up a new instance on the same or another node. And since the new instance/pod will have the same <a href="https://kubernetes.io/docs/user-guide/persistent-volumes/#persistentvolumeclaims" target="_blank" rel="noopener">PersistentVolumeClaim</a>, the broker will come online and see all of its in-flight messages exactly as they were. If I were to attempt to scale-up the instance in this mode, I would basically just spin up a bunch of passive “slaves” since they’ll all try to mount the same PersistentVolumeClaim/KahaDB, and will be unable to get the file-lock (and will resort to polling it until they can). And as described above, the slaves serve no real purpose because OpenShift is already monitoring and will bring up a new instance if needed. But what if I want to scale? What if I want to have many active instances sharing the load?</p><p>That brings us to the next mode. Which is non-persistent with scaling. In this mode, all of the instances share the same <a href="https://kubernetes.io/docs/user-guide/services/" target="_blank" rel="noopener">Service</a>, but have no <a href="https://kubernetes.io/docs/user-guide/persistent-volumes" target="_blank" rel="noopener">PersistentVolume</a> attached. That means that clients (both producers and consumers) can be distributed across all of the instances. And, since each of the instances is networked together, the messages will find their way to a valid consumer. The instances will be automatically network together in a mesh configuration, and discover eachother using the same Kubernetes Service abstraction that the clients can use. So theoretically, I can scale this up as large as I need to handle my client load. But as I stated above, there is no PersistentVolume attached. Which means that my in-flight messages could potentially be lost if the owning broker goes down. So what if I want it all? What if I need the ability to scale-up, but also need persistence?</p><p>In that case, we would use the third mode. Which is persistent with scaling. In this mode, all of the brokers are networked together (using the same Kubernetes Service discovery mechanism as above), but they all also mount the same PersistentVolumeClaim. So how do they have separate KahaDB’s (and prevent all trying to lock the same one)? It’s actually quite simple… In this mode, they will all mount the same volume, but will use subdirectories inside that mount. So within the mount, you will get a bunch of directories called “split-1”, “split-2”, … and so on. If you want to see exactly how this works, you can open up a remote shell to one of the pods (ie, <code>oc rsh &lt;POD_NAME&gt;</code>) and take a look at the A-MQ start script. It just loops through (starting at 1) each of the directories until it finds one that it can get a file-lock on. Once it does, it starts up a broker instance and uses that sub-directory to store its KahaDB. It’s worth noting here that, since all of the instances will share the same actual PersistentVolume (and it’s underlying filesystem), you will need to use a distributed filesystem (ie, <a href="https://www.gluster.org/" target="_blank" rel="noopener">GlusterFS</a>) with ReadWriteMany access so you don’t hit a storage performance bottleneck. Now I can run A-MQ on OpenShift and scale-up as much as I want (or as much as I have resources for anyway). </p><p>So what’s the “scaling problem” I mentioned earlier? Well… if I want to scale-up, I’ll probably also want to scale-down at some point. And if I scale down, I now have KahaDB’s sitting in “split-x” folders that could potentially have in-flight messages. And those messages likely can’t wait until I scale back up and happen to get an instance that mounts that particular “split” directory. So really, I need to drain those messages out of that stale KahaDB and push them to one of my remaining active brokers. So how might I go about that?</p><p>One solution might be to use a broker plugin that (on shutdown) will automatically drain messages off to other brokers. This could work, but would probably be problematic. First, you would have to make sure that all of your <a href="http://activemq.apache.org/configuring-version-5-transports.html" target="_blank" rel="noopener">ActiveMQ TransportConnectors</a> are shutdown before you start draining the messages. If you fail to do this, you could potentially be accepting new messages from clients and might never finish actually draining. The second (and probably more important problem) is that you don’t have an infinite amount of time to finish your work. When Kubernetes schedules a pod for shutdown, it does give a max time for it to complete its graceful shutdown. But if you exceed this timeout, it will forcefully shut down. So exactly how much time do you need to drain off all of your messages? It depends… It depends on how many in-flight messages you have stored in that KahaDB. It depends on how fast you can send those messages (maybe they’re large messages). It depends on how much space you have available on the other brokers (because of <a href="http://activemq.apache.org/producer-flow-control.html" target="_blank" rel="noopener">Producer Flow Control</a>). The point is, there is no valid number for “shutdown timeout”. You need as much time as it takes. So what do we do?</p><p>Luckily for you, I’m sure you’ve already read my previous blog on <a href="/2016/08/22/decommissioning_jboss_a-mq_brokers/" title="Decommissioning JBoss A-MQ brokers">Decommissioning JBoss A-MQ brokers</a>. And in there, you’ve already seen my final proposed solution (and code example) for draining those messages. So really, all we have to do is make that code work on OpenShift. Here’s a first cut at it [<a href="https://github.com/joshdreagan/activemq-pv-monitor" target="_blank" rel="noopener">https://github.com/joshdreagan/activemq-pv-monitor</a>]. In this example, I use the <a href="https://access.redhat.com/documentation/en-us/red_hat_jboss_middleware_for_openshift/3/html-single/red_hat_jboss_fuse_integration_services_2.0_for_openshift/" target="_blank" rel="noopener">FIS 2.0</a> tools to create a simple <a href="https://developers.redhat.com/products/fuse/overview/" target="_blank" rel="noopener">Red Hat JBoss Fuse</a> app that will monitor the A-MQ “split-x” directories. If it finds a KahaDB that it’s able to get a file-lock on, it will drain its messages to another available broker (which it discovers using the same Kubernetes Service discovery mechanism described above). And since it’s a separate Pod, it can run for as long as it needs to. So no need to worry about pesky timeouts. The example could use some more error handling and various other QA, but it should be a good starting point.</p><p>So now we can scale-up, we can scale-down, and if we’re feeling lazy, we can even auto-scale. Cool beans! As always, hopefully you find this useful. And if so, buy me a beer this year at <a href="https://www.redhat.com/en/summit/2017" target="_blank" rel="noopener">Red Hat Summit</a>. :)</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;I frequently get asked by customers if it’s possible to run &lt;a href=&quot;https://developers.redhat.com/products/amq/overview/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Red Hat JBoss A-MQ&lt;/a&gt; on &lt;a href=&quot;https://developers.redhat.com/products/openshift/overview/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Red Hat OpenShift&lt;/a&gt;, and while the answer has been “yes” for quite a while now, it has always been followed by a few caveats. In particular, the issue of scaling…
    
    </summary>
    
    
      <category term="fuse" scheme="http://blog.joshdreagan.com/tags/fuse/"/>
    
      <category term="camel" scheme="http://blog.joshdreagan.com/tags/camel/"/>
    
      <category term="jboss" scheme="http://blog.joshdreagan.com/tags/jboss/"/>
    
      <category term="openshift" scheme="http://blog.joshdreagan.com/tags/openshift/"/>
    
      <category term="activemq" scheme="http://blog.joshdreagan.com/tags/activemq/"/>
    
      <category term="amq" scheme="http://blog.joshdreagan.com/tags/amq/"/>
    
      <category term="spring-boot" scheme="http://blog.joshdreagan.com/tags/spring-boot/"/>
    
  </entry>
  
  <entry>
    <title>ActiveMQ HA Performance Comparison</title>
    <link href="http://blog.joshdreagan.com/2017/03/15/activemq_ha_performance_comparison/"/>
    <id>http://blog.joshdreagan.com/2017/03/15/activemq_ha_performance_comparison/</id>
    <published>2017-03-15T20:07:01.000Z</published>
    <updated>2018-02-20T00:10:41.000Z</updated>
    
    <content type="html"><![CDATA[<p>A while back, I wrote a blog post on <a href="/2016/07/28/ha_deployments_with_fuse/" title="HA Deployments With Fuse">HA Deployments With Fuse</a>. Surprisingly, it received a lot of interest. In particular, the JMS section. Apparently, there are tons of people trying to solve the cross-dc HA problem… Not surprisingly, everyone claims to have the highest possible failure requirements and asked me what I meant by “prepare to make some serious performance tradeoffs”. So I figured I’d give some concrete numbers for comparison.<a id="more"></a></p><p><em>Before we get started though, here are some very important disclaimers: First, I did absolutely no tweaking of options or performance tuning. I just unzipped the <a href="https://developers.redhat.com/products/amq" target="_blank" rel="noopener">Red Hat JBoss A-MQ</a> distro, uncommented a user, and started it up. For the DRBD tests, I only changed the path where it stores the KahaDB to point to the replicated filesystem mount. Similarly, I just did a standard <a href="http://drbd.org" target="_blank" rel="noopener">DRBD</a> installation by following their getting started docs. I did not tweak or otherwise optimize the synchronization protocols in any way. Second, I used an ‘m4.xlarge’ <a href="https://aws.amazon.com/ec2/instance-types/" target="_blank" rel="noopener">EC2 instance type</a> and attached a standard SSD <a href="https://aws.amazon.com/ebs/details/" target="_blank" rel="noopener">EBS volume type</a>. So more of a mid-level machine with average (or below) networking and storage performance.</em></p><p><strong>Given the above conditions, you should not take these numbers as a performance metric. You could likely get much greater performance if you tweaked some of the network settings and used more performant machine. These numbers are only meant to serve as a comparison of local storage vs replicated storage.</strong></p><p>Now that I’ve got the “disclaimers” out of the way, let me run down what I actually did…</p><p>First, I wanted to run a baseline (since this is not about performance numbers directly, but rather comparison). So I created an ‘m4.xlarge’ instance used to host my broker. We’ll call it “broker 1”. I also created a second ‘m4.xlarge’ instance in the same availability zone and region to host my client (both producer and consumer). We’ll call it “client”. Next, I installed <a href="https://developers.redhat.com/products/amq" target="_blank" rel="noopener">Red Hat JBoss A-MQ 6.3</a> on “broker 1”. I also created a Maven project for my <a href="http://activemq.apache.org/activemq-performance-module-users-manual.html" target="_blank" rel="noopener">ActiveMQ Perf Maven Plugin</a> on “client”. I then ran a client instance with 5 threads for the producer, and another instance with 5 threads for the consumer. <em>Note: Both clients were run from the same “client” EC2 machine.</em> I then repeated the test using 25 threads, and again using 50 threads. I tried to go above 50 threads, but the performance started to degrade. Likely due to a network or storage bottleneck for the machine/storage types I chose. All the numbers for these runs can be found in the table below in the “Baseline” row.</p><p>Once I had my baseline, I spun up another ‘m4.xlarge’ instance in the same region, but on another availability zone. We’ll call this one “broker 2” I also created and attached an EBS volume (using a standard SSD) to both of my “broker” instances (“broker 1” and “broker 2”). I installed DRBD on the instances and configured it to replicate synchronously (using <a href="https://docs.linbit.com/doc/users-guide-84/s-replication-protocols/" target="_blank" rel="noopener">Protocol C</a>) from “broker 1” to “broker 2”. Once I brought them online and the initial sync was done, I ran the same tests as above and captured the numbers. The numbers can be found in the table below in the “DRBD (across availability zones)” row. As you can see from the results, we do get a performance drop (because we have to write the data twice), but it’s not too bad since we’re not having to replicate across a WAN yet.</p><p>Finally, I terminated the “broker 2” instance and recreated it in another region. So now, the “broker 1” and “client” instances were in the “US West (Oregon)” region. And the “broker 2” instance was in the “US East (N. Virginia)” region. I reconnected DRBD to replicate from “broker 1” to “broker 2” and waited for the initial sync to complete (this took a while). Once that was done, I re-ran the same tests and captured the output again. It can be found in the table below in the “DRBD (across regions)” row. </p><p>Now we see the “performance tradeoffs” I was talking about… In my tests, it was between 1-2 orders of magnitude slower than local storage. So I will repeat my statement from my previous blog… “You will not be processing large sets of data while synchronously replicating across a WAN.”</p><hr><p><strong>Performance Results</strong></p><table><thead><tr><th></th><th style="text-align:right">5 Threads</th><th style="text-align:right">25 Threads</th><th style="text-align:right">50 Threads</th></tr></thead><tbody><tr><td>Baseline</td><td style="text-align:right">2229 tps</td><td style="text-align:right">9456 tps</td><td style="text-align:right">12524 tps</td></tr><tr><td>DRBD (across availability zones)</td><td style="text-align:right">1636 tps</td><td style="text-align:right">7068 tps</td><td style="text-align:right">9133 tps</td></tr><tr><td>DRBD (across regions)</td><td style="text-align:right">26 tps</td><td style="text-align:right">129 tps</td><td style="text-align:right">256 tps</td></tr></tbody></table><hr><p>For reference, here are the links to the actual <a href="http://activemq.apache.org/activemq-performance-module-users-manual.html" target="_blank" rel="noopener">ActiveMQ Perf Maven Plugin</a> run outputs:</p><p><strong>5 Threads</strong></p><ul><li><a href="/2017/03/15/activemq_ha_performance_comparison/5/baseline/producer.txt" title="Baseline Producer">Baseline Producer</a></li><li><a href="/2017/03/15/activemq_ha_performance_comparison/5/baseline/consumer.txt" title="Baseline Consumer">Baseline Consumer</a></li><li><a href="/2017/03/15/activemq_ha_performance_comparison/5/drbd/producer-drbd.txt" title="DRBD Producer (across availability zones)">DRBD Producer (across availability zones)</a></li><li><a href="/2017/03/15/activemq_ha_performance_comparison/5/drbd/consumer-drbd.txt" title="DRBD Consumer (across availability zones)">DRBD Consumer (across availability zones)</a></li><li><a href="/2017/03/15/activemq_ha_performance_comparison/5/drbd/producer-drbd-x-region.txt" title="DRBD Producer (across regions)">DRBD Producer (across regions)</a></li><li><a href="/2017/03/15/activemq_ha_performance_comparison/5/drbd/consumer-drbd-x-region.txt" title="DRBD Consumer (across regions)">DRBD Consumer (across regions)</a></li></ul><p><strong>25 Threads</strong></p><ul><li><a href="/2017/03/15/activemq_ha_performance_comparison/25/baseline/producer.txt" title="Baseline Producer">Baseline Producer</a></li><li><a href="/2017/03/15/activemq_ha_performance_comparison/25/baseline/consumer.txt" title="Baseline Consumer">Baseline Consumer</a></li><li><a href="/2017/03/15/activemq_ha_performance_comparison/25/drbd/producer-drbd.txt" title="DRBD Producer (across availability zones)">DRBD Producer (across availability zones)</a></li><li><a href="/2017/03/15/activemq_ha_performance_comparison/25/drbd/consumer-drbd.txt" title="DRBD Consumer (across availability zones)">DRBD Consumer (across availability zones)</a></li><li><a href="/2017/03/15/activemq_ha_performance_comparison/25/drbd/producer-drbd-x-region.txt" title="DRBD Producer (across regions)">DRBD Producer (across regions)</a></li><li><a href="/2017/03/15/activemq_ha_performance_comparison/25/drbd/consumer-drbd-x-region.txt" title="DRBD Consumer (across regions)">DRBD Consumer (across regions)</a></li></ul><p><strong>50 Threads</strong></p><ul><li><a href="/2017/03/15/activemq_ha_performance_comparison/50/baseline/producer.txt" title="Baseline Producer">Baseline Producer</a></li><li><a href="/2017/03/15/activemq_ha_performance_comparison/50/baseline/consumer.txt" title="Baseline Consumer">Baseline Consumer</a></li><li><a href="/2017/03/15/activemq_ha_performance_comparison/50/drbd/producer-drbd.txt" title="DRBD Producer (across availability zones)">DRBD Producer (across availability zones)</a></li><li><a href="/2017/03/15/activemq_ha_performance_comparison/50/drbd/consumer-drbd.txt" title="DRBD Consumer (across availability zones)">DRBD Consumer (across availability zones)</a></li><li><a href="/2017/03/15/activemq_ha_performance_comparison/50/drbd/producer-drbd-x-region.txt" title="DRBD Producer (across regions)">DRBD Producer (across regions)</a></li><li><a href="/2017/03/15/activemq_ha_performance_comparison/50/drbd/consumer-drbd-x-region.txt" title="DRBD Consumer (across regions)">DRBD Consumer (across regions)</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;A while back, I wrote a blog post on &lt;a href=&quot;/2016/07/28/ha_deployments_with_fuse/&quot; title=&quot;HA Deployments With Fuse&quot;&gt;HA Deployments With Fuse&lt;/a&gt;. Surprisingly, it received a lot of interest. In particular, the JMS section. Apparently, there are tons of people trying to solve the cross-dc HA problem… Not surprisingly, everyone claims to have the highest possible failure requirements and asked me what I meant by “prepare to make some serious performance tradeoffs”. So I figured I’d give some concrete numbers for comparison.
    
    </summary>
    
    
      <category term="jboss" scheme="http://blog.joshdreagan.com/tags/jboss/"/>
    
      <category term="activemq" scheme="http://blog.joshdreagan.com/tags/activemq/"/>
    
      <category term="amq" scheme="http://blog.joshdreagan.com/tags/amq/"/>
    
  </entry>
  
  <entry>
    <title>Faster File Consumption With Camel</title>
    <link href="http://blog.joshdreagan.com/2017/01/05/faster_file_consumption_with_camel/"/>
    <id>http://blog.joshdreagan.com/2017/01/05/faster_file_consumption_with_camel/</id>
    <published>2017-01-05T20:38:21.000Z</published>
    <updated>2017-08-09T16:46:18.000Z</updated>
    
    <content type="html"><![CDATA[<p>One of the most frequently requested use cases that I encounter out in the field is to ingest file-based data (batch or otherwise), and then validate, transform, process, store… it. Luckily, <a href="http://camel.apache.org/" target="_blank" rel="noopener">Apache Camel’s</a> <a href="http://camel.apache.org/file2.html" target="_blank" rel="noopener">File</a> and <a href="http://camel.apache.org/ftp.html" target="_blank" rel="noopener">FTP</a> components make this extremely easy. So much so, that it requires very little thought to get up and running. And if you’re consuming small numbers of larger batch files, perhaps the defaults are good enough and you don’t need to put much though into it. If, however, you’re consuming large numbers of smaller files and you want to get the highest possible performance, there are a few configurations that you might want to consider.<a id="more"></a></p><p>When writing a file poller, one of the most commonly overlooked requirements is that you need some sort of mechanism to determine when the writer is done writing. If you grab a file before it’s complete, you’ll end up truncating it and ending up with garbage data. Unfortunately, how you would make that determination on one filesystem does not necessarily work on all filesystems. In addition, the different strategies will have different performance characteristics and usually end up being your biggest bottleneck (outside of the actual processing of the data). Luckily, Camel provides you with several strategies out-of-the-box and even allows you to create your own if none of them meet your needs. So how to choose…</p><p>First, let’s cover the absolute fastest, most generic solution. If you control the process writing the file as well as the process reading the file, you can use a “temp file” strategy. That is, I can have my writer write a file with some sort of temporary name (ie, appending an “.inprogress” extension), and then atomically move it to its final name when the write is complete (ie, remove the “.inprogress” extension). I can then easily have my consumer filter out the temporary files and only consume files that are complete. Camel can do all of this work for you. So no need to panic over writing a bunch of extra code. Simply set the appropriate options on the producer (ie, <code>tempFileName</code>) and the consumer (ie, <code>exclude</code> or <code>antExclude</code>) and call it a day. :)</p><p>Another similar solution is to use the “done file” strategy. In this strategy, you will write the file, and when it is complete you will write out an additional file with the same name and some “marker” extension (ie, “.done”). You will then instruct your consumer to only pick up files if it finds their corresponding “done” file. Again, Camel makes this a simple matter of configuration. Just set the <code>doneFileName</code> option on the producer and the <code>doneFileName</code> option on the consumer. To me, this seems a bit more clunky than the previous solution, but the end result is the same.</p><p>Both of the previous strategies are extremely fast and will work on pretty much any filesystem. However, as previously stated, they require you to have control over the producer and consumer sides. So what if you only control the consumer? Well… you could use one of the <code>readLock</code> options. Unfortunately, most of the available <code>readLock</code> options are more concerned with making sure no other consumers pick up the same file than they are with making sure the writer is done writing. And since we have <a href="https://github.com/joshdreagan/clustered-file-consumer" target="_blank" rel="noopener">other ways to make sure other consumers don’t step on our toes</a>, we’ll just concentrate on the options that help us with the latter issue.</p><p>The most robust option that’s available out-of-the-box is the “changed” strategy. Basically, the way it works is that the consumer will grab a file and check its last-modified timestamp. It will then continue to check the last-modified timestamp (at the configured <code>readLockCheckInterval</code>) until it determines that the file has stopped changing (ie, the previous poll’s last-modified matches the current one). Once it has determined that the file is no longer changing, it will consume it and pass it to the rest of the route for processing. This strategy is an excellent option because it works pretty much anywhere (ie, local filesystem, FTP, SFTP, …), and is configurable enough to handle the case of “slow writers” (by tweaking/increasing the <code>readLockCheckInterval</code> option). And if you’re getting small numbers of larger files, it’s probably fast enough. But if you’re trying to consume large numbers of smaller files, you will quickly see the bottleneck… The current implementation will loop through each file and (for each file) check the timestamp. It will continue to loop and check the timestamp on that one file until it either detects that it has stopped changing, or it hits its timeout (configured via the <code>readLockTimeout</code> option). It will not move on to the next file until one of those conditions is satisified. Which means that, if I have lots of producers writing files, those files could all be stuck waiting to be consumed because of a single slow producer. In practice, I’ve actually seen this happen and it’s leads to a very bad situation where the polling itself starts to take too long (<em>at the filesystem level and outside of the control of Camel</em>) because of the sheer number of files in a directory. Once this starts to happen, it really just starts a snowball effect. So it’s difficult to recover from and usually requires manual intervention. So what do we do?</p><p>Well… Luckily, Camel is awesome enough that it allows us to extend it whenever it’s out-of-the-box options don’t meet our needs. Suck on <strong>that</strong> competition! :) Specifically, in the previous scenario, we actually solved the problem by creating our own custom version of the “changed” strategy. Only, in our version, we didn’t pause and repeat checks on a single file. Instead, we looped through the files and (for each file) checked its stats. We then added those stats to a cache and moved on to the next file. On each subsequent poll, we would check the file’s stats against the cached ones to determine if it had stopped changing (for at least the <code>readLockCheckInterval</code> amount of time). This allowed us to continue processing any files that were ready without having to wait behind a single one that wasn’t. In practice, we were able to use this strategy to consume very large numbers of files with only a single server. Take a look at the sample source code if you’d like to give it a try: <a href="https://github.com/joshdreagan/camel-fastfile" target="_blank" rel="noopener">https://github.com/joshdreagan/camel-fastfile</a>.</p><p><em>Worth noting that this is a recreation of the original work (as best as I could remember) that I did with my awesome colleague <a href="https://www.linkedin.com/in/scottvancamp" target="_blank" rel="noopener">Scott Van Camp</a> whose awesome coding skills are only rivaled by his awesome beard growing skills. So he gets to share in the credit/blame… :)</em></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;One of the most frequently requested use cases that I encounter out in the field is to ingest file-based data (batch or otherwise), and then validate, transform, process, store… it. Luckily, &lt;a href=&quot;http://camel.apache.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Apache Camel’s&lt;/a&gt; &lt;a href=&quot;http://camel.apache.org/file2.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;File&lt;/a&gt; and &lt;a href=&quot;http://camel.apache.org/ftp.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;FTP&lt;/a&gt; components make this extremely easy. So much so, that it requires very little thought to get up and running. And if you’re consuming small numbers of larger batch files, perhaps the defaults are good enough and you don’t need to put much though into it. If, however, you’re consuming large numbers of smaller files and you want to get the highest possible performance, there are a few configurations that you might want to consider.
    
    </summary>
    
    
      <category term="fuse" scheme="http://blog.joshdreagan.com/tags/fuse/"/>
    
      <category term="camel" scheme="http://blog.joshdreagan.com/tags/camel/"/>
    
      <category term="jboss" scheme="http://blog.joshdreagan.com/tags/jboss/"/>
    
  </entry>
  
  <entry>
    <title>Calling Native Code With Camel</title>
    <link href="http://blog.joshdreagan.com/2016/11/21/calling_native_code_with_camel/"/>
    <id>http://blog.joshdreagan.com/2016/11/21/calling_native_code_with_camel/</id>
    <published>2016-11-22T02:06:03.000Z</published>
    <updated>2017-08-09T16:46:18.000Z</updated>
    
    <content type="html"><![CDATA[<p>Usually when a customer has some legacy/native code that they need to invoke from <a href="http://camel.apache.org/" target="_blank" rel="noopener">Camel</a> (or any Java program really), I recommend that they expose it via SOAP, REST, or some other standardized remote invocation mechanism. Then they can just call it with the appropriate <a href="http://camel.apache.org/cxf.html" target="_blank" rel="noopener">Camel Component</a>. While I still think that this is best option, I recently had a customer ask if Camel had the ability to call native code directly. So I figured what the heck… might as well blog about it…<a id="more"></a></p><p>Native code can be written in many languages (obviously…). And unfortunately, the mechanisms that you would use to invoke the compiled binaries (<code>.dll</code>‘s or <code>.so</code>‘s) are not always the same. In this blog post, I’m going to cover what I think are the most common (or at least the most commonly requested) native languages and how to invoke them.</p><h2 id="C"><a href="#C" class="headerlink" title="C"></a>C</h2><p>Of the languages that I’ll cover in this post, calling C libaries is definitely the easiest. Once I have my compiled library (<code>.dll</code> or <code>.so</code>), I can just call it using <a href="http://docs.oracle.com/javase/8/docs/technotes/guides/jni/" target="_blank" rel="noopener">JNI</a> or <a href="https://github.com/java-native-access/jna" target="_blank" rel="noopener">JNA</a>. </p><p>Of the two, I prefer JNA since it doesn’t require me to generate any code using <code>javah</code> or really have much knowledge of the C code itself. All I need to do is create a Java interface that extends <code>com.sun.jna.Library</code> and that matches the signature of the C library (or more specifically its methods). Then I can create a proxy instance automatically using the <code>com.sun.jna.Native#loadLibrary(java.lang.String, java.lang.Class)</code> method (passing the name of your library and the interface class). </p><p><em>Note: You don’t give the full path or name of the library. The name is automatically wrapped with the platform-specific parts and the path is looked up via a <a href="https://github.com/java-native-access/jna/blob/master/www/GettingStarted.md" target="_blank" rel="noopener">variety of mechanisms</a> (ie, the <code>jna.library.path</code> system property).</em> </p><p>Once I have a proxy object, I can invoke methods on it like I would with any Java Bean in Camel using the <a href="https://camel.apache.org/bean.html" target="_blank" rel="noopener">Bean Component</a>. </p><p>Fairly straighforward right? Take a look at this project (specifically the “camel-native-c” module) if you’d like to see it all working: <a href="https://github.com/joshdreagan/camel-native" target="_blank" rel="noopener">https://github.com/joshdreagan/camel-native</a>.</p><h2 id="C-1"><a href="#C-1" class="headerlink" title="C++"></a>C++</h2><p>Invoking C++ code is slightly more involved than C code, but is still pretty simple. The options (ie, JNI or JNA) are the same, and for the most part the code is the same. </p><p>If you choose to use JNA (which I did), you still need to define an interface that matches the method signatures of the C++ library (and implements <code>com.sun.jna.Library</code>). And you still need to load the library and create the proxy object using the <code>com.sun.jna.Native</code> class. The differences/complications come from this thing called <a href="https://en.wikipedia.org/wiki/Name_mangling" target="_blank" rel="noopener">Name Mangling</a>.</p><p>Name mangling is something that C++ compilers do to account for namespaces and overloaded methods and such. Most compilers do specify exactly how they perform the mangling, but unfortunately none of them do it the same. That is, the Windows C++ compiler will mangle the names differently than the GNU C++ compiler. At any rate, the end result is that my C++ method will not have the same name in its compiled form as it did in its source form. For example, if I had a method called <code>add</code> in my source, the GNU compiler might turn it into something like <code>_ZN10Calculator3addEii</code> (depending on the namespace and method signature of course) <em>(see note below)</em>. That means that when I try to invoke the method on my <code>com.sun.jna.Library</code> interface, I won’t have the right name (and will get an exception). </p><p>So how do I get around all this name mangling tomfoolery? Well, luckily, JNA allows us to provide a custom <code>com.sun.jna.FunctionMapper</code>. That means I can tell JNA that, when I call a function named <code>add</code>, it really needs to call a funtion named <code>_ZN10Calculator3addEii</code> in the underlying native library. Neat! </p><p>One more oddity to handle… For whatever reason, the name mangling also adds an extra argument to the method signature. But once again, JNA has a mechanism to fix it. We can create a custom <code>com.sun.jna.InvocationMapper</code> to intercept the invocation and add a <code>null</code> argument to the beginning of the arg list. </p><p>That’s it! Now I can invoke it using the <a href="https://camel.apache.org/bean.html" target="_blank" rel="noopener">Bean Component</a> just like I did in the C example. </p><p>Like I said… slightly more involved, but still pretty simple. To see it all in action, take a look at this project (specifically the “camel-native-cpp” module): <a href="https://github.com/joshdreagan/camel-native" target="_blank" rel="noopener">https://github.com/joshdreagan/camel-native</a>.</p><p><em>Note: You can use the <code>nm</code> tool on Linux to find the mangled names (ie, <code>nm -D libc-calculator.so</code>).</em></p><h2 id="C-35"><a href="#C-35" class="headerlink" title="C&#35;"></a>C&#35;</h2><p>C# (or any .NET code) is probably the most complicated case. On Windows, .NET DLLs are not the same format as a truely native DLL. This is because they aren’t really native code. They’re what Microsoft calls <a href="https://en.wikipedia.org/wiki/Managed_code" target="_blank" rel="noopener">Managed Code</a>. Managed code is code that must be run in a virtual machine. Think Java and its JVM, but more Microsofty… So it can’t be invoked directly (or at least not without loading a virtual machine). That means that using JNI or JNA directly are out. So what do I do? Well, there are a few options. </p><p>If my .NET DLL exposed a <a href="https://en.wikipedia.org/wiki/Component_Object_Model" target="_blank" rel="noopener">COM</a> interface, I could write a C++ wrapper that calls the .NET DLL through COM. Then I could follow the above instructions for invoking C++ code. But what if my library didn’t expose a COM interface? In my experience, most don’t. And even if it did, that seems like a lot of effort, and I’m quite lazy… </p><p>I could perhaps use a paid tool like <a href="https://www.javonet.com/" target="_blank" rel="noopener">javOnet</a> or <a href="http://jnbridge.com/" target="_blank" rel="noopener">JNBridge</a>. Both seem simple enough to use and are probaly pretty stable. But they both cost a lot of money, and I’m quite cheap… </p><p>So what’s left? I went with a project called <a href="http://jni4net.com/" target="_blank" rel="noopener">jni4net</a>. It does all the work for me (no writing wrapper code), and the price is right (free!). Plus, it’s the only one of the options I found that was open source (and I like open source! :)). Now for the bad news… It’s not the most full-featured or simplest tool in the world. That’s ok though. My cheapness typically wins out over my laziness. So here goes…</p><p>First we need to generate and build the wrapper code. Sadly, the tool has a few steps to its build (making scripting a little complex), but it’s not too bad. You have to run the <code>proxygen.exe</code> command line tool (located in the <code>bin</code> directory of the distribution) and point it at your .NET DLL to generate the Java and C# wrapper code. This process also generates a <code>build.cmd</code> file that must then be used to actually build the code into a DLL library and its respective JAR file. This obviously doesn’t really mesh well with the way most Java builds are written. But with a bit of cleverness/ugliness, we can make it work.</p><p>Now that we have some generated/compiled wrapper code, we need to initialize what jni4net calls the “bridge” and register the assemblies. <strong>This must be done at startup before any of the generated code/methods are used.</strong> A simple “initializer” class that calls the <code>net.sf.jni4net.Bridge#init()</code> and <code>net.sf.jni4net.Bridge#LoadAndRegisterAssemblyFrom(java.io.File)</code> methods will do the trick. </p><p>Once this is done, we can invoke the generated wrapper class methods using the <a href="https://camel.apache.org/bean.html" target="_blank" rel="noopener">Bean Component</a> just like in the previous examples.</p><p>All done right? Not quite… If you tried to this yourself, you probably noticed that there are all kinds of exceptions that occur when you actually try to run your project. This stems from a bit of quirkiness with the way that jni4net finds and loads the DLLs and JARs. As it turns out, the tool is quite opinionated about where its libraries live (making running in production potentially tricky). What do I mean? In order to run, the location of the jni4net JAR files (both generated and the ones that come with the distribution) must live in the same directory as your DLL files (both generated and the .NET one you’re trying to make use of). A quick look at <a href="https://github.com/jni4net/jni4net/blob/master/jni4net.j/src/main/java/net/sf/jni4net/CLRLoader.java" target="_blank" rel="noopener">the code</a> showed that this is because it uses a combination of path and naming conventions to figure out the locations of the supporting libs. Unfortunately, this is currently hard-coded. :( Fortunately, this is an open source project! So anyone with a bit of free time could fix this and submit a pull request. :)</p><p>All in all it’s a bit cumbersome, but works. And that’s what really matters right? For an actual running example, take a look at this project (specifically the “camel-native-csharp” module): <a href="https://github.com/joshdreagan/camel-native" target="_blank" rel="noopener">https://github.com/joshdreagan/camel-native</a>.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Usually when a customer has some legacy/native code that they need to invoke from &lt;a href=&quot;http://camel.apache.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Camel&lt;/a&gt; (or any Java program really), I recommend that they expose it via SOAP, REST, or some other standardized remote invocation mechanism. Then they can just call it with the appropriate &lt;a href=&quot;http://camel.apache.org/cxf.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Camel Component&lt;/a&gt;. While I still think that this is best option, I recently had a customer ask if Camel had the ability to call native code directly. So I figured what the heck… might as well blog about it…
    
    </summary>
    
    
      <category term="fuse" scheme="http://blog.joshdreagan.com/tags/fuse/"/>
    
      <category term="camel" scheme="http://blog.joshdreagan.com/tags/camel/"/>
    
      <category term="jboss" scheme="http://blog.joshdreagan.com/tags/jboss/"/>
    
  </entry>
  
  <entry>
    <title>Smart LoadBalancing With Camel</title>
    <link href="http://blog.joshdreagan.com/2016/10/10/smart_loadbalancing_with_camel/"/>
    <id>http://blog.joshdreagan.com/2016/10/10/smart_loadbalancing_with_camel/</id>
    <published>2016-10-10T21:29:41.000Z</published>
    <updated>2018-02-20T00:10:41.000Z</updated>
    
    <content type="html"><![CDATA[<p>LoadBalancing is a fairly well-known concept these days. There are a ton of existing strategies out there (ie, RoundRobin, Random, Sticky, Weighted, …), and there a ton of existing implementations that have been built using both hardware and software (ie, Apache HTTPD, HAProxy, f5, Layer7, …). So why create another one? Well… although it’s not likely to be very useful, I thought it might be neat to see if I could make one that utilized CPU load (or any metric) to do more intelligent routing.<a id="more"></a></p><p>Luckily, like many things in <a href="http://camel.apache.org/" target="_blank" rel="noopener">Camel</a>, this is a fairly simple task. I just have to create my own <code>org.apache.camel.processor.loadbalancer.LoadBalancer</code> implementation, and I can make it do pretty much anything I want. For instance, <a href="http://joshdreagan.github.io/2015/12/04/custom_camel_loadbalancer_with_infinispan/" target="_blank" rel="noopener">I might implement one to do dynamic discovery using Infinispan</a> (shameless self-promotion :)). But I digress…</p><p>So let’s break down the wish list: I want to be able to use the strategy for more than just HTTP. I’d like to be able to use any available metric. And I need the collection of said metric to occur asynchronously in the background (so I don’t slow down my routing).</p><img src="/2016/10/10/smart_loadbalancing_with_camel/smart-lb.png" title="Smart LoadBalancer"><p>Take a look at the source code <a href="https://github.com/joshdreagan/camel-smart-loadbalancer" target="_blank" rel="noopener">https://github.com/joshdreagan/camel-smart-loadbalancer</a> to see how I did it. In my example, I load balanced HTTP calls and used JMX to collect CPU utilization. But you could just as easily use the exact same implementation to monitor <a href="http://activemq.apache.org/" target="_blank" rel="noopener">ActiveMQ</a> queue depth (or queue % full) and load balance between brokers. Or maybe monitor filesystem space and load balance FTP endpoints.</p><p>Like I said in the intro, this is probably not terribly useful in a real-world environment since the metrics will likely change at a faster rate than you would reasonably poll. But at the very least, hopefully someone will find it interesting. And maybe… just maybe… it will get Christian Posta to read my blog. :)</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;LoadBalancing is a fairly well-known concept these days. There are a ton of existing strategies out there (ie, RoundRobin, Random, Sticky, Weighted, …), and there a ton of existing implementations that have been built using both hardware and software (ie, Apache HTTPD, HAProxy, f5, Layer7, …). So why create another one? Well… although it’s not likely to be very useful, I thought it might be neat to see if I could make one that utilized CPU load (or any metric) to do more intelligent routing.
    
    </summary>
    
    
      <category term="fuse" scheme="http://blog.joshdreagan.com/tags/fuse/"/>
    
      <category term="camel" scheme="http://blog.joshdreagan.com/tags/camel/"/>
    
      <category term="jboss" scheme="http://blog.joshdreagan.com/tags/jboss/"/>
    
      <category term="activemq" scheme="http://blog.joshdreagan.com/tags/activemq/"/>
    
      <category term="amq" scheme="http://blog.joshdreagan.com/tags/amq/"/>
    
  </entry>
  
  <entry>
    <title>Decommissioning JBoss A-MQ Brokers</title>
    <link href="http://blog.joshdreagan.com/2016/08/22/decommissioning_jboss_a-mq_brokers/"/>
    <id>http://blog.joshdreagan.com/2016/08/22/decommissioning_jboss_a-mq_brokers/</id>
    <published>2016-08-22T19:04:26.000Z</published>
    <updated>2018-02-20T00:10:41.000Z</updated>
    
    <content type="html"><![CDATA[<p>There are many reasons why someone might need to decommision a <a href="https://www.redhat.com/en/technologies/jboss-middleware/amq" target="_blank" rel="noopener">JBoss A-MQ</a> broker. Perhaps you are taking a server down for maintenance. Maybe you’re trying to do an upgrade. Or maybe you’ve scaled up during a peak period and now need to scale back down. In any case, you likely don’t want the messages that are persisted in that store to be stuck until you bring things back online. And in the case that you don’t plan to bring things back online, you certainly don’t want them to be lost. So what do you do?<br><a id="more"></a></p><p>One strategy that I see a lot of people employ is to stop all the producers, and then wait until all the messages get processed by the consumers. This works fine for a lot of customers. And if you’re currently doing it this way (and it’s working), don’t worry. You’re certainly not doing anything wrong. However, this requires a lot of coordination and planning. </p><p>It requires coordination and planning because A-MQ (at the broker level) doesn’t really have the ability to stop the production of messages without also stopping the consumption of messages. This is due to the fact that the default configuration (which is what most people will use) only opens one transport connector (listener) that will service both producers and consumers. You can disconnect individual clients, but if they decide to reconnect there’s nothing that’s going to stop them. Most people control this on the application side. They just shut down all of their producer applications (or at least the initial ingress ones) and wait for the consumers to fully process the existing messages. Like I said, there’s nothing wrong with this approach if it’s working for you. But I’ve effectively shut my entire system down even if I’m only decommissioning a single broker. What if I can’t have that much downtime? </p><p>Maybe I could get creative with my clustering and partition my load (ie, multiple network of brokers that are separated from eachother). Then I’d only affect a single partition of my cluster at a time. My producer clients could failover and reconnect to another partition during this downtime so it would seem as if I’m still operational. Then I could swap them back if desired when I’m done. Definitely a step in the right direction, but I’m still taking down a whole partition of brokers just to decommision one.</p><p>Another option would be to open two separate transport connectors (listeners) and have producers connect to one and consumers to the other. I’ve complicated my client code a bit, but maybe that’s ok. It’s not <em>too</em> bad after all… And now I have the ability to shut down the producer transport connector separately from the consumer transport connector at a single broker level, thus ensuring that no more messages will be produced to my broker while still allowing them to be consumed. But what if I have a <a href="http://activemq.apache.org/networks-of-brokers.html" target="_blank" rel="noopener">network of brokers</a> setup? I’ll need to also disable my network connector so that messages don’t get forwarded to me. Ok… we’re getting better… One outstanding problem is that I now have to rely on the locally connected consumers to successfully process all of my messages. How long will I need to wait? How many consumers are even connected to my broker?</p><p>This brings us to the final solution (and best in my opinion). I can take advantage of the fact that ActiveMQ is really just a very flexible set of libraries and I can create a “message drainer” application to purge my persistent store. What do I mean? Well, first I would create a simple Java app that will spin up an embedded broker. I can point that embedded broker at a KahaDB persistent store. Then I can start consuming messages from it (like I would from any broker) and send them off to another broker. And since my embedded broker is local (ie., inside my JVM), I can just connect to it using the <a href="http://activemq.apache.org/vm-transport-reference.html" target="_blank" rel="noopener">VM transport</a>. So I don’t even have to worry about remote clients. They can’t even see my broker. They will simply <a href="http://activemq.apache.org/failover-transport-reference.html" target="_blank" rel="noopener">failover</a> to another active broker as soon as I take mine down and have no knowledge that I’m even connected and draining the messages.</p><p>Neat! Now I don’t have to worry about coordinating my applications, separating my transport connectors, bringing down brokers unnecessarily, … I can simply bring down the broker that I wish to decommission. Then just run my “message drainer” application, point it to the KahaDB of my downed broker, and give it the url of an active broker that I’d like to send my messages off to. Once I’ve finished draining the messages, I can get rid of my broker and it’s persistent store. Or if I was just doing maintenance, I can bring the broker back online and it will see its store with no messages. So no need to worry about dupicates. This solution is simple, requires no unnecessary downtime, and can be used in any situation from performing maintenance to down-scaling. Here’s some sample source code to get you started: <a href="https://github.com/joshdreagan/activemq-drainer" target="_blank" rel="noopener">https://github.com/joshdreagan/activemq-drainer</a>. Enjoy!</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;There are many reasons why someone might need to decommision a &lt;a href=&quot;https://www.redhat.com/en/technologies/jboss-middleware/amq&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;JBoss A-MQ&lt;/a&gt; broker. Perhaps you are taking a server down for maintenance. Maybe you’re trying to do an upgrade. Or maybe you’ve scaled up during a peak period and now need to scale back down. In any case, you likely don’t want the messages that are persisted in that store to be stuck until you bring things back online. And in the case that you don’t plan to bring things back online, you certainly don’t want them to be lost. So what do you do?&lt;br&gt;
    
    </summary>
    
    
      <category term="jboss" scheme="http://blog.joshdreagan.com/tags/jboss/"/>
    
      <category term="activemq" scheme="http://blog.joshdreagan.com/tags/activemq/"/>
    
      <category term="amq" scheme="http://blog.joshdreagan.com/tags/amq/"/>
    
  </entry>
  
  <entry>
    <title>HA Deployments With Fuse</title>
    <link href="http://blog.joshdreagan.com/2016/07/28/ha_deployments_with_fuse/"/>
    <id>http://blog.joshdreagan.com/2016/07/28/ha_deployments_with_fuse/</id>
    <published>2016-07-29T03:34:04.000Z</published>
    <updated>2018-02-20T00:10:41.000Z</updated>
    
    <content type="html"><![CDATA[<p>When out and about, I often get the question: “How do I setup HA (high availability) with <a href="http://developers.redhat.com/products/fuse/overview/" target="_blank" rel="noopener">Red Hat’s JBoss Fuse</a>?”. People ask this question and they expect a simple, straightforward answer. And why shouldn’t they? The question is simple enough right? I could ask the same question about something like <a href="http://tomcat.apache.org/" target="_blank" rel="noopener">Tomcat</a> and get a well documented answer involving little more than a loadbalancer. Unfortunately, the answer for Fuse is a bit more involved and usually starts with the annoying response of “it depends”.<br><a id="more"></a></p><p>So let’s expand on that a bit… Considering my previous example of Tomcat (which is just a Servlet container), what protocol does it speak? Easy! It only talks 1 protocol… HTTP. But what protocol does Fuse speak? Well… since it’s an integration framework, the answer is several. It may be consuming from a REST service and placing the contents in files. Or maybe it’s accepting HL7 messages over TCP and dumping them onto JMS queues. And the way that you’d make a REST service HA is very different from the way that you’d make a file consumer HA (which is very different from the way you’d make a JMS broker HA, …). So you can see that while the answer of “it depends” might be a bit annoying, it is actually the most accurate answer I could give.</p><p>As of this writing, the <a href="http://camel.apache.org/components.html" target="_blank" rel="noopener">Camel Components</a> page lists 240 different components. And there’s no way I’m going to cover all of those in a blog post. So lets just focus on the one’s I run into most often.</p><h2 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h2><p>Many of the available Camel components speak HTTP. Among those would be <a href="http://camel.apache.org/cxfrs.html" target="_blank" rel="noopener">CXFRS</a> for REST services, <a href="http://camel.apache.org/cxf.html" target="_blank" rel="noopener">CXF</a> for SOAP services, and <a href="http://camel.apache.org/jetty.html" target="_blank" rel="noopener">Jetty</a> or <a href="http://camel.apache.org/servlet.html" target="_blank" rel="noopener">Servlet</a> for low level HTTP services. And because HTTP is so prolific, it is probably the most easily understood HA scenario we’ll cover. </p><p>With HTTP, there are two modes that we need to talk about (stateless, &amp; stateful). </p><p>Of the two, stateless is the most common and definitely the most recommended approach. It scales well, requires no coordination in a cluster, and is extremely easy to set up. You simply run however many instances you’d like of your service. The instances don’t have to know about eachother, and can be co-located or can be spread across datacenters. Once you have your services stood up, you simply place a loadbalancer (ie, <a href="https://httpd.apache.org/" target="_blank" rel="noopener">Apache HTTPd</a>, <a href="https://www.nginx.com/" target="_blank" rel="noopener">NGINX</a>, <a href="http://www.haproxy.org/" target="_blank" rel="noopener">HAProxy</a>, …) in front of them. There are even strategies that can be used to make the loadbalancers themselves HA (ie, hosting multiple instances with their own class A DNS records). So if any instance of your service goes down, the loadbalancer will simply redirect traffic to one of the other available instances. The client will send in his next request and have no idea that he isn’t talking to the same instance. Honestly, this topic has been covered so much that I don’t need to go into great detail about it. But here’s a very generic picture:</p><img src="/2016/07/28/ha_deployments_with_fuse/http_stateless.png" title="HTTP Stateless"><p>Stateful HTTP apps have fallen out of favor over the last decade or so. Which is a good thing in my opinion! They usually require some sort of session replication and/or coordination among the cluster. So now all of your instances need to know about eachother (limiting our ability to scale). And every time an object/value is placed in the session, it must be replicated to the other members (causing quite a bit of overhead that compounds as the cluster grows). We can mitigate some of these problems by being creative with our architecture. For instance, instead of having every member in the cluster connected in a mesh configuration we can split our servers into multiple meshes and do “sticky” loadbalancing to them. But it’s all a lot of hassle that you shouldn’t deal with if you can find a way to make your apps stateless instead. Once again, this is a topic that has been covered many times on the internet. The only thing specific to Fuse (and the only thing I’ll elaborate on in this blog) is setting up session replication for the Karaf container.</p><p>For the most part, if you’re running Camel on any JavaEE app server (and tying to its Servlet container), it will have its own mechanism for session replication. Most of the time, this is completely hidden away from you, and you get it for “free” just by setting up your servers in a cluster configuration. For instance, <a href="http://developers.redhat.com/products/eap/overview/" target="_blank" rel="noopener">JBoss EAP</a> uses an internal <a href="http://infinispan.org/" target="_blank" rel="noopener">Infinispan</a> cache to store its session data. If you run your EAP instances in “domain” mode, they will automatically be clustered and will replicate sessions accordingly. While you can override the cache settings and tweak them to fit your needs, you usually don’t have to mess with it. However, if you are running on a Karaf container, you’ll have to do a bit more of the setup yourself. This is because Karaf doesn’t assume that you’re using sessions, or even that you’re using Servlets. And if you do decide to use Servlets, it doesn’t assume which Servlet container you’ll use (ie, Tomcat, Jetty, …). So when you use any of the HTTP based components that I listed above on Karaf, they will (by default) fire up an embedded Jetty container. Luckily, Jetty is pluggable enough that it allows you to swap out its session management implementation. So you could, for instance, setup and configure Jetty to use an Infinispan cluster. Take a look at the <a href="http://www.eclipse.org/jetty/documentation/9.4.x/session-management.html" target="_blank" rel="noopener">Jetty Docs</a> for more details. In any case, the mechanism by which a session is handled is transparent to your application. So it’s really more of a configuration detail. And just to stay consistent, here’s another generic picture:</p><img src="/2016/07/28/ha_deployments_with_fuse/http_stateful.png" title="HTTP Stateful"><h2 id="HL7-MLLP"><a href="#HL7-MLLP" class="headerlink" title="HL7/MLLP"></a>HL7/MLLP</h2><p>HL7/MLLP is a TCP based protocol for the healthcare industry. Digging in a bit more, HL7 (Health Level Seven) is the definition of the format of the message (which can be text or XML based), and MLLP (Minimal Lower Layer Protocol) just defines a couple of bytes that wrap the message so we know where to start/stop when reading it in. Support for HL7v2 is provided via the <a href="http://camel.apache.org/hl7.html" target="_blank" rel="noopener">HL7</a> component in conjunction with a TCP transport component for doing the actual socket handling (ie, <a href="http://camel.apache.org/mina2.html" target="_blank" rel="noopener">Mina</a>, or <a href="http://camel.apache.org/netty4.html" target="_blank" rel="noopener">Netty</a>). There is some work being done on an <a href="http://camel.apache.org/mllp.html" target="_blank" rel="noopener">MLLP</a> component that will make it a bit simpler to work with, but as of this writing it’s still a bit early. </p><p>All of that said, regardless of the transport component that you choose, or whether you’re working with HL7v2 (text) or HL7v3 (XML), the interaction is stateless. That is to say that a client sends in a request message and synchronously receives an “ack/nack” response. That is the entire transaction. Any other interaction is a separate message/ack and is handled independently. So no server-side coordination is required by the message acceptors (see “<em>Note</em>“ below). And because no server-side coordination is required, you can just use any available TCP loadbalancer (similar to what we did with stateless HTTP above). </p><p><em>Note: You may have a requirement to resequence the messages and process them in order. In which case, you can take a look at my previous blog: <a href="/2016/05/27/ordered_messaging_with_activemq_and_camel/" title="Ordered Messaging With ActiveMQ & Camel">Ordered Messaging With ActiveMQ & Camel</a>.</em> </p><p>Here’s a sample NGINX loadbalancer configuration that I used for a recent engagement:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">events &#123;</div><div class="line">  worker_connections 1024;</div><div class="line">&#125;</div><div class="line">stream &#123;</div><div class="line">  server &#123;</div><div class="line">    listen 7000;</div><div class="line">    proxy_pass tcp_backend;</div><div class="line">  &#125;</div><div class="line">  upstream tcp_backend &#123;</div><div class="line">    server instance-1.local:7000;</div><div class="line">    server instance-2.local:7000;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>And here’s a (really simple) sample architecture:</p><img src="/2016/07/28/ha_deployments_with_fuse/hl7_mllp.png" title="HL7/MLLP"><h2 id="File-FTP"><a href="#File-FTP" class="headerlink" title="File/FTP"></a>File/FTP</h2><p>When consuming files using the <a href="http://camel.apache.org/file2.html" target="_blank" rel="noopener">File</a> or <a href="http://camel.apache.org/ftp.html" target="_blank" rel="noopener">FTP</a> components, there are a couple of different strategies that you can use for an HA setup: active/passive, and active/active.</p><p>In an active/passive configuration, you will have a single (master) instance polling for files. All of the other instances (slaves) will be waiting on some kind of lock. The slave instances will not begin polling for files until they detect that the master is no longer alive and well. In this way, we make sure that multiple JVMs running the same file poller config aren’t stepping on eachother’s toes while trying to consume the files. So how do we setup this active/passive coordination? If you’re using <a href="http://fabric8.io/" target="_blank" rel="noopener">Fabric8</a> <strong>v1.x</strong> to cluster your <a href="http://karaf.apache.org/" target="_blank" rel="noopener">Karaf</a> instances, you can just use the <a href="http://fabric8.io/gitbook/camelEndpointMaster.html" target="_blank" rel="noopener">Master</a> component. It exploits the fact that a Fabric cluster uses a <a href="https://zookeeper.apache.org/" target="_blank" rel="noopener">ZooKeeper</a> ensemble internally and uses it as a locking mechanism. Nice and simple! But what if you’re not running in a Fabric cluster? You could stand up your own ZooKeeper ensemble… But that adds a bit of overhead that you might not be ok with if you’re not using it for anything else. Does that mean that you’re out of luck? Heck no! Camel rocks! We can just create our own custom <a href="http://camel.apache.org/routepolicy.html" target="_blank" rel="noopener">RoutePolicy</a> to do the same thing. Here’s an example that I threw together for a customer recently: <a href="https://github.com/joshdreagan/camel-singleton-policy" target="_blank" rel="noopener">https://github.com/joshdreagan/camel-singleton-policy</a>.</p><img src="/2016/07/28/ha_deployments_with_fuse/file_active-passive.png" title="File Active/Passive"><p>Often times, you won’t need the highest possible performance when polling for files. That’s because the most common use case is that I receive a few files for batch processing <em>maybe</em> once a day. So I can probably handle the actual polling/processing on a single instance. And in that case, the active/passive configuration would be perfectly fine. But what if I’m not receiving batch files once a day? What if I’m processing satellite perturbation data (<strong>TONS</strong> of tiny files) coming in 24/7 in a neverending stream? Maybe now I want to take advantage of my entire cluster to poll/process in an active/active configuration. That way I can scale it up… Luckily, Camel makes this extremely easy. Because, again, Camel rocks! If you look at the available options for the file component, you’ll notice that it basically has an <a href="http://camel.apache.org/idempotent-consumer.html" target="_blank" rel="noopener">Idempotent Consumer</a> pattern baked right in (take a look at the <code>inProgressRepository</code> option). What’s more, it’s extremely flexible. It just needs any implementation of <code>org.apache.camel.spi.IdempotentRepository</code>. And there are already several implementations canned and ready to go. So you can use anything from Infinispan to a relational DB to coordinate your consumers. Here’s some sample code that uses Infinispan: <a href="https://github.com/joshdreagan/clustered-file-consumer" target="_blank" rel="noopener">https://github.com/joshdreagan/clustered-file-consumer</a>. Feel free to plagiarize!</p><img src="/2016/07/28/ha_deployments_with_fuse/file_active-active.png" title="File Active/Active"><h2 id="JMS-ActiveMQ"><a href="#JMS-ActiveMQ" class="headerlink" title="JMS (ActiveMQ)"></a>JMS (ActiveMQ)</h2><p>JMS (<a href="http://activemq.apache.org/" target="_blank" rel="noopener">ActiveMQ</a>) is definitely the most difficult HA scenario that I’ll cover. Which is why I procrastinated and saved it until the end. Well… sort of… When talking about JMS on Fuse, you have to specify whether you mean from a client’s perspective, or from the broker’s perspective. </p><p>HA from the client’s perspective is actually quite simple. You just use the <a href="http://activemq.apache.org/failover-transport-reference.html" target="_blank" rel="noopener">Failover</a> transport when creating your <code>javax.jms.ConnectionFactory</code> and the failover is handled for you. If a broker goes down, the client libraries will transparently reconnect to the next broker (whether it’s a slave, or another master) and keep on chugging with little more than a blip in performance. But let’s spend a little time and talk about the more complex case of making the broker itself HA.</p><p>When we say “make the broker HA”, what we really mean is “make the in-flight data that the broker is storing HA”. Because of the nature of messaging and it’s typical use case/requirements, this almost always ends up being a trade-off for performance vs reliability. So first let’s cover the easiest, best performing solution.</p><p>In a <a href="http://activemq.apache.org/masterslave.html" target="_blank" rel="noopener">Master/Slave</a> (active/passive) architecture, two or more brokers point to the same physical data store (typically <a href="http://activemq.apache.org/kahadb.html" target="_blank" rel="noopener">KahaDB</a>). Because the store can only be written to by one instance at a time, we must use some form of locking (similar to what we talked about in the File/FTP section). The lock implementation that ActiveMQ uses is pluggable. So you can specify your own custom ones. But there are defaults for each of the <a href="http://activemq.apache.org/persistence.html" target="_blank" rel="noopener">persistence adapters</a> and I rarely see customers override them. </p><p>Let me give a concrete example… When setting up ActiveMQ as a master/slave pair (<em>non-Fabric managed</em>) and using KahaDB, you would likely place the KahaDB storage directory on a shared filesystem (ie, NFSv4). Unless you customized the configuration, ActiveMQ would default to using an actual “lock” file. When the instances came up, they would both attempt to acquire a filesystem-level lock on that file. Whoever got there first would become master, would open up the KahaDB for read/write, and would open up any listeners to begin accepting client connections. Any other instances would fail to get the lock and would begin try-polling until they got it. And until then, they would not read/write the KahaDB, or accept client connections. So they’re passive…</p><img src="/2016/07/28/ha_deployments_with_fuse/activemq_master-slave.png" title="ActiveMQ Master/Slave"><p>This is the simplest setup, but does have some caveats. First, we’ll need to setup a shared filesystem that both instances can see. This will likely be something like an NFSv4 share. And because we need an actual filesystem-level lock, we must use a filesystem that supports them (<em>which is why I used the example of NFSv4 above and not NFSv3</em>). You’ll probably also want to make the storage that hosts your NFS shares HA as well. So you’ll likely use a SAN or some hardware appliance that provides this functionality. <em>If you do so, make sure that any data duplication/backup that occurs is <strong>fully synchronous</strong> and that filesystem-level locks are preserved during a failover!</em> Looking at you EMC… Next, because of the shared storage, high throughput, and file locking requirements, the master/slave instances must live in the same datacenter. I’ve seen many clients try to skirt this requirement and it always ends badly. However, if set up correctly this provides nearly immediate failover of in-flight messages within a datacenter as well as high message throughput. So if this satisfies your requirements, stop here.</p><p>So what if I have a requirement for HA across datacenters? Ok… let’s negotiate a little more. The simplest &amp; fastest solution is to use the master/slave setup outlined above, but also have a warm site setup in another DC. If you experience a full DC outage, you can manually migrate the storage hosting your KahaDB to the backup DC, configure an ActiveMQ instance to point to it, and bring it online. It doesn’t care where the KahaDB came from, or if it was previously owned by another instance. It will simply read in any messages that are currently stored and begin processing/delivering them to consumers. <em>If you do this, make sure to remember not to mount the storage up to the primary again when it comes back online or you will end up with duplicate messages.</em> Alternately, you can just wait until the downed DC comes back online. As long as there is no storage loss, all of your messages are safe and will be processed. So it really comes down to the SLA (Service-Level Agreement) that you must support, how likely you think a full DC outage is to occur, and how much manual interaction you’re ok with if it does.</p><img src="/2016/07/28/ha_deployments_with_fuse/activemq_cross-dc.png" title="ActiveMQ Cross-DC"><p>Well, what if I have to protect against a <em>real</em> DC outage? This is affectionately known in the defense industry as “the smoking-hole scenario”. That is to say, what if I can’t be guaranteed that I’ll be able to migrate storage during an outage because my DC is not simply <em>down</em>, but rather <em>destroyed</em>? Well first things first… Prepare to make some serious performance tradeoffs. <em>I cannot stress this enough! You will not be processing large sets of data while synchronously replicating across a WAN.</em> </p><p>One solution that I’ve seen customers use is to replicate the storage using some sort of block-level disk replication software. <a href="https://www.drbd.org/" target="_blank" rel="noopener">DRBD</a> works well enough in this situation because it gives you a little bit of flexibility over performance vs absolute reliability (look at modes B or C in their docs (<strong>not A</strong>)). Basically, every write at the filesystem level is a blocking call. That call usually returns as soon as the data has been physically written to the disk. In the case of a block-level replication solution, that blocking call will not return until the data has been written to both the primary and the backup disks. Because this all occurs at the filesystem level, it is completely out of ActiveMQ’s hands. It just thinks it’s been given really slow storage. One thing to note here is that you would not set up an ActiveMQ Master/Slave pair using this technology because the filesystem-level locks would not replicate. So you would do the manual failover to the warm site as described above. The difference is that you won’t have to migrate the storage as it’s already been replicated safely to the backup DC.</p><img src="/2016/07/28/ha_deployments_with_fuse/activemq_cross-dc_drbd.png" title="ActiveMQ Cross-DC DRBD"><p>The second set of solutions that I’ve seen are a decent tick faster (still not blazing though), but add a bit complication to the clients. They’re both based on some variation of fanout/multicast. The basic gist of it is that the producer clients will send a copy of every message to a broker on both DCs. This isn’t that bad for the producers since the <a href="http://activemq.apache.org/fanout-transport-reference.html" target="_blank" rel="noopener">Fanout</a> transport handles all of the work for them. In fact, you can even toss in ActiveMQ’s <a href="http://activemq.apache.org/the-proxy-connector.html" target="_blank" rel="noopener">Proxy Connector</a> and the producer clients won’t have to change a bit.</p><img src="/2016/07/28/ha_deployments_with_fuse/activemq_cross-dc_fanout.png" title="ActiveMQ Cross-DC Fanout"><p>I know what you’re thinking… That doesn’t sound too bad. Where’s all this “complication” you were rambling on about? Don’t get too excited. We just haven’t gotten there yet. The added complication comes on the consumer/processing side. Basically, I now have duplicate messages that I’m processing. And I either have to prevent them using something like <a href="http://camel.apache.org/idempotent-consumer.html" target="_blank" rel="noopener">Idempotent Consumers</a> or embrace them by adding complication to my code.</p><p>The idempotent consumer strategy looks attractive because Camel makes it extremely easy. I just have to set up some sort of shared <code>org.apache.camel.spi.IdempotentRepository</code> and add a few lines of Camel routing to my <a href="http://camel.apache.org/jms.html" target="_blank" rel="noopener">JMS</a> consumers. Take a look at the <a href="https://github.com/joshdreagan/clustered-amq-examples" target="_blank" rel="noopener">https://github.com/joshdreagan/clustered-amq-examples</a> example <em>(specifically the “clustered-amq-examples-idempotent” module)</em> for more details. The problem is that I have to set up a repository that synchronously replicates its data across a WAN. So aren’t I back to the same exact problem I had before? Well… not quite. Definitely similar though. I’ll get a small performance boost since the producers are multicasting the message to both brokers in parallel (but blocking until they get back the configured minimum number of “acks”). And the synchronous replication that I mentioned is only an idempotent key (ie, the <code>JMSMessageID</code>) and not the entire message itself. Also, all instances are active. So I’m getting a bit more loadbalancing for my consumer clients. And they can failover faster than if I had a warm site setup (since I don’t have to perform a manual failover). That being said, don’t expect the performance to be stellar.</p><p>But what if I want my performance to be stellar? I told you you can’t have it! But we can possibly get a tiny bit better. The second option that I mentioned is to embrace the duplicates. Let’s expand on that. If I multicast/fanout a copy of every message to both brokers, I’m going to take that hit. If I want a fully synchronous, total data backup, there’s just no getting around it. But I don’t necessarily have to have my consumers coordinate. What if I just went ahead and processed the duplicates? Would the world end? Let’s use a concrete example. Let’s pretend that my consumers were accepting messages and placing each one into a relational DB. And let’s say that I might have some REST service that, when invoked with some ID, returns a record for that ID from that relational DB. If I inserted both copies of the message, my REST service would return two records. That’s not ideal! But what if it didn’t? What if I just had my REST service run a ever-so-slightly more complicated query that just returned the first record it found? I don’t care which one. They’re both the same. Now I’m back to the result that I wanted. And I have a pretty robust system that can handle duplicate records (both intentional and unintentional). Not too shabby! Now since you’re never satisfied, you might be asking about all of that duplicated data taking up extra space. Well that’s easy enough to fix… Simply have a “cleanup” job that runs at some predifined interval and removes any duplicates that it finds. I don’t care when it runs, or which record it ends up removing. My application will always return the correct result. Take a look at the <a href="https://github.com/joshdreagan/clustered-amq-examples" target="_blank" rel="noopener">https://github.com/joshdreagan/clustered-amq-examples</a> example <em>(specifically the “clustered-amq-examples-dupsok” module)</em> for more details.</p><p>So now you see why I saved JMS (ActiveMQ) HA to the very end. It’s a complicated subject with lots of possible solutions. Hopefully, one of them meets your needs. If not, there is just no pleasing you… Either way, this blog post has become way too wordy. So I’m calling it a day. :)</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;When out and about, I often get the question: “How do I setup HA (high availability) with &lt;a href=&quot;http://developers.redhat.com/products/fuse/overview/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Red Hat’s JBoss Fuse&lt;/a&gt;?”. People ask this question and they expect a simple, straightforward answer. And why shouldn’t they? The question is simple enough right? I could ask the same question about something like &lt;a href=&quot;http://tomcat.apache.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Tomcat&lt;/a&gt; and get a well documented answer involving little more than a loadbalancer. Unfortunately, the answer for Fuse is a bit more involved and usually starts with the annoying response of “it depends”.&lt;br&gt;
    
    </summary>
    
    
      <category term="fuse" scheme="http://blog.joshdreagan.com/tags/fuse/"/>
    
      <category term="camel" scheme="http://blog.joshdreagan.com/tags/camel/"/>
    
      <category term="jboss" scheme="http://blog.joshdreagan.com/tags/jboss/"/>
    
      <category term="cxf" scheme="http://blog.joshdreagan.com/tags/cxf/"/>
    
      <category term="activemq" scheme="http://blog.joshdreagan.com/tags/activemq/"/>
    
      <category term="amq" scheme="http://blog.joshdreagan.com/tags/amq/"/>
    
  </entry>
  
  <entry>
    <title>Ordered Messaging With ActiveMQ &amp; Camel</title>
    <link href="http://blog.joshdreagan.com/2016/05/27/ordered_messaging_with_activemq_and_camel/"/>
    <id>http://blog.joshdreagan.com/2016/05/27/ordered_messaging_with_activemq_and_camel/</id>
    <published>2016-05-27T06:00:00.000Z</published>
    <updated>2016-08-01T21:00:45.000Z</updated>
    
    <content type="html"><![CDATA[<p>I’ve been to several customers over the years who have a requirement to consume messages from a JMS queue in an ordered fashion. The discussions always go the same way… It starts out as a simple design, but becomes really problematic when they get to the implementation phase. Turns out, it’s really not all that simple once you try to scale. In this blog post, we’ll explore in a bit more detail and give some possible solutions.<br><a id="more"></a></p><blockquote><p>The sample code for this blog can be found at <a href="https://github.com/joshdreagan/ordered-activemq-consumer" target="_blank" rel="noopener">https://github.com/joshdreagan/ordered-activemq-consumer</a>.</p></blockquote><h2 id="Typical-Architecture"><a href="#Typical-Architecture" class="headerlink" title="Typical Architecture"></a>Typical Architecture</h2><p>So the first thing that people do is to create some test code. They know that JMS queues preserve order. So the logic goes that, if I put messages on the queue in order, I should be able to pull them off in the same order. They end up with something that looks similar to the picture below.</p><img src="/2016/05/27/ordered_messaging_with_activemq_and_camel/simple.png" title="[simple]"><p>Run a test and you’ll see that it does indeed work. Ship it! Well… maybe not just yet…</p><h2 id="Problems"><a href="#Problems" class="headerlink" title="Problems"></a>Problems</h2><p>This architecture may work in a very simple use case, but it has some serious limitations.</p><img src="/2016/05/27/ordered_messaging_with_activemq_and_camel/you_should_feel_bad.jpg" title="[You should feel bad...]"><p>The first problem that you’ll encounter is that this setup is really slow. It’s a given that, in order to process messages in order, the processing must occur in a single thread. However, I will likely have more than one group that could be processed independently. So in theory, I can have multiple producers sending sequences of messages. Take a look at the illustration below.</p><img src="/2016/05/27/ordered_messaging_with_activemq_and_camel/multiple_producer.png" title="[Multiple producers]"><p>Technically, everything still works. The single consumer will receive both sequences of messages and will process them in the order he receives them. So in the end, both groups will have their messages processed in order. But hopefully the flaw in this setup is obvious. As we scale up and add more and more producer groups, we are bottlenecked in performance by the single consumer. What happens when we try to scale the consumers?</p><img src="/2016/05/27/ordered_messaging_with_activemq_and_camel/multiple_consumer.png" title="[Multiple consumers]"><p>Things no longer work. Because the broker is going to loadbalance messages to the available consumers, we have no guarantee that the sequences of messages will be processed on the same thread. Which means we can’t guarantee order. And since we can’t add more consumers, there’s no sense in scaling out and adding more brokers either. Bummer… :(</p><h2 id="Possible-Solutions"><a href="#Possible-Solutions" class="headerlink" title="Possible Solutions"></a>Possible Solutions</h2><p>So the question is… How do we scale things out while maintaining our ability to process groups of messages in order? Well, one solution you might consider is <a href="http://activemq.apache.org/message-groups.html" target="_blank" rel="noopener">ActiveMQ’s Message Groups</a>. Basically, it’s a really neat feature that allows you to do “sticky” loadbalancing of messages to the available consumers. If the producers include a <code>JMSXGroupID</code> header on the JMS message, the broker will check to see if there is a consumer available that has already received messages with that same <code>JMSXGroupID</code>. If one is available, it will deliver the message to it (and all subsequent messages as well as long as it remains available). If not (either because this is the first it has seen that <code>JMSXGroupID</code>, or because the previous consumer has gone away), it will pick a new one. Here’s how that might look:</p><img src="/2016/05/27/ordered_messaging_with_activemq_and_camel/message_groups.png" title="[ActiveMQ Message Groups]"><p>Problem solved right? Depends on if you only need to use a single broker. And if you want to use more than one, it depends on how strict you are about the message ordering. Most of the time, things works fine. And if “most of the time” is good enough for your requirements, then this is definitely the simplest solution. So go with it.</p><p>But let’s go ahead and discuss the corner case where it doesn’t work out so well. There are 2 things to be aware of: First, when a message is received by a broker, it is persisted in that broker’s store and exists only on that broker. Second, if a consumer goes away for any reason (ie, network blip, restart, …) the broker will pick a new recipient and start sending the messages to it instead. So let’s assume that I have a network of brokers setup (because I like to scale). And if I have a network of brokers setup, I’ll probably use some form of failover (because I like to be HA for my clients). So in this setup, what happens if we send a message to a broker, but the broker is taken down before it can deliver it. The producers would failover and keep sending messages to the next available broker. That broker would pick a consumer and continue delivering messages to it with no knowledge that the failed broker was still holding on to some messages. Now I’m back to getting my messages out of order. Here’s what that might look like:</p><img src="/2016/05/27/ordered_messaging_with_activemq_and_camel/multiple_brokers__message_groups.png" title="[ActiveMQ Message Groups in a cluster]"><p>Furthermore, what if I don’t have control over the producers? If I don’t control them, I might not be able to enforce that they set a <code>JMSXGroupID</code> header. So how might I go about solving this conundrum? I’m glad you asked. :)</p><p>One solution would be to use some Camel magic. <a href="http://camel.apache.org/" target="_blank" rel="noopener">Because Camel is awesome!</a> If I use Camel as a consumer, I can have it pipe the messages into an <a href="http://camel.apache.org/aggregator2.html" target="_blank" rel="noopener">aggregator</a> that can just store them up in a list. Once I’ve received all of them, I can then send them to a <a href="http://camel.apache.org/splitter.html" target="_blank" rel="noopener">splitter</a> to get them back to individual messages, and then send those individual messages through a <a href="http://camel.apache.org/resequencer.html" target="_blank" rel="noopener">resequencer</a> (and finally to my desired destination). My messages for each group/sequence will be processed in a single thread (assuming I don’t enable any parallel processing) and will be emitted in order. EIPs for the win! The nice thing about this solution is that I don’t have to worry about those stuck messages. As soon as the failed broker comes back online (or its slave takes over), I will receive that stuck message. And until it does, all of my other messages for that group/sequence will sit patiently and wait inside my aggregation repository. Another thing to note is that I don’t have to complete my aggregation based on some fixed number. I have all kinds of flexibility for my criteria. Take a look at the <a href="http://camel.apache.org/aggregator2.html" target="_blank" rel="noopener">Camel docs</a> for more info. Here’s a nice picture:</p><img src="/2016/05/27/ordered_messaging_with_activemq_and_camel/multiple_brokers__camel.png" title="[Camel in a cluster]"><p>So what’s the catch? Well… technically all of the aggregation repository implementations that exist so far can’t work in a cluster or even with multiple threads. There has been some work to handle optimistic locking, but if you give it a try (or dig through the code if you don’t believe me) you’ll find that they only handle the case of 2 threads trying to do the initial insert at the same time. They still have an issue where 2 threads might be attempting to update the repository at the same time and could squash eachother’s changes. Luckily, Camel lets us write our own <code>org.apache.camel.spi.AggregationRepository</code> implementations. Did I mention that Camel rocks!? Take a look at the example code found here: <a href="https://github.com/joshdreagan/ordered-activemq-consumer" target="_blank" rel="noopener">https://github.com/joshdreagan/ordered-activemq-consumer</a>.</p><p>Basically, I just copied most of the code from the existing <code>org.apache.camel.processor.aggregate.jdbc.JdbcAggregationRepository</code> implementation. But I added a <code>version</code> column to the underlying database tables and some logic to check and increment it (or throw an exception if it doesn’t match) on insert/update. I’m sure there’s a lot more that could be done to make it more robust (like have it implement <code>org.apache.camel.spi.RecoverableAggregationRepository</code> as well). But hey… this is just an example. Do your own coding damnit!</p><p>I’m sure this isn’t an exhaustive list of every possible way to solve this problem. But it’s a least a couple… And that should definitely be worth a glass of <a href="https://www.masterofmalt.com/whiskies/lagavulin/lagavulin-16-year-old-whisky/" target="_blank" rel="noopener">good Scotch</a>. So if you see me at <a href="https://www.redhat.com/en/summit" target="_blank" rel="noopener">Red Hat Summit</a>… :)</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;I’ve been to several customers over the years who have a requirement to consume messages from a JMS queue in an ordered fashion. The discussions always go the same way… It starts out as a simple design, but becomes really problematic when they get to the implementation phase. Turns out, it’s really not all that simple once you try to scale. In this blog post, we’ll explore in a bit more detail and give some possible solutions.&lt;br&gt;
    
    </summary>
    
    
      <category term="camel" scheme="http://blog.joshdreagan.com/tags/camel/"/>
    
      <category term="activemq" scheme="http://blog.joshdreagan.com/tags/activemq/"/>
    
  </entry>
  
  <entry>
    <title>AMQP Performance Testing With JBoss A-MQ</title>
    <link href="http://blog.joshdreagan.com/2016/02/02/amqp_performance_testing/"/>
    <id>http://blog.joshdreagan.com/2016/02/02/amqp_performance_testing/</id>
    <published>2016-02-02T07:00:00.000Z</published>
    <updated>2016-08-01T21:00:45.000Z</updated>
    
    <content type="html"><![CDATA[<p>I recently had a customer that wanted us to do some load testing of <a href="http://www.jboss.org/products/amq/overview/" target="_blank" rel="noopener">Red Hat’s JBoss A-MQ</a> for them. In particular, this customer wanted the tests performed using the AMQP protocol instead of ActiveMQ’s native OpenWire. From previous engagements, I knew that there would be a performance difference. But after a quick look I didn’t see any blogs or posts on the subject. More specifically, I didn’t see any posts that detailed how to run the tests yourself so that you could get real numbers in your own environment. So I figured I’d write up some steps and post my results for future reference.<br><a id="more"></a></p><blockquote><p><strong>Please note that the purpose of this blog post is not to give you a number of msg/s to expect or tell you the absolute best way to tune your broker. The purpose of this post is to show you how to run the tests yourself and give you some very rough idea of the performance difference between the two protocols. All of my testing was done on my laptop using the default configurations. You will probably get wildly different performance in your environment and will likely need to tune the broker specific to your use case to get the best performance possible.</strong></p></blockquote><h2 id="Protocol-Basics"><a href="#Protocol-Basics" class="headerlink" title="Protocol Basics"></a>Protocol Basics</h2><p>Both <a href="https://www.amqp.org/" target="_blank" rel="noopener">AMQP (Advanced Message Queuing Protocol)</a> and <a href="http://activemq.apache.org/openwire.html" target="_blank" rel="noopener">OpenWire</a> are what we refer to as “wire-level protocols”. They define how a client and broker will negotiate a connection, how they’ll format messages, and how they’ll communicate in general. ActiveMQ can speak many different wire-level protocols, but OpenWire and AMQP are supposed to be the fastest as they are both binary in nature. In both cases, you have multiple options as to what language your clients can be written in (ie, Java, .NET, C++, …). It really doesn’t matter as long as they are communicating via the same wire-level protocol as the broker. In this case, I’ll be using Java simply because of the availability of test tools.</p><h2 id="Test-Details"><a href="#Test-Details" class="headerlink" title="Test Details"></a>Test Details</h2><p>There are a ton of available test tools that you can use to drive traffic to your brokers. For this blog, I used the <a href="http://activemq.apache.org/activemq-performance-module-users-manual.html" target="_blank" rel="noopener">ActiveMQ Perf Maven Plugin</a>. This is a great tool that comes with the ActiveMQ source code and allows you to run as both producers and consumers. It is easily configurable and gives you a ton of options to test various scenarios (ie, persistent/non-persistent, transacted/non-transacted, 1-n producer/consumer threads, …). The only caveat to the tool is that it will load a connection factory that uses the OpenWire protocol. Luckily, it was written in such a way that we can extend it to use AMQP as well. To do that, we only need to create one class that knows how to load an AMQP connection factory. The source for the class is as follows:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.jboss.examples.amqp.spi;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.activemq.tool.spi.ReflectionSPIConnectionFactory;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AMQPReflectionSPIConnectionFactory</span> <span class="keyword">extends</span> <span class="title">ReflectionSPIConnectionFactory</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getClassName</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"org.apache.qpid.jms.JmsConnectionFactory"</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>Then we just need to make sure that our custom class and the Qpid client libraries are on the Maven classpath.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>$&#123;project.groupId&#125;<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.activemq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activemq-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;activemq.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.qpid<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>qpid-jms-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;qpid.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure><p>The tricky part is that we need them on the classpath of the Maven plugin itself and not necessarily the classpath of the project. Take a look at the <a href="https://github.com/joshdreagan/amqp-perf-test/blob/master/pom.xml" target="_blank" rel="noopener">pom.xml</a> file to see what I mean. The full code for this test can be found at <a href="https://github.com/joshdreagan/amqp-perf-test" target="_blank" rel="noopener">https://github.com/joshdreagan/amqp-perf-test</a>. Feel free to just clone it down and use it directly.</p><p>If you take a look at the <a href="http://activemq.apache.org/activemq-performance-module-users-manual.html" target="_blank" rel="noopener">plugin’s documentation</a>, you’ll see several properties that can be set for the test as a whole, the consumer, the producer, and the connection factory. You can configure the properties using “-Dkey=value” arguments on the command line, or via a .properties file (or some combination of the two). If you plan to run the test multiple times, it’s probably worth creating a .properties file. The only detail that I’ll give here is that the connection factory properties are set via reflection and will be specific to the connection factory used. I mention this because we swap out the connection factory when we run the AMQP tests. To give a concrete example, when using the <code>org.apache.activemq.tool.spi.ActiveMQReflectionSPI</code> you will set the URI for the broker using <code>-Dfactory.brokerURL=tcp://localhost:61616</code>, but when using the <code>org.jboss.examples.amqp.spi.AMQPReflectionSPIConnectionFactory</code> you will set the URI for the broker using <code>-Dfactory.remoteURI=amqp://localhost:5672</code>. This is because the “setters” are named differently for the different connection factory implementations. The available options for the AMQP connection factory can be found in the <a href="https://qpid.apache.org/releases/qpid-jms-0.5.0/docs/index.html" target="_blank" rel="noopener">Qpid docs</a>. All other options (ie, producer, consumers, &amp; test) should be the same and are found on the <a href="http://activemq.apache.org/activemq-performance-module-users-manual.html" target="_blank" rel="noopener">plugin docs</a>.</p><h2 id="Test-Results"><a href="#Test-Results" class="headerlink" title="Test Results"></a>Test Results</h2><p>Here are some sample runs that I did. <em>Please note the disclaimer at the beginning of this blog post regarding performance results.</em></p><h3 id="Producer-OpenWire"><a href="#Producer-OpenWire" class="headerlink" title="Producer OpenWire"></a>Producer OpenWire</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">$&gt; mvn activemq-perf:producer -DsysTest.propsConfigFile=src/main/resources/tcp-producer.properties</div><div class="line">OpenJDK 64-Bit Server VM warning: ignoring option MaxPermSize=2048m; support was removed in 8.0</div><div class="line">[INFO] Scanning for projects...</div><div class="line">[INFO]                                                                         </div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] Building ActiveMQ Perf: AMQP Perf Test 1.0.0-SNAPSHOT</div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] </div><div class="line">[INFO] --- activemq-perf-maven-plugin:5.11.0:producer (default-cli) @ amqp-perf-test ---</div><div class="line">[INFO] Loading properties file: /home/jreagan/Development/Projects/joshdreagan/amqp-perf-test/src/main/resources/tcp-producer.properties</div><div class="line">[INFO] Created: org.apache.activemq.ActiveMQConnectionFactory using SPIConnectionFactory: org.apache.activemq.tool.spi.ActiveMQReflectionSPI</div><div class="line">[INFO] Sampling duration: 300000 ms, ramp up: 0 ms, ramp down: 0 ms</div><div class="line">[INFO] Creating queue: queue://TEST.FOO</div><div class="line">[INFO] Creating JMS Connection: Provider=ActiveMQ-5.11.0, JMS Spec=1.1</div><div class="line">[INFO] Creating  producer to: queue://TEST.FOO with non-persistent delivery.</div><div class="line">[INFO] Starting to publish 1024 byte(s) messages for 300000 ms</div><div class="line">[INFO] Finished sending</div><div class="line">[INFO] Client completed</div><div class="line">#########################################</div><div class="line">####    SYSTEM THROUGHPUT SUMMARY    ####</div><div class="line">#########################################</div><div class="line">System Total Throughput: 13347982</div><div class="line">System Total Clients: 1</div><div class="line">System Average Throughput: 44493.27333333333</div><div class="line">System Average Throughput Excluding Min/Max: 44274.73333333333</div><div class="line">System Average Client Throughput: 44493.27333333333</div><div class="line">System Average Client Throughput Excluding Min/Max: 44274.73333333333</div><div class="line">Min Client Throughput Per Sample: clientName=JmsProducer0, value=0</div><div class="line">Max Client Throughput Per Sample: clientName=JmsProducer0, value=65562</div><div class="line">Min Client Total Throughput: clientName=JmsProducer0, value=13347982</div><div class="line">Max Client Total Throughput: clientName=JmsProducer0, value=13347982</div><div class="line">Min Average Client Throughput: clientName=JmsProducer0, value=44493.27333333333</div><div class="line">Max Average Client Throughput: clientName=JmsProducer0, value=44493.27333333333</div><div class="line">Min Average Client Throughput Excluding Min/Max: clientName=JmsProducer0, value=44274.73333333333</div><div class="line">Max Average Client Throughput Excluding Min/Max: clientName=JmsProducer0, value=44274.73333333333</div><div class="line">[INFO] Created performance report: /home/jreagan/Development/Projects/joshdreagan/amqp-perf-test/./target/JmsProducer_numClients1_numDests1_all.xml</div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] BUILD SUCCESS</div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] Total time: 05:10 min</div><div class="line">[INFO] Finished at: 2016-02-02T11:46:30-07:00</div><div class="line">[INFO] Final Memory: 8M/235M</div><div class="line">[INFO] ------------------------------------------------------------------------</div></pre></td></tr></table></figure><h3 id="Consumer-OpenWire"><a href="#Consumer-OpenWire" class="headerlink" title="Consumer OpenWire"></a>Consumer OpenWire</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">$&gt; mvn activemq-perf:consumer -DsysTest.propsConfigFile=src/main/resources/tcp-consumer.properties</div><div class="line">OpenJDK 64-Bit Server VM warning: ignoring option MaxPermSize=2048m; support was removed in 8.0</div><div class="line">[INFO] Scanning for projects...</div><div class="line">[INFO]                                                                         </div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] Building ActiveMQ Perf: AMQP Perf Test 1.0.0-SNAPSHOT</div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] </div><div class="line">[INFO] --- activemq-perf-maven-plugin:5.11.0:consumer (default-cli) @ amqp-perf-test ---</div><div class="line">[INFO] Loading properties file: /home/jreagan/Development/Projects/joshdreagan/amqp-perf-test/src/main/resources/tcp-consumer.properties</div><div class="line">[INFO] Created: org.apache.activemq.ActiveMQConnectionFactory using SPIConnectionFactory: org.apache.activemq.tool.spi.ActiveMQReflectionSPI</div><div class="line">[INFO] Sampling duration: 300000 ms, ramp up: 0 ms, ramp down: 0 ms</div><div class="line">[INFO] Creating queue: queue://TEST.FOO</div><div class="line">[INFO] Creating JMS Connection: Provider=ActiveMQ-5.11.0, JMS Spec=1.1</div><div class="line">[INFO] Creating non-durable consumer to: queue://TEST.FOO</div><div class="line">[INFO] Starting to asynchronously receive messages for 300000 ms...</div><div class="line">[INFO] Client completed</div><div class="line">#########################################</div><div class="line">####    SYSTEM THROUGHPUT SUMMARY    ####</div><div class="line">#########################################</div><div class="line">System Total Throughput: 13287310</div><div class="line">System Total Clients: 1</div><div class="line">System Average Throughput: 44291.03333333333</div><div class="line">System Average Throughput Excluding Min/Max: 44074.76</div><div class="line">System Average Client Throughput: 44291.03333333333</div><div class="line">System Average Client Throughput Excluding Min/Max: 44074.76</div><div class="line">Min Client Throughput Per Sample: clientName=JmsConsumer0, value=0</div><div class="line">Max Client Throughput Per Sample: clientName=JmsConsumer0, value=64882</div><div class="line">Min Client Total Throughput: clientName=JmsConsumer0, value=13287310</div><div class="line">Max Client Total Throughput: clientName=JmsConsumer0, value=13287310</div><div class="line">Min Average Client Throughput: clientName=JmsConsumer0, value=44291.03333333333</div><div class="line">Max Average Client Throughput: clientName=JmsConsumer0, value=44291.03333333333</div><div class="line">Min Average Client Throughput Excluding Min/Max: clientName=JmsConsumer0, value=44074.76</div><div class="line">Max Average Client Throughput Excluding Min/Max: clientName=JmsConsumer0, value=44074.76</div><div class="line">[INFO] Created performance report: /home/jreagan/Development/Projects/joshdreagan/amqp-perf-test/./target/JmsConsumer_numClients1_numDests1_equal.xml</div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] BUILD SUCCESS</div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] Total time: 05:00 min</div><div class="line">[INFO] Finished at: 2016-02-02T11:46:19-07:00</div><div class="line">[INFO] Final Memory: 7M/220M</div><div class="line">[INFO] ------------------------------------------------------------------------</div></pre></td></tr></table></figure><h3 id="Producer-AMQP"><a href="#Producer-AMQP" class="headerlink" title="Producer AMQP"></a>Producer AMQP</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">$&gt; mvn activemq-perf:producer -DsysTest.propsConfigFile=src/main/resources/amqp-producer.properties</div><div class="line">OpenJDK 64-Bit Server VM warning: ignoring option MaxPermSize=2048m; support was removed in 8.0</div><div class="line">[INFO] Scanning for projects...</div><div class="line">[INFO]                                                                         </div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] Building ActiveMQ Perf: AMQP Perf Test 1.0.0-SNAPSHOT</div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] </div><div class="line">[INFO] --- activemq-perf-maven-plugin:5.11.0:producer (default-cli) @ amqp-perf-test ---</div><div class="line">[INFO] Loading properties file: /home/jreagan/Development/Projects/joshdreagan/amqp-perf-test/src/main/resources/amqp-producer.properties</div><div class="line">[INFO] Created: org.apache.qpid.jms.JmsConnectionFactory using SPIConnectionFactory: org.jboss.examples.amqp.spi.AMQPReflectionSPIConnectionFactory</div><div class="line">[INFO] Sampling duration: 300000 ms, ramp up: 0 ms, ramp down: 0 ms</div><div class="line">[INFO] Creating queue: queue://TEST.FOO</div><div class="line">[INFO] Best match for SASL auth was: SASL-PLAIN</div><div class="line">[INFO] Connection ID:bearkat-34938-1454439352850-0:2 connected to remote Broker: amqp://localhost:5672</div><div class="line">[INFO] Creating JMS Connection: Provider=QpidJMS-0.5.0, JMS Spec=1.1</div><div class="line">[INFO] Creating  producer to: TEST.FOO with non-persistent delivery.</div><div class="line">[INFO] Starting to publish 1024 byte(s) messages for 300000 ms</div><div class="line">[INFO] Finished sending</div><div class="line">[INFO] Client completed</div><div class="line">#########################################</div><div class="line">####    SYSTEM THROUGHPUT SUMMARY    ####</div><div class="line">#########################################</div><div class="line">System Total Throughput: 3600145</div><div class="line">System Total Clients: 1</div><div class="line">System Average Throughput: 12000.483333333334</div><div class="line">System Average Throughput Excluding Min/Max: 11947.51</div><div class="line">System Average Client Throughput: 12000.483333333334</div><div class="line">System Average Client Throughput Excluding Min/Max: 11947.51</div><div class="line">Min Client Throughput Per Sample: clientName=JmsProducer0, value=1800</div><div class="line">Max Client Throughput Per Sample: clientName=JmsProducer0, value=14092</div><div class="line">Min Client Total Throughput: clientName=JmsProducer0, value=3600145</div><div class="line">Max Client Total Throughput: clientName=JmsProducer0, value=3600145</div><div class="line">Min Average Client Throughput: clientName=JmsProducer0, value=12000.483333333334</div><div class="line">Max Average Client Throughput: clientName=JmsProducer0, value=12000.483333333334</div><div class="line">Min Average Client Throughput Excluding Min/Max: clientName=JmsProducer0, value=11947.51</div><div class="line">Max Average Client Throughput Excluding Min/Max: clientName=JmsProducer0, value=11947.51</div><div class="line">[INFO] Created performance report: /home/jreagan/Development/Projects/joshdreagan/amqp-perf-test/./target/JmsProducer_numClients1_numDests1_all.xml</div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] BUILD SUCCESS</div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] Total time: 05:00 min</div><div class="line">[INFO] Finished at: 2016-02-02T12:00:53-07:00</div><div class="line">[INFO] Final Memory: 10M/128M</div><div class="line">[INFO] ------------------------------------------------------------------------</div></pre></td></tr></table></figure><h3 id="Consumer-AMQP"><a href="#Consumer-AMQP" class="headerlink" title="Consumer AMQP"></a>Consumer AMQP</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">$&gt; mvn activemq-perf:consumer -DsysTest.propsConfigFile=src/main/resources/amqp-consumer.properties</div><div class="line">OpenJDK 64-Bit Server VM warning: ignoring option MaxPermSize=2048m; support was removed in 8.0</div><div class="line">[INFO] Scanning for projects...</div><div class="line">[INFO]                                                                         </div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] Building ActiveMQ Perf: AMQP Perf Test 1.0.0-SNAPSHOT</div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] </div><div class="line">[INFO] --- activemq-perf-maven-plugin:5.11.0:consumer (default-cli) @ amqp-perf-test ---</div><div class="line">[INFO] Loading properties file: /home/jreagan/Development/Projects/joshdreagan/amqp-perf-test/src/main/resources/amqp-consumer.properties</div><div class="line">[INFO] Created: org.apache.qpid.jms.JmsConnectionFactory using SPIConnectionFactory: org.jboss.examples.amqp.spi.AMQPReflectionSPIConnectionFactory</div><div class="line">[INFO] Sampling duration: 300000 ms, ramp up: 0 ms, ramp down: 0 ms</div><div class="line">[INFO] Creating queue: queue://TEST.FOO</div><div class="line">[INFO] Best match for SASL auth was: SASL-PLAIN</div><div class="line">[INFO] Connection ID:bearkat-51184-1454439351110-0:2 connected to remote Broker: amqp://localhost:5672</div><div class="line">[INFO] Creating JMS Connection: Provider=QpidJMS-0.5.0, JMS Spec=1.1</div><div class="line">[INFO] Creating non-durable consumer to: TEST.FOO</div><div class="line">[INFO] Starting to asynchronously receive messages for 300000 ms...</div><div class="line">[INFO] Client completed</div><div class="line">#########################################</div><div class="line">####    SYSTEM THROUGHPUT SUMMARY    ####</div><div class="line">#########################################</div><div class="line">System Total Throughput: 3583507</div><div class="line">System Total Clients: 1</div><div class="line">System Average Throughput: 11945.023333333333</div><div class="line">System Average Throughput Excluding Min/Max: 11899.69</div><div class="line">System Average Client Throughput: 11945.023333333333</div><div class="line">System Average Client Throughput Excluding Min/Max: 11899.69</div><div class="line">Min Client Throughput Per Sample: clientName=JmsConsumer0, value=0</div><div class="line">Max Client Throughput Per Sample: clientName=JmsConsumer0, value=13600</div><div class="line">Min Client Total Throughput: clientName=JmsConsumer0, value=3583507</div><div class="line">Max Client Total Throughput: clientName=JmsConsumer0, value=3583507</div><div class="line">Min Average Client Throughput: clientName=JmsConsumer0, value=11945.023333333333</div><div class="line">Max Average Client Throughput: clientName=JmsConsumer0, value=11945.023333333333</div><div class="line">Min Average Client Throughput Excluding Min/Max: clientName=JmsConsumer0, value=11899.69</div><div class="line">Max Average Client Throughput Excluding Min/Max: clientName=JmsConsumer0, value=11899.69</div><div class="line">[INFO] Created performance report: /home/jreagan/Development/Projects/joshdreagan/amqp-perf-test/./target/JmsConsumer_numClients1_numDests1_equal.xml</div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] BUILD SUCCESS</div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] Total time: 05:01 min</div><div class="line">[INFO] Finished at: 2016-02-02T12:00:51-07:00</div><div class="line">[INFO] Final Memory: 12M/243M</div><div class="line">[INFO] ------------------------------------------------------------------------</div></pre></td></tr></table></figure><p>That’s it! You can see that OpenWire is quite a bit faster in this case. But please don’t take my word for it… clone the project, tweak some configurations, try scaling the producers/consumers/brokers, and run the test yourself to see what results you’ll get.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;I recently had a customer that wanted us to do some load testing of &lt;a href=&quot;http://www.jboss.org/products/amq/overview/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Red Hat’s JBoss A-MQ&lt;/a&gt; for them. In particular, this customer wanted the tests performed using the AMQP protocol instead of ActiveMQ’s native OpenWire. From previous engagements, I knew that there would be a performance difference. But after a quick look I didn’t see any blogs or posts on the subject. More specifically, I didn’t see any posts that detailed how to run the tests yourself so that you could get real numbers in your own environment. So I figured I’d write up some steps and post my results for future reference.&lt;br&gt;
    
    </summary>
    
    
      <category term="jboss" scheme="http://blog.joshdreagan.com/tags/jboss/"/>
    
      <category term="activemq" scheme="http://blog.joshdreagan.com/tags/activemq/"/>
    
      <category term="a-mq" scheme="http://blog.joshdreagan.com/tags/a-mq/"/>
    
  </entry>
  
  <entry>
    <title>Custom Camel LoadBalancer With Infinispan</title>
    <link href="http://blog.joshdreagan.com/2015/12/04/custom_camel_loadbalancer_with_infinispan/"/>
    <id>http://blog.joshdreagan.com/2015/12/04/custom_camel_loadbalancer_with_infinispan/</id>
    <published>2015-12-04T07:00:00.000Z</published>
    <updated>2016-08-01T21:00:45.000Z</updated>
    
    <content type="html"><![CDATA[<p>Apache Camel is a pretty full-featured EIP implementation framework. It has several existing strategies for load-balancing right out of the box. Round Robin, Random, Sticky, Weighted Round Robin, Weighted Random,… the list goes on and on. But being that it’s a very well written and pluggable framework, it also gives you the ability to drop in your own custom strategies should you find that none of the existing ones meet your specific needs. So for this post, I created a custom Camel Load Balancer implementation utilizing an Infinispan cache to dynamically discover and load-balance between destination endpoints.<br><a id="more"></a></p><blockquote><p>The sample code for this post can be found at <a href="https://github.com/joshdreagan/infinispan-discovery" target="_blank" rel="noopener">https://github.com/joshdreagan/infinispan-discovery</a></p></blockquote><h2 id="Why"><a href="#Why" class="headerlink" title="Why?"></a>Why?</h2><p>Why would I do such a thing? Well… there’s a few good reasons.</p><p>First, all of the existing load-balancer strategies work on a static list. So if I know all of my endpoints ahead of time, no problem. I just code them into my Camel route. But what if my list of endpoints changes between environments? Maybe I could use properties. Well… only if the number of endpoints is static. Which brings me to the next reason…</p><p>All of the existing load-balancer strategies are configured at startup. So what do I do if my list changes dynamically at runtime? Let’s say that I want to do service discovery and load-balance between the currently active/registered backend services. If you’re familiar with Camel, you might be thinking “Why not just use the Camel Fabric Component? It does dynamic load-balancing and service discovery. Problem solved right?”. If all of my services are running in containers that are managed by Fabric8, that is a viable solution. But what if I want to discover some endpoints that are running on JBoss EAP instances. Or what if I’m not running a Fabric8 ensemble at all?</p><p>Finally, the most important reason… Because I can. :)</p><h2 id="Implementation-Details"><a href="#Implementation-Details" class="headerlink" title="Implementation Details"></a>Implementation Details</h2><p>Creating a custom Camel Load Balancer implementation is fairly straight forward. You just create a class and implement the <code>LoadBalancer</code> interface. There’s even a base class (<code>LoadBalancerSupport</code>) that you can extend that will take care of some of the boilerplate coding for you. You then just fill in the details of how it picks the next endpoint from its internal list. Pretty simple right?</p><p>In my case, however, I’m not actually coming up with my own strategy for how to pick endpoints. I’m really just augmenting some existing strategy with a dynamic list of endpoints. So to be more specific, I’m not interested in implementing my own flavor of the Random, Round Robin, Sticky, … strategies. No need to reinvent that wheel. Instead, I just want to decorate those existing strategies and provide them with some additional capabilities. So I use the decorator pattern. That allows me to ignore all the tom-foolery of the load-balancing itself and concentrate on the portion that I really want. The dynamic service discovery.</p><p>Here’s my custom load-balancer class (or at least the important parts):</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.apache.camel.processor.loadbalancer;</div><div class="line"></div><div class="line"><span class="comment">// Import statements removed for brevity.</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JCacheLoadBalancer</span> <span class="keyword">extends</span> <span class="title">ServiceSupport</span> <span class="keyword">implements</span> <span class="title">LoadBalancer</span>, <span class="title">CamelContextAware</span>, <span class="title">InitializingBean</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(JCacheLoadBalancer.class);</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LoadBalancer DEFAULT_DELEGATE = <span class="keyword">new</span> RoundRobinLoadBalancer();</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Cache&lt;String, Set&lt;String&gt;&gt; registry;</div><div class="line">  <span class="keyword">private</span> String groupId;</div><div class="line">  <span class="keyword">private</span> LoadBalancer delegate;</div><div class="line">  <span class="keyword">private</span> UriPreProcessor uriPreProcessor;</div><div class="line">  <span class="keyword">private</span> Boolean throwExceptionIfEmpty;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Map&lt;String, Processor&gt; processorMap;</div><div class="line">  <span class="keyword">private</span> CacheEntryListenerConfiguration&lt;String, Set&lt;String&gt;&gt; registryListenerConfiguration;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> CamelContext camelContext;</div><div class="line"></div><div class="line">  <span class="comment">// Getters and setters removed for brevity.</span></div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addProcessor</span><span class="params">(Processor processor)</span> </span>&#123;</div><div class="line">    delegate.addProcessor(processor);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeProcessor</span><span class="params">(Processor processor)</span> </span>&#123;</div><div class="line">    delegate.removeProcessor(processor);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> List&lt;Processor&gt; <span class="title">getProcessors</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> delegate.getProcessors();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Exchange exchange, AsyncCallback callback)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> ((getProcessors() == <span class="keyword">null</span> || getProcessors().isEmpty()) &amp;&amp; throwExceptionIfEmpty) &#123;</div><div class="line">      <span class="keyword">if</span> (throwExceptionIfEmpty) &#123;</div><div class="line">        exchange.setException(<span class="keyword">new</span> LoadBalancerUnavailableException(String.format(<span class="string">"No URIs found for service '%s'."</span>, groupId)));</div><div class="line">      &#125;</div><div class="line">      callback.done(<span class="keyword">true</span>);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">return</span> delegate.process(exchange, callback);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Exchange exchange)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">if</span> ((getProcessors() == <span class="keyword">null</span> || getProcessors().isEmpty()) &amp;&amp; throwExceptionIfEmpty) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> LoadBalancerUnavailableException(String.format(<span class="string">"No URIs found for service '%s'."</span>, groupId));</div><div class="line">    &#125;</div><div class="line">    delegate.process(exchange);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doStart</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">if</span> (delegate == DEFAULT_DELEGATE) &#123;</div><div class="line">      ((Service) delegate).start();</div><div class="line">    &#125;</div><div class="line">    registry.registerCacheEntryListener(registryListenerConfiguration);</div><div class="line">    processUris(registry.get(groupId));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doStop</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    registry.deregisterCacheEntryListener(registryListenerConfiguration);</div><div class="line">    <span class="keyword">if</span> (delegate == DEFAULT_DELEGATE) &#123;</div><div class="line">      ((Service) delegate).stop();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Objects.requireNonNull(registry, <span class="string">"The registry property must not be null."</span>);</div><div class="line">    Objects.requireNonNull(groupId, <span class="string">"The groupId property must not be null."</span>);</div><div class="line">    Objects.requireNonNull(camelContext, <span class="string">"The camelContext property must not be null."</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (delegate == <span class="keyword">null</span>) &#123;</div><div class="line">      delegate = DEFAULT_DELEGATE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (throwExceptionIfEmpty == <span class="keyword">null</span>) &#123;</div><div class="line">      throwExceptionIfEmpty = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    processorMap = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    registryListenerConfiguration = <span class="keyword">new</span> MutableCacheEntryListenerConfiguration&lt;&gt;(<span class="keyword">new</span> LookupCacheListenerFactory(), <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processUris</span><span class="params">(Set&lt;String&gt; uris)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">if</span> (uris == <span class="keyword">null</span>) &#123;</div><div class="line">      uris = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (String uri : processorMap.keySet()) &#123;</div><div class="line">      <span class="keyword">if</span> (!uris.contains(uri)) &#123;</div><div class="line">        log.info(String.format(<span class="string">"Removing uri: %s"</span>, uri));</div><div class="line">        Processor processor = processorMap.remove(uri);</div><div class="line">        removeProcessor(processor);</div><div class="line">        <span class="keyword">if</span> (processor <span class="keyword">instanceof</span> Producer) &#123;</div><div class="line">          camelContext.removeEndpoint(((Producer) processor).getEndpoint());</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (String uri : uris) &#123;</div><div class="line">      <span class="keyword">if</span> (!processorMap.containsKey(uri)) &#123;</div><div class="line">        log.info(String.format(<span class="string">"Adding uri: %s"</span>, uri));</div><div class="line">        String processedUri = uri;</div><div class="line">        <span class="keyword">if</span> (uriPreProcessor != <span class="keyword">null</span>) &#123;</div><div class="line">          processedUri = uriPreProcessor.process(uri);</div><div class="line">        &#125;</div><div class="line">        Processor processor = camelContext.getEndpoint(processedUri).createProducer();</div><div class="line">        processorMap.put(uri, processor);</div><div class="line">        addProcessor(processor);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">LookupCacheListener</span> <span class="keyword">implements</span> <span class="title">CacheEntryCreatedListener</span>&lt;<span class="title">String</span>, <span class="title">Set</span>&lt;<span class="title">String</span>&gt;&gt;,</span></div><div class="line">          <span class="title">CacheEntryUpdatedListener</span>&lt;<span class="title">String</span>, <span class="title">Set</span>&lt;<span class="title">String</span>&gt;&gt;,</div><div class="line">          <span class="title">CacheEntryRemovedListener</span>&lt;<span class="title">String</span>, <span class="title">Set</span>&lt;<span class="title">String</span>&gt;&gt;,</div><div class="line">          <span class="title">CacheEntryExpiredListener</span>&lt;<span class="title">String</span>, <span class="title">Set</span>&lt;<span class="title">String</span>&gt;&gt;,</div><div class="line">          <span class="title">Serializable</span> &#123;</div><div class="line"></div><div class="line">    <span class="comment">// All listener methods removed for brevity. They just delegate to the onEvent method anyway.</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(Iterable&lt;CacheEntryEvent&lt;? extends String, ? extends Set&lt;String&gt;&gt;&gt; events)</span> <span class="keyword">throws</span> CacheEntryListenerException </span>&#123;</div><div class="line">      <span class="keyword">for</span> (CacheEntryEvent&lt;? extends String, ? extends Set&lt;String&gt;&gt; event : events) &#123;</div><div class="line">        log.debug(String.format(<span class="string">"Got a cache event: %s"</span>, event));</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          processUris(event.getValue());</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> CacheEntryListenerException(e);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">LookupCacheListenerFactory</span> <span class="keyword">implements</span> <span class="title">Factory</span>&lt;<span class="title">LookupCacheListener</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> LookupCacheListener <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> LookupCacheListener();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>You can see that it’s just delegating most of the methods (ie, the <code>addProcessor</code>, <code>getProcessor</code>, and <code>removeProcessor</code> methods) to whatever existing implementation that it’s decorating. The actual methods that do the load-balancing (ie, the <code>process</code> methods) do a little bit of work, but end up just delegating as well. So I didn’t actually have to do any algorithm work and I still get to use all the existing strategies. Pretty neat!</p><p>In addition to a delegate <code>LoadBalancer</code> implementation, this class expects that you will give it a fully-configured jCache instance. In my example, I used Infinispan. But I could have just as easily used any other spec compliant implementation. Here’s my Infinispan configuration:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">infinispan</span> <span class="attr">xmlns</span>=<span class="string">"..."</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">jgroups</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">stack-file</span> <span class="attr">name</span>=<span class="string">"external-file"</span> <span class="attr">path</span>=<span class="string">"default-configs/default-jgroups-tcp.xml"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">jgroups</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">cache-container</span> <span class="attr">default-cache</span>=<span class="string">"default"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">local-cache</span> <span class="attr">name</span>=<span class="string">"registry-cache"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">transport</span> <span class="attr">cluster</span>=<span class="string">"registry-cluster"</span> <span class="attr">stack</span>=<span class="string">"external-file"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">replicated-cache</span> <span class="attr">name</span>=<span class="string">"registry-cache"</span> <span class="attr">mode</span>=<span class="string">"SYNC"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">cache-container</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">infinispan</span>&gt;</span></div></pre></td></tr></table></figure><p>Now let’s get to the part that’s actually doing some work. The <code>LookupCacheListener</code> class just implements the various <code>CacheListener</code> interfaces from the jCache API. If it gets any events on the cache entry containing our endpoints, it simply updates the delegate’s internal list of processors. So as services come and go they can register their URIs in the cache, our listener will be notified, and our list of available load-balancer endpoints will be updated.</p><p>The final piece to discuss for this load-balancer implementation is the <code>UriPreProcessor</code>. This is an interface that I created to allow an implementation to customize the URI in some way before adding it to the list. The idea is that other services that are registering themselves might not know that they’re going to be invoked from a Camel endpoint. So they likely won’t add options like <code>bridgeEndpoint=true</code> to the URI. An implementation of this interface would allow you to add such options on their behalf. Here’s the interface itself:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.apache.camel.processor.loadbalancer;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UriPreProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">process</span><span class="params">(String uri)</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>And here’s a sample implementation that adds the options:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.jboss.poc.greeter.camel;</div><div class="line"></div><div class="line"><span class="comment">// Import statements removed for brevity.</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GreeterServiceUriPreProcessor</span> <span class="keyword">implements</span> <span class="title">UriPreProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">process</span><span class="params">(String uri)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Map&lt;String, Object&gt; options = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    options.put(<span class="string">"bridgeEndpoint"</span>, <span class="keyword">true</span>);</div><div class="line">    <span class="keyword">return</span> URISupport.appendParametersToURI(uri, options);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>Now all that’s left is to actually use it in my Camel routes. To do so, I declare it just like any other bean. Then I use the <code>custom</code> element in my <code>loadBalance</code> to <code>ref</code> it. Looks something like this:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"..."</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"cachingProvider"</span></span></div><div class="line">        <span class="attr">class</span>=<span class="string">"javax.cache.Caching"</span> <span class="attr">factory-method</span>=<span class="string">"getCachingProvider"</span>/&gt;</div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"cacheManager"</span></span></div><div class="line">        <span class="attr">factory-bean</span>=<span class="string">"cachingProvider"</span> <span class="attr">factory-method</span>=<span class="string">"getCacheManager"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"META-INF/infinispan/infinispan-clustered.xml"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.util.ClassUtils"</span></span></div><div class="line">            <span class="attr">factory-method</span>=<span class="string">"getDefaultClassLoader"</span>/&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"registryCache"</span></span></div><div class="line">        <span class="attr">factory-bean</span>=<span class="string">"cacheManager"</span> <span class="attr">factory-method</span>=<span class="string">"getCache"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"registry-cache"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jCacheLoadBalancer"</span></span></div><div class="line">        <span class="attr">class</span>=<span class="string">"org.apache.camel.processor.loadbalancer.JCacheLoadBalancer"</span></div><div class="line">        <span class="attr">init-method</span>=<span class="string">"start"</span> <span class="attr">destroy-method</span>=<span class="string">"stop"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"registry"</span> <span class="attr">ref</span>=<span class="string">"registryCache"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"groupId"</span></span></div><div class="line">              <span class="attr">value</span>=<span class="string">"/services/soap-http/&#123;http://poc.jboss.org/greeter&#125;GreeterService"</span>/&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"delegate"</span> <span class="attr">ref</span>=<span class="string">"randomLoadBalancer"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"uriPreProcessor"</span> <span class="attr">ref</span>=<span class="string">"greeterServiceUriPreProcessor"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"greeterServiceUriPreProcessor"</span></span></div><div class="line">        <span class="attr">class</span>=<span class="string">"org.jboss.poc.greeter.camel.GreeterServiceUriPreProcessor"</span>/&gt;</div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"randomLoadBalancer"</span></span></div><div class="line">        <span class="attr">class</span>=<span class="string">"org.apache.camel.processor.loadbalancer.RandomLoadBalancer"</span>/&gt;</div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">camelContext</span> <span class="attr">id</span>=<span class="string">"greeterGateway"</span></span></div><div class="line">                <span class="attr">trace</span>=<span class="string">"false"</span> <span class="attr">xmlns</span>=<span class="string">"http://camel.apache.org/schema/spring"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">route</span> <span class="attr">id</span>=<span class="string">"proxyRoute"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">from</span> <span class="attr">uri</span>=<span class="string">"jetty:http://localhost:9000/gateway/GreeterService?matchOnUriPrefix=true&amp;amp;bridgeEndpoint=true"</span>/&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">onException</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">exception</span>&gt;</span>org.apache.camel.processor.loadbalancer.LoadBalancerUnavailableException<span class="tag">&lt;/<span class="name">exception</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">handled</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">constant</span>&gt;</span>true<span class="tag">&lt;/<span class="name">constant</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">handled</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">setHeader</span> <span class="attr">headerName</span>=<span class="string">"CamelHttpResponseCode"</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">constant</span>&gt;</span>404<span class="tag">&lt;/<span class="name">constant</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">setHeader</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">setBody</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">constant</span>&gt;</span>NOT FOUND<span class="tag">&lt;/<span class="name">constant</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">setBody</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">onException</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">loadBalance</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">custom</span> <span class="attr">ref</span>=<span class="string">"jCacheLoadBalancer"</span>/&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">loadBalance</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">route</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;/<span class="name">camelContext</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure><p>That’s it for the Camel side of things. Now let’s discuss how to get some services registered.</p><p>In my example, I just created a simple JAX-WS service in JBoss WildFly. Here’s the code so you can see how simple it is:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.jboss.poc.greeter.impl;</div><div class="line"></div><div class="line"><span class="comment">// Import statements removed for brevity.</span></div><div class="line"></div><div class="line"><span class="meta">@WebService</span>(endpointInterface = <span class="string">"org.jboss.poc.greeter.Greeter"</span>,</div><div class="line">            serviceName = <span class="string">"GreeterService"</span>,</div><div class="line">            portName = <span class="string">"GreeterServicePort"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnglishGreeter</span> <span class="keyword">implements</span> <span class="title">Greeter</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getGreeting</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">    String greeting = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      greeting = String.format(<span class="string">"Hello %s from %s!"</span>, name, InetAddress.getLocalHost().getHostAddress());</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      greeting = String.format(<span class="string">"Hello %s! I was unable to find my IP :(..."</span>, name);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> greeting;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>For this service, I created a <code>ServletContextListener</code> to register/unregister it’s URI to/from the jCache.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.jboss.poc.greeter.impl;</div><div class="line"></div><div class="line"><span class="comment">// Import statements removed for brevity.</span></div><div class="line"></div><div class="line"><span class="meta">@WebListener</span>()</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GreeterServiceRegistrar</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVICE_NAMESPACE = <span class="string">"http://poc.jboss.org/greeter"</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVICE_NAME = <span class="string">"GreeterService"</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGISTRY_CACHE_NAME = <span class="string">"registry-cache"</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(GreeterServiceRegistrar.class);</div><div class="line"></div><div class="line">  <span class="meta">@Inject</span></div><div class="line">  <span class="keyword">private</span> DefaultCacheManager cacheManager;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent sce)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> String key = getServiceKey();</div><div class="line">    <span class="keyword">final</span> String uri = getServiceURI(sce);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (cacheManager != <span class="keyword">null</span>) &#123;</div><div class="line">      log.info(String.format(<span class="string">"Registering service: &#123;'%s': '%s'&#125;"</span>, key, uri));</div><div class="line"></div><div class="line">      Cache&lt;String, Set&lt;String&gt;&gt; cache = cacheManager.getCache(REGISTRY_CACHE_NAME);</div><div class="line">      Set&lt;String&gt; uris = cache.getOrDefault(key, <span class="keyword">new</span> HashSet&lt;String&gt;());</div><div class="line">      uris.add(uri);</div><div class="line">      cache.put(key, uris);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      log.warn(String.format(<span class="string">"Unable to register service: &#123;'%s': '%s'&#125;. CacheManager is null."</span>, key, uri));</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextDestroyed</span><span class="params">(ServletContextEvent sce)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> String key = getServiceKey();</div><div class="line">    <span class="keyword">final</span> String uri = getServiceURI(sce);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (cacheManager != <span class="keyword">null</span>) &#123;</div><div class="line">      log.info(String.format(<span class="string">"Unregistering service: &#123;'%s': '%s'&#125;"</span>, key, uri));</div><div class="line">      Cache&lt;String, Set&lt;String&gt;&gt; cache = cacheManager.getCache(REGISTRY_CACHE_NAME);</div><div class="line">      Set&lt;String&gt; uris = cache.getOrDefault(key, <span class="keyword">new</span> HashSet&lt;String&gt;());</div><div class="line">      uris.remove(uri);</div><div class="line">      cache.put(key, uris);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      log.warn(String.format(<span class="string">"Unable to unregister service: &#123;'%s': '%s'&#125;. CacheManager is null."</span>, key, uri));</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> String <span class="title">getServiceKey</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// Contents removed for brevity. Method forms and returns the cache key where we'll store our URIs.</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> String <span class="title">getServiceURI</span><span class="params">(ServletContextEvent sce)</span> </span>&#123;</div><div class="line">    <span class="comment">// Contents removed for brevity. Method grabs the current IP and port that the server is bound to and forms a URI.</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>So now when my <code>ServletContext</code> is started, my JAX-WS service URI will be registered. And when it is stopped, my URI will be removed. Since I configured my Infinispan cache the same on both the JBoss WildFly and Camel sides, the local cache instances are connected and will receive events and updates.</p><p>That’s it! If you want to give it a go, check out the full source code at <a href="https://github.com/joshdreagan/infinispan-discovery" target="_blank" rel="noopener">https://github.com/joshdreagan/infinispan-discovery</a>. Hopefully it’s useful…</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Apache Camel is a pretty full-featured EIP implementation framework. It has several existing strategies for load-balancing right out of the box. Round Robin, Random, Sticky, Weighted Round Robin, Weighted Random,… the list goes on and on. But being that it’s a very well written and pluggable framework, it also gives you the ability to drop in your own custom strategies should you find that none of the existing ones meet your specific needs. So for this post, I created a custom Camel Load Balancer implementation utilizing an Infinispan cache to dynamically discover and load-balance between destination endpoints.&lt;br&gt;
    
    </summary>
    
    
      <category term="camel" scheme="http://blog.joshdreagan.com/tags/camel/"/>
    
      <category term="wildfly" scheme="http://blog.joshdreagan.com/tags/wildfly/"/>
    
      <category term="infinispan" scheme="http://blog.joshdreagan.com/tags/infinispan/"/>
    
  </entry>
  
  <entry>
    <title>Correcting Malformed Data With Fuse+BPMS</title>
    <link href="http://blog.joshdreagan.com/2015/10/30/correcting_data_with_fuse_and_bpms/"/>
    <id>http://blog.joshdreagan.com/2015/10/30/correcting_data_with_fuse_and_bpms/</id>
    <published>2015-10-30T06:00:00.000Z</published>
    <updated>2016-08-01T21:00:45.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="The-Problem"><a href="#The-Problem" class="headerlink" title="The Problem"></a>The Problem</h2><p>In many environments, it is common to ingest data as a batch process. This is usually accomplished by polling a directory (or FTP server) for files. The issue is that polling for files is a one-way communication. So if you get a file that you can’t parse (or one that is invalid for any other reason), you have no way of communicating that back to the original sender. How do you handle the error? You likely can’t just drop the data on the floor. That really only leaves one option and that is to correct the data and re-ingest it.<br><a id="more"></a></p><h2 id="The-Solution"><a href="#The-Solution" class="headerlink" title="The Solution"></a>The Solution</h2><p>So we need to manually correct the data. We could create our own state machine to walk through the steps for correction. But we’d need to create a task queue, handle locking/timeouts, and create some UIs to allow the users to pull up the data and fix it. Also, we’ll probably want to restrict access to some group (like “analyst”), and since the task will likely be long-running we’ll want to create a set of UIs that allow operators to view the current state. All of this requires a significant amount of effort to complete (and is quite difficult to get right).</p><p>Or… we could just use BPMS which already does all of that for us.</p><p>Take a look at the <a href="https://github.com/joshdreagan/mdfu" target="_blank" rel="noopener">Malformed Data Fixer-Upper</a> project on GitHub. Follow the instructions in the <a href="https://github.com/joshdreagan/mdfu/blob/master/README.md" target="_blank" rel="noopener">README.md</a> file to get it up and running.</p><p>This example is a bit contrived, but it illustrates the general pattern that you might follow. Basically, Fuse is used to poll for files and validate them. If they are found to be invalid, Fuse will invoke a jBPM process with a <em>Human Task</em> node. Once a human corrects the data, it will be passed back to Fuse to be validated/processed again. The interaction between Fuse and BPMS is done via SOAP/HTTP. So BPMS hosts a web service and Fuse hosts a callback web service. The following diagram shows the interaction in more detail (including what data is passed).</p><img src="/2015/10/30/correcting_data_with_fuse_and_bpms/async.png" title="[figure-1.1]">]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;The-Problem&quot;&gt;&lt;a href=&quot;#The-Problem&quot; class=&quot;headerlink&quot; title=&quot;The Problem&quot;&gt;&lt;/a&gt;The Problem&lt;/h2&gt;&lt;p&gt;In many environments, it is common to ingest data as a batch process. This is usually accomplished by polling a directory (or FTP server) for files. The issue is that polling for files is a one-way communication. So if you get a file that you can’t parse (or one that is invalid for any other reason), you have no way of communicating that back to the original sender. How do you handle the error? You likely can’t just drop the data on the floor. That really only leaves one option and that is to correct the data and re-ingest it.&lt;br&gt;
    
    </summary>
    
    
      <category term="fuse" scheme="http://blog.joshdreagan.com/tags/fuse/"/>
    
      <category term="camel" scheme="http://blog.joshdreagan.com/tags/camel/"/>
    
      <category term="jboss" scheme="http://blog.joshdreagan.com/tags/jboss/"/>
    
      <category term="karaf" scheme="http://blog.joshdreagan.com/tags/karaf/"/>
    
      <category term="cxf" scheme="http://blog.joshdreagan.com/tags/cxf/"/>
    
      <category term="jbpm" scheme="http://blog.joshdreagan.com/tags/jbpm/"/>
    
      <category term="bpms" scheme="http://blog.joshdreagan.com/tags/bpms/"/>
    
  </entry>
  
  <entry>
    <title>Fuse Fabric Offline CI/CD</title>
    <link href="http://blog.joshdreagan.com/2015/08/04/fuse_fabric_offline_ci__cd/"/>
    <id>http://blog.joshdreagan.com/2015/08/04/fuse_fabric_offline_ci__cd/</id>
    <published>2015-08-04T06:00:00.000Z</published>
    <updated>2016-08-01T21:00:45.000Z</updated>
    
    <content type="html"><![CDATA[<p>This is a follow-on to the <a href="http://blog.christianposta.com/fabric8/fuse-fabric-profile-migration-for-continuous-delivery/" target="_blank" rel="noopener">excellent blog post</a> that my colleague Christian Posta wrote on doing CI/CD with Fuse Fabric. In particular, this post will extend upon his write-up by showing how to migrate Fabric8 profiles and Maven artifacts into environments which are disconnected from the development environment.<br><a id="more"></a></p><blockquote><p>The sample code for this blog can be found at <a href="https://github.com/joshdreagan/fuse-fabric-promotion-build" target="_blank" rel="noopener">https://github.com/joshdreagan/fuse-fabric-promotion-build</a>. This is just a forked version of <a href="/home/jreagan/Development/Projects/joshdreagan/joshdreagan.github.io/_posts/2015-08-04-fuse_fabric_offline_ci__cd.markdown">Christian’s original sample code</a> with the changes outlined below.</p></blockquote><p>Most of the steps and information found in <a href="http://blog.christianposta.com/fabric8/fuse-fabric-profile-migration-for-continuous-delivery/" target="_blank" rel="noopener">Christian’s original blog post</a> are still relevant. In fact, all of the steps leading up to the “<strong>Environment build</strong>“ and it’s use of the Fabric8 Maven Plugin’s “<em>branch</em>“ goal are exactly the same.</p><h2 id="The-Problem"><a href="#The-Problem" class="headerlink" title="The Problem"></a>The Problem</h2><p>The issue with the “<em>branch</em>“ goal is that it assumes connectivity to a running Fabric8 ensemble so that it can directly branch it’s internal Git repo and upload the profile zips. In addition, the Fabric8 machines will also need connectivity back to the Maven repository (ie, Nexus or Artifactory) where the artifacts are stored so that it can pull them all down and install them once the profile is applied to a container. This is not always feasible due to the fact that some companies will restrict connectivity between environments.</p><p>For many companies, it is very common that there will be restricted access between development and production environments due to various security constraints. Furthermore, some production environments (ie, defense and classified networks) will have absolutely no access whatsoever to the development environment or even to the internet. Therefore, it will often be necessary to package and transfer all the necessary Fabric8 profile zips and Maven artifacts via a completely offline (and usually read-only) media like a CD-R. This will of course limit the amount of automation that you can achieve, but can easily be accomplished with a few extra steps.</p><h2 id="The-Solution"><a href="#The-Solution" class="headerlink" title="The Solution"></a>The Solution</h2><p>The simplest solution is to build a zip file containing everything we need so that we will require no outside access during installation. This can easily be accomplished using the Maven Assembly Plugin. Once we have the zip file, we can transfer it to the target environments, unzip it, import our Fabric8 profiles, and proceed with our installation. Since all the artifacts are included, installation/provisioning should proceed as smoothly as if we were connected to the internet.</p><h2 id="Modify-the-Environment-build"><a href="#Modify-the-Environment-build" class="headerlink" title="Modify the Environment build"></a>Modify the Environment build</h2><p>The first step is to modify the “<strong>Environment build</strong>“ by adding a Maven Assembly Plugin configuration.</p><p>Add the following Maven Assembly Plugin configuration to your project:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">attach</span>&gt;</span>false<span class="tag">&lt;/<span class="name">attach</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">descriptors</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">descriptor</span>&gt;</span>src/assembly/repository.xml<span class="tag">&lt;/<span class="name">descriptor</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">descriptors</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div></pre></td></tr></table></figure><p>Make sure to set the “<em>attach</em>“ configuration to <code>false</code>. Failure to do so could result in the zip file (which could be quite large) being inadvertently uploaded to your Maven repository. Next, you’ll need to define the assembly descriptor as follows:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">assembly</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.3"</span></span></div><div class="line">          <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">          <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.3 http://maven.apache.org/xsd/assembly-1.1.3.xsd"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>repository<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">formats</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">format</span>&gt;</span>zip<span class="tag">&lt;/<span class="name">format</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">formats</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">includeBaseDirectory</span>&gt;</span>false<span class="tag">&lt;/<span class="name">includeBaseDirectory</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">includeMetadata</span>&gt;</span>true<span class="tag">&lt;/<span class="name">includeMetadata</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">assembly</span>&gt;</span></div></pre></td></tr></table></figure><p>You can optionally add an “<em>execution</em>“ for the Maven Assembly Plugin and bind it to a lifecycle. I prefer to invoke it directly as follows:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn assembly:single</div></pre></td></tr></table></figure><p>The output should be a zip file containing an offline Maven repository with all of the Fabric8 profile zips as well as the required Maven dependencies. You can now download/transfer that zip file via whatever means you have available to your target environment.</p><p>Once you’ve transferred the zip file, you simply unzip it into the “~/.m2/repository” folder on each of the Fabric ensemble machines. <strong>Make sure to place it in the user home of the user that runs the Fuse instances.</strong> You can then import the Fabric8 profile zips with the following Karaf CLI commands:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">fabric:profile-import --version 1.1 mvn:com.redhat.demo.promotion/eip/2.0/zip/profile</div><div class="line">fabric:profile-import --version 1.1 mvn:com.redhat.demo.promotion/rest/1.5/zip/profile</div></pre></td></tr></table></figure><p>Since the profile zips now exist in the “~/.m2/repository” folder, they will be discovered and installed by the Fabric Maven Proxy without needing to go online.</p><p>Once you apply the profiles to a container (or upgrade a container to the new version), the provisioned container instances will reach back to the Fabric ensemble to retrieve the necessary Maven artifacts. Similarly to the profile zips, they will be discovered and installed by the Fabric Maven Proxy from its “~/.m2/repository” folder and will be transferred over without ever needing to go online.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;This is a follow-on to the &lt;a href=&quot;http://blog.christianposta.com/fabric8/fuse-fabric-profile-migration-for-continuous-delivery/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;excellent blog post&lt;/a&gt; that my colleague Christian Posta wrote on doing CI/CD with Fuse Fabric. In particular, this post will extend upon his write-up by showing how to migrate Fabric8 profiles and Maven artifacts into environments which are disconnected from the development environment.&lt;br&gt;
    
    </summary>
    
    
      <category term="fuse" scheme="http://blog.joshdreagan.com/tags/fuse/"/>
    
      <category term="camel" scheme="http://blog.joshdreagan.com/tags/camel/"/>
    
      <category term="jboss" scheme="http://blog.joshdreagan.com/tags/jboss/"/>
    
      <category term="karaf" scheme="http://blog.joshdreagan.com/tags/karaf/"/>
    
      <category term="cxf" scheme="http://blog.joshdreagan.com/tags/cxf/"/>
    
      <category term="fabric8" scheme="http://blog.joshdreagan.com/tags/fabric8/"/>
    
  </entry>
  
  <entry>
    <title>Connecting FeedHenry to Fuse REST Quickstart</title>
    <link href="http://blog.joshdreagan.com/2015/05/08/connecting_feedhenry_to_fuse_rest_quickstart/"/>
    <id>http://blog.joshdreagan.com/2015/05/08/connecting_feedhenry_to_fuse_rest_quickstart/</id>
    <published>2015-05-08T06:00:00.000Z</published>
    <updated>2016-08-01T21:00:45.000Z</updated>
    
    <content type="html"><![CDATA[<p>This guide demonstrates step-by-step how to connect a FeedHenry Hello World application to a JBoss Fuse REST quickstart backend running on Red Hat’s OpenShift Online.<br><a id="more"></a></p><p>Here are a few assumptions before you begin:</p><ul><li><a href="/2015/05/07/getting_started__feedhenry_hello_world/" title="You've already completed the guide in my previous blog about creating a FeedHenry Hello World project">You've already completed the guide in my previous blog about creating a FeedHenry Hello World project</a></li><li><a href="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/" title="You've already completed the guide in my previous blog about creating a Fuse REST quickstart project on OpenShift">You've already completed the guide in my previous blog about creating a Fuse REST quickstart project on OpenShift</a></li></ul><p>Once you’ve completed the prerequisite blog guides, connecting the two is a simple matter of modifying a few files. You can even use the browser based editor so you can do everything online.</p><p>Log into your FeedHenry domain and find your previously created Hello World project.</p><img src="/2015/05/08/connecting_feedhenry_to_fuse_rest_quickstart/explore_project.png" title="[Explore Project]"><h1 id="Step-1-Modify-the-Hello-World-Cloud-App"><a href="#Step-1-Modify-the-Hello-World-Cloud-App" class="headerlink" title="Step 1: Modify the Hello World Cloud App"></a>Step 1: Modify the Hello World Cloud App</h1><p>First, you’ll modify the cloud app files. Click on the “<strong>Cloud App</strong>“ panel shown below.</p><img src="/2015/05/08/connecting_feedhenry_to_fuse_rest_quickstart/explore_project_cloud_code.png" title="[Explore Project]"><p>Next, click on the “<strong>Editor</strong>“ button in the column on the left.</p><img src="/2015/05/08/connecting_feedhenry_to_fuse_rest_quickstart/explore_project_cloud_code_editor_button.png" title="[Explore Project]"><p>Edit the <code>/package.json</code> file and add a dependency for “<em>xml2js</em>“ version “<em>~0.4.8</em>“ to the end of the <em>dependencies</em> section. If you’d like, you can copy/paste the entire contents from the text below.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"name"</span>: <span class="string">"fh-app"</span>,</div><div class="line">  <span class="attr">"version"</span>: <span class="string">"0.2.0"</span>,</div><div class="line">  <span class="attr">"dependencies"</span>: &#123;</div><div class="line">    <span class="attr">"body-parser"</span>: <span class="string">"~1.0.2"</span>,</div><div class="line">    <span class="attr">"cors"</span>: <span class="string">"~2.2.0"</span>,</div><div class="line">    <span class="attr">"express"</span>: <span class="string">"~4.0.0"</span>,</div><div class="line">    <span class="attr">"fh-mbaas-api"</span>: <span class="string">"~4.9.0"</span>,</div><div class="line">    <span class="attr">"mocha"</span>: <span class="string">"^2.1.0"</span>,</div><div class="line">    <span class="attr">"request"</span>: <span class="string">"~2.40.0"</span>,</div><div class="line">    <span class="attr">"xml2js"</span>: <span class="string">"~0.4.8"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"devDependencies"</span>: &#123;</div><div class="line">    <span class="attr">"grunt-contrib-watch"</span>: <span class="string">"latest"</span>,</div><div class="line">    <span class="attr">"grunt-nodemon"</span>: <span class="string">"0.2.0"</span>,</div><div class="line">    <span class="attr">"grunt-concurrent"</span>: <span class="string">"latest"</span>,</div><div class="line">    <span class="attr">"supertest"</span>: <span class="string">"0.8.2"</span>,</div><div class="line">    <span class="attr">"should"</span>: <span class="string">"2.1.1"</span>,</div><div class="line">    <span class="attr">"proxyquire"</span>: <span class="string">"0.5.3"</span>,</div><div class="line">    <span class="attr">"grunt-shell"</span>: <span class="string">"0.6.4"</span>,</div><div class="line">    <span class="attr">"istanbul"</span>: <span class="string">"0.2.7"</span>,</div><div class="line">    <span class="attr">"grunt-env"</span>: <span class="string">"~0.4.1"</span>,</div><div class="line">    <span class="attr">"load-grunt-tasks"</span>: <span class="string">"~0.4.0"</span>,</div><div class="line">    <span class="attr">"time-grunt"</span>: <span class="string">"~0.3.1"</span>,</div><div class="line">    <span class="attr">"grunt-node-inspector"</span>: <span class="string">"~0.1.5"</span>,</div><div class="line">    <span class="attr">"grunt-open"</span>: <span class="string">"~0.2.3"</span>,</div><div class="line">    <span class="attr">"grunt-plato"</span>: <span class="string">"~1.0.0"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"main"</span>: <span class="string">"application.js"</span>,</div><div class="line">  <span class="attr">"scripts"</span>: &#123;</div><div class="line">    <span class="attr">"test"</span>: <span class="string">"grunt test"</span>,</div><div class="line">    <span class="attr">"debug"</span>: <span class="string">"grunt serve"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"license"</span>: <span class="string">"mit"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>Next, edit the <code>/lib/hello.js</code> file and replace its contents with the text below. <strong>Make sure to replace the <em>uri</em> field in both the <em>get</em> and <em>post</em> methods with the URI to your Fuse REST quickstart that you created in the previous guide.</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</div><div class="line"><span class="keyword">var</span> cors = <span class="built_in">require</span>(<span class="string">'cors'</span>);</div><div class="line"><span class="keyword">var</span> request = <span class="built_in">require</span>(<span class="string">'request'</span>);</div><div class="line"><span class="keyword">var</span> xml2js = <span class="built_in">require</span>(<span class="string">'xml2js'</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">helloRoute</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> hello = <span class="keyword">new</span> express.Router();</div><div class="line">  hello.use(cors());</div><div class="line">  hello.use(bodyParser());</div><div class="line"></div><div class="line">  hello.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">Date</span>(), <span class="string">'In hello route GET / req.query='</span>, req.query);</div><div class="line">    <span class="keyword">var</span> id = req.query &amp;&amp; req.query.hello ? req.query.hello : <span class="string">'000'</span>;</div><div class="line">    request(&#123;uri: <span class="string">'http://restchild-joshdreagan.rhcloud.com/cxf/crm/customerservice/customers/'</span> + id,</div><div class="line">             method: <span class="string">"GET"</span>&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">error, response, body</span>) </span>&#123;</div><div class="line">        xml2js.parseString(body, <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</div><div class="line">          <span class="keyword">var</span> name = result.Customer.name[<span class="number">0</span>];</div><div class="line">          res.json(&#123;msg: <span class="string">'Hello '</span> + name&#125;);</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  hello.post(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">Date</span>(), <span class="string">'In hello route POST / req.body='</span>, req.body);</div><div class="line">    <span class="keyword">var</span> id = req.body &amp;&amp; req.body.hello ? req.body.hello : <span class="string">'000'</span>;</div><div class="line">    request(&#123;uri: <span class="string">'http://restchild-joshdreagan.rhcloud.com/cxf/crm/customerservice/customers/'</span> + id,</div><div class="line">             method: <span class="string">"GET"</span>&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">error, response, body</span>) </span>&#123;</div><div class="line">        xml2js.parseString(body, <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</div><div class="line">          <span class="keyword">var</span> name = result.Customer.name[<span class="number">0</span>];</div><div class="line">          res.json(&#123;msg: <span class="string">'Hello '</span> + name&#125;);</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> hello;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = helloRoute;</div></pre></td></tr></table></figure><p>Finally, edit the <code>/README.md</code> file and change the sample request body to “<em>123</em>“ instead of “<em>world</em>“. If you’d like, you can copy/paste the entire contents from the text below. <em>This step is optional, but is nice to do since it will allow you to test directly from the “<strong>Docs</strong>“ page.</em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"># FeedHenry Hello World MBaaS Server</div><div class="line"></div><div class="line">This is a blank &apos;hello world&apos; FeedHenry MBaaS. Use it as a starting point for building your APIs. </div><div class="line"></div><div class="line"># Group Hello World API</div><div class="line"></div><div class="line"># hello [/hello]</div><div class="line"></div><div class="line">&apos;Hello world&apos; endpoint.</div><div class="line"></div><div class="line">## hello [POST] </div><div class="line"></div><div class="line">&apos;Hello world&apos; endpoint.</div><div class="line"></div><div class="line">+ Request (application/json)</div><div class="line">    + Body</div><div class="line">            &#123;</div><div class="line">              &quot;hello&quot;: &quot;123&quot;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">+ Response 200 (application/json)</div><div class="line">    + Body</div><div class="line">            &#123;</div><div class="line">              &quot;msg&quot;: &quot;Hello world&quot;</div><div class="line">            &#125;</div></pre></td></tr></table></figure><p>Now, save all of the files and click on the “<strong>Deploy</strong>“ button in the column on the left.</p><img src="/2015/05/08/connecting_feedhenry_to_fuse_rest_quickstart/cloud_code_deploy_button.png" title="[Deploy Project]"><p>That should bring you to the “<strong>Deploy</strong>“ page. Click on the “<strong>Deploy Cloud App</strong>“ button.</p><img src="/2015/05/08/connecting_feedhenry_to_fuse_rest_quickstart/cloud_code_deploy_page.png" title="[Deploy Project]"><p>Deployment should take less than 1 minute. You will be shown a progress bar and status text box.</p><img src="/2015/05/08/connecting_feedhenry_to_fuse_rest_quickstart/cloud_code_deploy_in_progress.png" title="[Deploy Project]"><p>When the deploy process is complete, you will see a green progress bar and no errors in the status text box.</p><img src="/2015/05/08/connecting_feedhenry_to_fuse_rest_quickstart/cloud_code_deploy_success.png" title="[Deploy Project]"><p>Once everything deploys successfully, you can click on the “<strong>Docs</strong>“ button in the column on the left.</p><img src="/2015/05/08/connecting_feedhenry_to_fuse_rest_quickstart/cloud_code_docs_button.png" title="[Test Project]"><p>This will take you to the test page for your app. It should look like the picture below.</p><img src="/2015/05/08/connecting_feedhenry_to_fuse_rest_quickstart/cloud_code_test_page.png" title="[Test Project]"><p>Click on the “<strong>Try it!</strong>“ button to expand the <em>request</em> &amp; <em>response</em> text boxes.</p><img src="/2015/05/08/connecting_feedhenry_to_fuse_rest_quickstart/cloud_code_test_page_request.png" title="[Test Project]"><p>Click on the “<strong>Submit</strong>“ button to invoke the service. You should see a successful response like the one pictured below.</p><img src="/2015/05/08/connecting_feedhenry_to_fuse_rest_quickstart/cloud_code_test_page_response.png" title="[Test Project]"><h1 id="Step-2-Modify-The-Hello-World-Cordova-Light-App"><a href="#Step-2-Modify-The-Hello-World-Cordova-Light-App" class="headerlink" title="Step 2: Modify The Hello World Cordova Light App"></a>Step 2: Modify The Hello World Cordova Light App</h1><p>Now, you’ll modify the Cordova application files. Click on the “<strong>Cordova Light App</strong>“ panel shown below.</p><img src="/2015/05/08/connecting_feedhenry_to_fuse_rest_quickstart/explore_project_apps.png" title="[Explore Project]"><p>Next, click on the “<strong>Editor</strong>“ button in the column on the left.</p><img src="/2015/05/08/connecting_feedhenry_to_fuse_rest_quickstart/explore_project_apps_editor_button.png" title="[Explore Project]"><p>Edit the <code>/www/index.html</code> file and replace the placeholder text for the input box with “<em>Enter Your ID Here.</em>“. If you’d like, you can copy/paste the entire contents from the text below.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1, user-scalable=no"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello World<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"css/app.css"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">header</span> <span class="attr">class</span>=<span class="string">"header-footer-bg"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"center"</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">h3</span>&gt;</span>FeedHenry</div><div class="line">              <span class="tag">&lt;<span class="name">small</span>&gt;</span>QuickStart - HTML5<span class="tag">&lt;/<span class="name">small</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">h3</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">header</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"count"</span> <span class="attr">class</span>=<span class="string">""</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"formWrapper"</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"description"</span>&gt;</span>This is a basic Javascript App that can take in your name, send it to a cloud app and display the response.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line"></div><div class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-div"</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"hello_to"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"input-text"</span> <span class="attr">placeholder</span>=<span class="string">"Enter Your ID Here."</span>/&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"></div><div class="line">          <span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line"></div><div class="line">          <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"say_hello"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"say-hello-button"</span>&gt;</span>Say Hello From The Cloud<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"cloudResponse"</span> <span class="attr">class</span>=<span class="string">"cloudResponse"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"></div><div class="line">      <span class="tag">&lt;<span class="name">footer</span> <span class="attr">class</span>=<span class="string">"header-footer-bg"</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">div</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">small</span> <span class="attr">class</span>=<span class="string">"right"</span>&gt;</span></div><div class="line">                  <span class="comment">&lt;!-- v.&amp;nbsp; --&gt;</span></div><div class="line">              <span class="tag">&lt;/<span class="name">small</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">footer</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"feedhenry.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"hello.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure><p>Don’t forget to save the file. The simulator on the right should automatically update. Don’t worry if it doesn’t. Sometimes it needs a page refresh. However, since the changes we made were purely cosmetic, it doesn’t really matter if you see the update.</p><img src="/2015/05/08/connecting_feedhenry_to_fuse_rest_quickstart/apps_test_sim.png" title="[Test Project]"><p>Enter “<em>123</em>“ into the input box on the simulator and click “<strong>Say Hello From The Cloud</strong>“.</p><img src="/2015/05/08/connecting_feedhenry_to_fuse_rest_quickstart/apps_test_sim_request.png" title="[Test Project]"><p>If everything was successful, you should see a response like the one pictured below.</p><img src="/2015/05/08/connecting_feedhenry_to_fuse_rest_quickstart/apps_test_sim_response.png" title="[Test Project]"><p>Now you’ve successfully wired your FeedHenry Hello World project to a backend Fuse REST quickstart running on OpenShift.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;This guide demonstrates step-by-step how to connect a FeedHenry Hello World application to a JBoss Fuse REST quickstart backend running on Red Hat’s OpenShift Online.&lt;br&gt;
    
    </summary>
    
    
      <category term="fuse" scheme="http://blog.joshdreagan.com/tags/fuse/"/>
    
      <category term="camel" scheme="http://blog.joshdreagan.com/tags/camel/"/>
    
      <category term="jboss" scheme="http://blog.joshdreagan.com/tags/jboss/"/>
    
      <category term="karaf" scheme="http://blog.joshdreagan.com/tags/karaf/"/>
    
      <category term="cxf" scheme="http://blog.joshdreagan.com/tags/cxf/"/>
    
      <category term="feedhenry" scheme="http://blog.joshdreagan.com/tags/feedhenry/"/>
    
      <category term="openshift" scheme="http://blog.joshdreagan.com/tags/openshift/"/>
    
      <category term="fabric8" scheme="http://blog.joshdreagan.com/tags/fabric8/"/>
    
  </entry>
  
  <entry>
    <title>Getting Started - Fuse REST Quickstart on OpenShift</title>
    <link href="http://blog.joshdreagan.com/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/"/>
    <id>http://blog.joshdreagan.com/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/</id>
    <published>2015-05-07T06:00:00.000Z</published>
    <updated>2016-08-01T21:00:45.000Z</updated>
    
    <content type="html"><![CDATA[<p>This guide demonstrates step-by-step how to create a Fuse cluster and deploy one of the quickstart applications using Red Hat’s OpenShift Online infrastructure.<br><a id="more"></a></p><p>The first thing you’ll do is open up a browser and navigate to <a href="https://openshift.redhat.com/" target="_blank" rel="noopener">OpenShift Online</a>. If you don’t already have an account, you can sign up for a free one. However, the free account is restricted to 3 <em>small</em> gears which will not run JBoss Fuse instances. So you will need to upgrade to a paid account to complete this guide.</p><h1 id="Step-1-Create-A-Domain-Namespace"><a href="#Step-1-Create-A-Domain-Namespace" class="headerlink" title="Step 1: Create A Domain/Namespace"></a>Step 1: Create A Domain/Namespace</h1><p>After you’ve created an OpenShift Online account and logged in, you will end up at the landing page.</p><img src="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/landing_page.png" title="[Landing Page]"><p>Before creating any apps, you’ll need to create a domain/namespace. If you already have a domain/namespace, and you’d like to re-use it, you can skip this step. This is a unique identifier that allows you to group applications. Click on the “<strong>Settings</strong>“ tab at the top of the page.</p><img src="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/setting_button.png" title="[Settings Button]"><p>Enter your desired domain/namespace and click the “<strong>Create</strong>“ button.</p><img src="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/create_domain.png" title="[Create Domain Button]"><p>Now you’re ready to create your JBoss Fuse cluster.</p><h1 id="Step-2-Create-A-JBoss-Fuse-Cluster"><a href="#Step-2-Create-A-JBoss-Fuse-Cluster" class="headerlink" title="Step 2: Create A JBoss Fuse Cluster"></a>Step 2: Create A JBoss Fuse Cluster</h1><p>To create a JBoss Fuse cluster, first navigate to the applications page by clicking the “<strong>Applications</strong>“ button at the top of the screen.</p><img src="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/applications_button.png" title="[Applications Button]"><p>If you don’t already have any applications, you will see a link to “<strong>Create your first application now</strong>“ like in the picture below.</p><img src="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/create_application_link.png" title="[Create Application Link]"><p>Click the link and it will begin the “<strong>Create Application</strong>“ workflow. On the first page, you will see a list of available <em>cartridges</em>.</p><img src="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/create_application-01.png" title="[Create Application]"><p>You’ll want to find and click on the “<strong>JBoss Fuse 6.1</strong>“ cartridge pictured below. If you can’t find it, you can use the search box.</p><img src="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/create_application-02.png" title="[Create Application]"><p>Next, you’ll configure the cartridge.</p><img src="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/create_application-03.png" title="[Create Application]"><p>Fill in the “<strong>Public URL</strong>“ field with the desired application name. You’ll notice that it automatically appends your domain/namespace that you created in <strong>Step 1</strong>.</p><img src="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/create_application-04.png" title="[Create Application]"><p>Select the desired “<strong>Gear Size</strong>“. You must use at least a <em>medium</em> sized gear to run the JBoss Fuse cartridge.</p><img src="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/create_application-05.png" title="[Create Application]"><p>When you’re satisfied with your settings, click the “<strong>Create Application</strong>“ button. Be patient, as it might take a minute or so to finish. <strong>Do not navigate away (or refresh) the page!</strong></p><img src="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/create_application-06.png" title="[Create Application]"><p>Once your application has been successfully created, you will be presented with an informational screen like the one shown below. <strong>Make sure to capture this information as you will need it later and there is no way to get it once you’ve left this page!</strong></p><img src="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/create_application-07.png" title="[Create Application]"><h1 id="Step-3-Provision-A-Child-Container"><a href="#Step-3-Provision-A-Child-Container" class="headerlink" title="Step 3: Provision A Child Container"></a>Step 3: Provision A Child Container</h1><p>Now that you have a JBoss Fuse cluster, you can provision a child container with the actual quickstart deployed. Click on the “<strong>Applications</strong>“ tab at the top of the page, and you should see your newly created JBoss Fuse application.</p><img src="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/applications_list.png" title="[Application List]"><p>Click on that application, and it should open up the JBoss Fuse Management Console. You will need to login using the credentials that were displayed for you at the end of <strong>Step 2</strong>.</p><img src="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/fuse_console_login.png" title="[Fuse Console]"><p>After you login, you should see the JBoss Fuse Management Console’s landing page.</p><img src="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/fuse_console_landing_page.png" title="[Fuse Console]"><p>Click on the “<strong>Runtime</strong>“ tab to view the list of servers that are currently part of this cluster.</p><img src="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/fuse_console_runtime_button.png" title="[Fuse Console]"><p>At the moment, there should be only 1 and it is the Fabric Registry server (indicated by the little cloud icon).</p><img src="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/fuse_console_container_list.png" title="[Fuse Console]"><p>Click on the “<strong>Create</strong>“ button toward the top right of the page to begin the “<strong>Create Container</strong>“ workflow.</p><img src="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/fuse_console_create_container_button.png" title="[Fuse Console]"><p>Fill in the desired “<strong>Container Name</strong>“ and “<strong>Gear Size</strong>“ making sure to use at least a <em>medium</em> or larger. You can enter your OpenShift Online credentials and click the “<strong>Login to OpenShift</strong>“ button to have it fill in the “<strong>OpenShift Domain</strong>“ field. Select the “<strong>rest</strong>“ profile under the “<strong>Example / Quickstarts</strong>“ folder.</p><img src="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/fuse_console_create_container-01.png" title="[Fuse Console]"><p>When done, click the “<strong>Create And Start Container</strong>“ button. Be patient, as it might take a minute or so to finish. <strong>Do not navigate away (or refresh) the page!</strong></p><img src="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/fuse_console_create_container-02.png" title="[Fuse Console]"><p>Once the container has been created, you will be redirected back to the “<strong>Containers</strong>“ page. You will notice that there are now 2. One is the Fabric Registry server, and one is hosting your application.</p><img src="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/fuse_console_create_container-03.png" title="[Fuse Console]"><p>Click on the “<strong>APIs</strong>“ tab to view the base URI of the REST service you’ve just deployed. It will be in the “<strong>Location</strong>“ column.</p><img src="/2015/05/07/getting_started__fuse_rest_quickstart_on_openshift/fuse_console_apis.png" title="[Fuse Console]"><h1 id="Step-4-Test-The-Application"><a href="#Step-4-Test-The-Application" class="headerlink" title="Step 4: Test The Application"></a>Step 4: Test The Application</h1><p>Open a browser and navigate to the URI that you discovered in <strong>Step 3</strong>, appending <code>/customerservice/customers/123</code> like in the picture below. If successful, you should see some XML text come back.</p><p>If all went well, you’ve now got a running JBoss Fuse cluster with the REST quickstart deployed to a child instance.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;This guide demonstrates step-by-step how to create a Fuse cluster and deploy one of the quickstart applications using Red Hat’s OpenShift Online infrastructure.&lt;br&gt;
    
    </summary>
    
    
      <category term="fuse" scheme="http://blog.joshdreagan.com/tags/fuse/"/>
    
      <category term="camel" scheme="http://blog.joshdreagan.com/tags/camel/"/>
    
      <category term="jboss" scheme="http://blog.joshdreagan.com/tags/jboss/"/>
    
      <category term="karaf" scheme="http://blog.joshdreagan.com/tags/karaf/"/>
    
      <category term="cxf" scheme="http://blog.joshdreagan.com/tags/cxf/"/>
    
      <category term="openshift" scheme="http://blog.joshdreagan.com/tags/openshift/"/>
    
      <category term="fabric8" scheme="http://blog.joshdreagan.com/tags/fabric8/"/>
    
  </entry>
  
  <entry>
    <title>Getting Started - FeedHenry Hello World</title>
    <link href="http://blog.joshdreagan.com/2015/05/07/getting_started__feedhenry_hello_world/"/>
    <id>http://blog.joshdreagan.com/2015/05/07/getting_started__feedhenry_hello_world/</id>
    <published>2015-05-07T06:00:00.000Z</published>
    <updated>2016-08-01T21:00:45.000Z</updated>
    
    <content type="html"><![CDATA[<p>This guide demonstrates step-by-step how to create and run your first FeedHenry Hello World project.<br><a id="more"></a></p><h1 id="Step-1-Create-A-New-FeedHenry-Project"><a href="#Step-1-Create-A-New-FeedHenry-Project" class="headerlink" title="Step 1: Create A New FeedHenry Project"></a>Step 1: Create A New FeedHenry Project</h1><p>When you log into your FeedHenry domain, you should end up at a landing page like the one pictured below.</p><img src="/2015/05/07/getting_started__feedhenry_hello_world/landing_page.png" title="[Landing Page]"><p>Click on the “<strong>Projects</strong>“ panel to go to the projects page.</p><img src="/2015/05/07/getting_started__feedhenry_hello_world/projects_panel.png" title="[Projects Panel]"><p>You should see all of your existing projects (if you have any). Click on the “<strong>New Project</strong>“ button to create a new project.</p><img src="/2015/05/07/getting_started__feedhenry_hello_world/new_project_button.png" title="[New Project Button]"><p>You should see the “<strong>Hello World Project</strong>“ template toward the top of the list. If you don’t, use the search box to find it.</p><img src="/2015/05/07/getting_started__feedhenry_hello_world/hello_world_project.png" title="[Hello World Project]"><p>Click the “<strong>Choose</strong>“ button to the right to select the template.</p><img src="/2015/05/07/getting_started__feedhenry_hello_world/hello_world_project_choose_button.png" title="[Hello World Project]"><p>Fill in the project name and click the “<strong>Create</strong>“ button.</p><img src="/2015/05/07/getting_started__feedhenry_hello_world/hello_world_project_options.png" title="[Hello World Project]"><p>Your project should begin the creation process. This can take a few minutes and you will be presented with a progress bar and status text box.</p><img src="/2015/05/07/getting_started__feedhenry_hello_world/hello_world_project_status_in_progress.png" title="[Hello World Project]"><p>When your project has been successfully created, you will see the following <em>successful</em> status messages.</p><img src="/2015/05/07/getting_started__feedhenry_hello_world/hello_world_project_status_complete.png" title="[Hello World Project]"><p>Your project is now created and ready to use.</p><h1 id="Step-2-Explore-Your-Project"><a href="#Step-2-Explore-Your-Project" class="headerlink" title="Step 2: Explore Your Project"></a>Step 2: Explore Your Project</h1><p>Now that you have a project, let’s explore the structure a bit. You should see a project landing page similar to the one below.</p><img src="/2015/05/07/getting_started__feedhenry_hello_world/explore_project.png" title="[Explore Project]"><p>Click on the “<strong>Cloud App</strong>“ panel to explore the backend Hello World cloud app.</p><img src="/2015/05/07/getting_started__feedhenry_hello_world/explore_project_cloud_code.png" title="[Explore Project]"><p>You should see the “<strong>Details</strong>“ page for the cloud app. From here you can stop/start the cloud app as well as see other various bits of information such as the host it’s currently running on and which environment it’s running in.</p><img src="/2015/05/07/getting_started__feedhenry_hello_world/explore_project_cloud_code_details.png" title="[Explore Project]"><p>On the left column, click on the “<strong>Editor</strong>“ button.</p><img src="/2015/05/07/getting_started__feedhenry_hello_world/explore_project_cloud_code_editor_button.png" title="[Explore Project]"><p>You should now see the directory structure of the source code for the cloud app. Open up the “<code>/lib/hello.js</code>“ file to view the source that actually does the work for this Hello World project. While you’re at it, click around on some of the other files and take a look at their contents to get an idea of how everything is glued together.</p><img src="/2015/05/07/getting_started__feedhenry_hello_world/explore_project_cloud_code_editor.png" title="[Explore Project]"><p>Now go back to the project’s landing page and click on the “<strong>Cordova Light App</strong>“ panel to explore the mobile app.</p><img src="/2015/05/07/getting_started__feedhenry_hello_world/explore_project_apps.png" title="[Explore Project]"><p>You should see the “<strong>Details</strong>“ page for the mobile app.</p><img src="/2015/05/07/getting_started__feedhenry_hello_world/explore_project_apps_details.png" title="[Explore Project]"><p>From there, you can test the mobile app directly from the web browser. If you’d like to test directly from your phone, you can go to the “<strong>Export</strong>“ page and export/download a copy of the app for your desired platform.</p><h1 id="Step-3-Test-Your-Project"><a href="#Step-3-Test-Your-Project" class="headerlink" title="Step 3: Test Your Project"></a>Step 3: Test Your Project</h1><p>Now that you have a project, and you’ve explored the structure a bit, let’s run a quick test using the browser based device simulator. Enter your name into the input box and click “<strong>Say Hello From The Cloud</strong>“.</p><img src="/2015/05/07/getting_started__feedhenry_hello_world/test_project.png" title="[Test Project]"><p>You should see results similar to those pictured below.</p><img src="/2015/05/07/getting_started__feedhenry_hello_world/test_project_result.png" title="[Test Project]"><p>That’s it! You’ve successfully created and tested a Hello World app in FeedHenry.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;This guide demonstrates step-by-step how to create and run your first FeedHenry Hello World project.&lt;br&gt;
    
    </summary>
    
    
      <category term="feedhenry" scheme="http://blog.joshdreagan.com/tags/feedhenry/"/>
    
  </entry>
  
  <entry>
    <title>Getting Started - Camel on EAP</title>
    <link href="http://blog.joshdreagan.com/2015/04/10/getting_started__camel_on_eap/"/>
    <id>http://blog.joshdreagan.com/2015/04/10/getting_started__camel_on_eap/</id>
    <published>2015-04-10T06:00:00.000Z</published>
    <updated>2016-08-01T21:00:45.000Z</updated>
    
    <content type="html"><![CDATA[<p>This guide demonstrates step-by-step how to create a sample Camel project in JBoss Developer Studio (JBDS) using the Maven archetypes that come out of the box. Specifically, we’ll be creating a contract-first based web services java project. We’ll then convert that project to a WAR file so that it can be deployed to JBoss EAP. Finally, we’ll deploy the project and verify that it is running.<br><a id="more"></a></p><p>Here are a few assumptions before you begin:</p><ul><li>You already have a supported JDK installed (ie, Oracle’s JDK version 6 or 7)</li><li>You already have Maven version 3.x installed</li><li>You already have JDBS installed (tested with version 7.1.1, but should work with newer)</li><li>You already have the “JBoss Integration and SOA Development” tools for JBDS installed</li><li>You already have JBoss EAP installed (tested with version 6.3.0, but should work with others)</li></ul><p>After you’ve met all the prerequisites, you can proceed with the guide.</p><h1 id="Step-1-Create-A-New-Fuse-Project"><a href="#Step-1-Create-A-New-Fuse-Project" class="headerlink" title="Step 1: Create A New Fuse Project"></a>Step 1: Create A New Fuse Project</h1><p>Start off by creating a new project. Click <strong>File-&gt;New-&gt;Project…</strong> to start the “New Project” wizard.</p><img src="/2015/04/10/getting_started__camel_on_eap/new_project-01.png" title="[New Project]"><p>Select “<strong>Fuse Project</strong>“ as the project type and click “<strong>Next &gt;</strong>“.</p><img src="/2015/04/10/getting_started__camel_on_eap/new_project-02.png" title="[New Project]"><p>Specify your preferred project location (or let it use the default) and click “<strong>Next &gt;</strong>“.</p><img src="/2015/04/10/getting_started__camel_on_eap/new_project-03.png" title="[New Project]"><p>Select the appropriate Maven archetype from the list. The one we use for this example is “<strong>io.fabric8:camel-cxf-contract-first-arch:1.0.0.redhat-379</strong>“. Enter your preferred <em>Group Id</em>, <em>Artifact Id</em>, <em>Version</em>, &amp; <em>Package</em>. When done, click “<strong>Finish</strong>“. </p><img src="/2015/04/10/getting_started__camel_on_eap/new_project-04.png" title="[New Project]"><p>Your new project should be created. If this is the first time, it can take a few minutes as JBDS downloads all the required Maven dependencies.</p><h1 id="Step-2-Convert-Project-To-WAR-Format"><a href="#Step-2-Convert-Project-To-WAR-Format" class="headerlink" title="Step 2: Convert Project To WAR Format"></a>Step 2: Convert Project To WAR Format</h1><p>First we need to change the packaging type in the Maven POM so that we will build a WAR file instead of the default JAR file. To do so, open up the project’s <strong>pom.xml</strong> file, click on the drop-down list next to “<strong>Packaging:</strong>“, and select “<strong>war</strong>“ as the type. Save your changes when done.</p><img src="/2015/04/10/getting_started__camel_on_eap/convert_to_war-01.png" title="[Convert To WAR]"><p>Next, we need to tell the Eclipse Maven Plugin to update the project configuration so that JBDS will add the appropriate facets and display the project structure correctly. So first, right-click on the project and select “<strong>Maven-&gt;Update Project…</strong>“ to start the “Update Maven Project” wizard.</p><img src="/2015/04/10/getting_started__camel_on_eap/maven_update_project-01.png" title="[Maven Update Project]"><p>Make sure the project is selected and click “<strong>OK</strong>“.</p><img src="/2015/04/10/getting_started__camel_on_eap/maven_update_project-02.png" title="[Maven Update Project]"><p>You should notice that the project structure changes a bit.</p><p>Now we will need to add some Maven dependencies so that we can bootstrap our Camel Context in a Servlet container. Open up the project’s <strong>pom.xml</strong> file, and select the “<strong>Dependencies</strong>“ tab.</p><img src="/2015/04/10/getting_started__camel_on_eap/add_dependencies-01.png" title="[Add Dependencies]"><p>Click on the “<strong>Add…</strong>“ button to start the “Select Dependency” wizard.</p><img src="/2015/04/10/getting_started__camel_on_eap/add_dependencies-02.png" title="[Add Dependencies]"><p>Fill out the input boxes as shown below and click “<strong>OK</strong>“ when done. <em>Don’t forget to save your changes.</em></p><img src="/2015/04/10/getting_started__camel_on_eap/add_dependencies-03.png" title="[Add Dependencies]"><p>Once we have all of our dependencies in place, we can create our deployment descriptor (ie, the <strong>web.xml</strong> file). So right-click on the “<strong>Deployment Descriptor:</strong>“ section in the project view and select “<strong>Generate Deployment Descriptor Stub</strong>“. This will create a skeleton <strong>web.xml</strong> file that you can use as a starting point.</p><img src="/2015/04/10/getting_started__camel_on_eap/create_dd-01.png" title="[Create DD]"><p>Now double-click on the “<strong>Deployment Descriptor:</strong>“ section in the project view to edit the <strong>web.xml</strong> file. We will need to add several elements.</p><ul><li>A <code>context-param</code> element to tell Spring where the XML files are located.</li><li>A <code>listener</code> element to load Spring’s ServletContextListener which will bind the Spring Context to the Servlet’s lifecycle.</li><li>A <code>servlet</code> element to name the CXF Servlet.</li><li>A <code>servlet-mapping</code> element to map the CXF Servlet to a URL pattern.</li></ul><p>If you’d like, you can just copy/paste the following XML:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"</span> <span class="attr">version</span>=<span class="string">"3.0"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>camel-cxf-contract-first<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:META-INF/spring/*.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">listener</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>CXFServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.apache.cxf.transport.servlet.CXFServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>CXFServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/soap/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></div></pre></td></tr></table></figure><p>Save your changes and close the <strong>web.xml</strong> file.</p><p>By default, the generated CXF configuration will boot up an embedded Jetty server and bind to “<em><a href="http://localhost:9000/order/" target="_blank" rel="noopener">http://localhost:9000/order/</a></em>“. Since we will be deploying to a server that already has a Servlet container, we can let CXF use the provided one instead. So first, find the <strong>camel-cxf.xml</strong> file in the “<strong>Project Explorer</strong>“ tab and open it up.</p><img src="/2015/04/10/getting_started__camel_on_eap/change_bind_address-01.png" title="[Change Bind Address]"><p>We simply need to change the <code>address</code> attribute of the <code>cxf:cxfEndpoint</code> element from “<em><a href="http://localhost:9000/order/" target="_blank" rel="noopener">http://localhost:9000/order/</a></em>“ to “<em>/order/</em>“.</p><img src="/2015/04/10/getting_started__camel_on_eap/change_bind_address-02.png" title="[Change Bind Address]"><p>The result should look like the image below. Save your changes and close the file.</p><img src="/2015/04/10/getting_started__camel_on_eap/change_bind_address-03.png" title="[Change Bind Address]"><p>Finally, you may have noticed that the “<strong>Problems</strong>“ tab is showing some errors. This is because the Maven archetype that we used has a WSDL that contains 2 minor issues.</p><img src="/2015/04/10/getting_started__camel_on_eap/fix_wsdl-01.png" title="[Fix WSDL]"><p>To fix the issues, we’ll need to edit the WSDL file. To do so, either double-click on the error in the “<strong>Problems</strong>“ tab, or on the WSDL in the “<strong>Project Explorer</strong>“ tab to open the <strong>order.wsdl</strong> file. Now locate the <code>wsdl:binding</code> element. It should be toward the bottom of the file. It should contain <code>wsdl:input</code> and <code>wsdl:output</code> elements. Both of which have a <code>soap:body</code> element with a <code>parts</code> attribute as shown below.</p><img src="/2015/04/10/getting_started__camel_on_eap/fix_wsdl-02.png" title="[Fix WSDL]"><p>Simply remove the <code>parts</code> attribute. The resulting file should look like the image below. Save your changes and close the file.</p><img src="/2015/04/10/getting_started__camel_on_eap/fix_wsdl-03.png" title="[Fix WSDL]"><p>That’s it for the changes. The project should now be ready to deploy to JBoss EAP.</p><h1 id="Step-3-Deploy-Project-To-JBoss-EAP"><a href="#Step-3-Deploy-Project-To-JBoss-EAP" class="headerlink" title="Step 3: Deploy Project To JBoss EAP"></a>Step 3: Deploy Project To JBoss EAP</h1><p>If you don’t have one already, create a new server configuration in JBDS. Click on the “<strong>Servers</strong>“ tab. If you don’t have any server configurations, you will see a link like the image below. Click on the link to start the “<strong>New Server</strong>“ wizard.</p><img src="/2015/04/10/getting_started__camel_on_eap/create_new_server-01.png" title="[Create New Server]"><p>Select “<strong>JBoss Enterprise Application Platform 6.1+</strong>“ and click “<strong>Next &gt;</strong>“.</p><img src="/2015/04/10/getting_started__camel_on_eap/create_new_server-02.png" title="[Create New Server]"><p>Click the “<strong>Browse</strong>“ button and navigate to the root directory of your JBoss EAP installation. Click “<strong>Next &gt;</strong>“ when done.</p><img src="/2015/04/10/getting_started__camel_on_eap/create_new_server-03.png" title="[Create New Server]"><p>Select your desired options, or leave the defaults and click “<strong>Next &gt;</strong>“.</p><img src="/2015/04/10/getting_started__camel_on_eap/create_new_server-04.png" title="[Create New Server]"><p>Select the project from the “<strong>Available:</strong>“ pane and click the “<strong>Add</strong>“ button.</p><img src="/2015/04/10/getting_started__camel_on_eap/create_new_server-05.png" title="[Create New Server]"><p>You should see the project move over to the “<strong>Configured:</strong>“ pane as shown below.</p><img src="/2015/04/10/getting_started__camel_on_eap/create_new_server-06.png" title="[Create New Server]"><p>Click the “<strong>Finish</strong>“ button when done. You should now have a new server configuration as shown below.</p><img src="/2015/04/10/getting_started__camel_on_eap/create_new_server-07.png" title="[Create New Server]"><p>Next, start the server. You can do so by clicking the <img src="/2015/04/10/getting_started__camel_on_eap/start_server-01.png" style="display: inline"> icon as shown below.</p><img src="/2015/04/10/getting_started__camel_on_eap/start_server-02.png" title="[Start Server]"><p>If the server starts successfully, you should see no errors in your “<strong>Console</strong>“ tab.</p><img src="/2015/04/10/getting_started__camel_on_eap/start_server-03.png" title="[Start Server]"><p>Finally, open up a web browser (or use the one built into JBDS by clicking the <img src="/2015/04/10/getting_started__camel_on_eap/verify_deployment-01.png" style="display: inline"> icon) and navigate to “<em><a href="http://localhost:8080/camel-cxf-contract-first/soap/order?wsdl" target="_blank" rel="noopener">http://localhost:8080/camel-cxf-contract-first/soap/order?wsdl</a></em>“. If the everything was successful, you should see the WSDL contents displayed as shown in the image below.</p><img src="/2015/04/10/getting_started__camel_on_eap/verify_deployment-02.png" title="[Verify Deployment]"><p>At this point, you have successfully created and deployed a Camel/CXF web service to JBoss EAP. You can do further testing using a tool like SoapUI (or any SOAP service testing tool).</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;This guide demonstrates step-by-step how to create a sample Camel project in JBoss Developer Studio (JBDS) using the Maven archetypes that come out of the box. Specifically, we’ll be creating a contract-first based web services java project. We’ll then convert that project to a WAR file so that it can be deployed to JBoss EAP. Finally, we’ll deploy the project and verify that it is running.&lt;br&gt;
    
    </summary>
    
    
      <category term="fuse" scheme="http://blog.joshdreagan.com/tags/fuse/"/>
    
      <category term="camel" scheme="http://blog.joshdreagan.com/tags/camel/"/>
    
      <category term="jboss" scheme="http://blog.joshdreagan.com/tags/jboss/"/>
    
      <category term="wildfly" scheme="http://blog.joshdreagan.com/tags/wildfly/"/>
    
      <category term="eap" scheme="http://blog.joshdreagan.com/tags/eap/"/>
    
      <category term="cxf" scheme="http://blog.joshdreagan.com/tags/cxf/"/>
    
  </entry>
  
</feed>
