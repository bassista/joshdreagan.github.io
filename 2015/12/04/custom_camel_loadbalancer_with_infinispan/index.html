<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset="utf-8">
    
    <title>Custom Camel LoadBalancer With Infinispan | Reagan&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Apache Camel is a pretty full-featured EIP implementation framework. It has several existing strategies for load-balancing right out of the box. Round Robin, Random, Sticky, Weighted Round Robin, Weig">
<meta name="keywords" content="camel,wildfly,infinispan">
<meta property="og:type" content="article">
<meta property="og:title" content="Custom Camel LoadBalancer With Infinispan">
<meta property="og:url" content="http://blog.joshdreagan.com/2015/12/04/custom_camel_loadbalancer_with_infinispan/index.html">
<meta property="og:site_name" content="Reagan&#39;s Blog">
<meta property="og:description" content="Apache Camel is a pretty full-featured EIP implementation framework. It has several existing strategies for load-balancing right out of the box. Round Robin, Random, Sticky, Weighted Round Robin, Weig">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://blog.joshdreagan.com/2015/12/04/custom_camel_loadbalancer_with_infinispan/post-bg.png">
<meta property="og:updated_time" content="2016-08-01T21:00:45.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Custom Camel LoadBalancer With Infinispan">
<meta name="twitter:description" content="Apache Camel is a pretty full-featured EIP implementation framework. It has several existing strategies for load-balancing right out of the box. Round Robin, Random, Sticky, Weighted Round Robin, Weig">
<meta name="twitter:image" content="http://blog.joshdreagan.com/2015/12/04/custom_camel_loadbalancer_with_infinispan/post-bg.png">
    

    
        <link rel="alternate" href="atom.xml" title="Reagan&#39;s Blog" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="../../../../vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../../../vendor/open-sans/styles.css">
    <link rel="stylesheet" href="../../../../vendor/source-code-pro/styles.css">

    <link rel="stylesheet" href="../../../../css/style.css">

    <script src="../../../../vendor/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="../../../../vendor/fancybox/jquery.fancybox.css">
    
    
        <script type="text/javascript">
(function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-81075900-1', 'auto');
ga('send', 'pageview');

</script>
    
    
    

</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="../../../../index.html" id="logo">
                
                <span class="site-title">Reagan&#39;s Blog</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="../../../../.">Home</a>
                
                    <a class="main-nav-link" href="../../../../archives">Archives</a>
                
                    <a class="main-nav-link" href="../../../../tags">Tags</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="https://www.gravatar.com/avatar/29313b56e332976a2383b911a27c15b2" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '../../../../content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="../../../../js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="../../../../.">Home</a></td>
                
                    <td><a class="main-nav-link" href="../../../../archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="../../../../tags">Tags</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="https://www.gravatar.com/avatar/29313b56e332976a2383b911a27c15b2?s=128" />
            <h2 id="name">Josh Reagan</h2>
            <h3 id="title">Software Engineer</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Colorado, USA</span>
            <a id="follow" target="_blank" href="https://github.com/joshdreagan/">FOLLOW</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                21
                <span>posts</span>
            </div>
            <div class="article-info-block">
                19
                <span>tags</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="../../../../atom.xml" target="_blank" title="rss" class=tooltip>
                            <i class="fa fa-rss"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="https://twitter.com/joshdreagan" target="_blank" title="twitter" class=tooltip>
                            <i class="fa fa-twitter"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="https://plus.google.com/+JoshReagan" target="_blank" title="google-plus" class=tooltip>
                            <i class="fa fa-google-plus"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="https://www.linkedin.com/in/joshdreagan" target="_blank" title="linkedin" class=tooltip>
                            <i class="fa fa-linkedin"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="http://github.com/joshdreagan" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main"><article id="post-custom_camel_loadbalancer_with_infinispan" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            
	
		<img src="post-bg.png" class="article-banner" />
	



        
        
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
            Custom Camel LoadBalancer With Infinispan
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="">
            <time datetime="2015-12-04T07:00:00.000Z" itemprop="datePublished">2015-12-04</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="../../../../tags/camel/">camel</a>, <a class="tag-link" href="../../../../tags/infinispan/">infinispan</a>, <a class="tag-link" href="../../../../tags/wildfly/">wildfly</a>
    </div>

                    </div>
                
            </header>
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>Apache Camel is a pretty full-featured EIP implementation framework. It has several existing strategies for load-balancing right out of the box. Round Robin, Random, Sticky, Weighted Round Robin, Weighted Random,… the list goes on and on. But being that it’s a very well written and pluggable framework, it also gives you the ability to drop in your own custom strategies should you find that none of the existing ones meet your specific needs. So for this post, I created a custom Camel Load Balancer implementation utilizing an Infinispan cache to dynamically discover and load-balance between destination endpoints.<br><a id="more"></a></p>
<blockquote>
<p>The sample code for this post can be found at <a href="https://github.com/joshdreagan/infinispan-discovery" target="_blank" rel="noopener">https://github.com/joshdreagan/infinispan-discovery</a></p>
</blockquote>
<h2 id="Why"><a href="#Why" class="headerlink" title="Why?"></a>Why?</h2><p>Why would I do such a thing? Well… there’s a few good reasons.</p>
<p>First, all of the existing load-balancer strategies work on a static list. So if I know all of my endpoints ahead of time, no problem. I just code them into my Camel route. But what if my list of endpoints changes between environments? Maybe I could use properties. Well… only if the number of endpoints is static. Which brings me to the next reason…</p>
<p>All of the existing load-balancer strategies are configured at startup. So what do I do if my list changes dynamically at runtime? Let’s say that I want to do service discovery and load-balance between the currently active/registered backend services. If you’re familiar with Camel, you might be thinking “Why not just use the Camel Fabric Component? It does dynamic load-balancing and service discovery. Problem solved right?”. If all of my services are running in containers that are managed by Fabric8, that is a viable solution. But what if I want to discover some endpoints that are running on JBoss EAP instances. Or what if I’m not running a Fabric8 ensemble at all?</p>
<p>Finally, the most important reason… Because I can. :)</p>
<h2 id="Implementation-Details"><a href="#Implementation-Details" class="headerlink" title="Implementation Details"></a>Implementation Details</h2><p>Creating a custom Camel Load Balancer implementation is fairly straight forward. You just create a class and implement the <code>LoadBalancer</code> interface. There’s even a base class (<code>LoadBalancerSupport</code>) that you can extend that will take care of some of the boilerplate coding for you. You then just fill in the details of how it picks the next endpoint from its internal list. Pretty simple right?</p>
<p>In my case, however, I’m not actually coming up with my own strategy for how to pick endpoints. I’m really just augmenting some existing strategy with a dynamic list of endpoints. So to be more specific, I’m not interested in implementing my own flavor of the Random, Round Robin, Sticky, … strategies. No need to reinvent that wheel. Instead, I just want to decorate those existing strategies and provide them with some additional capabilities. So I use the decorator pattern. That allows me to ignore all the tom-foolery of the load-balancing itself and concentrate on the portion that I really want. The dynamic service discovery.</p>
<p>Here’s my custom load-balancer class (or at least the important parts):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.apache.camel.processor.loadbalancer;</div><div class="line"></div><div class="line"><span class="comment">// Import statements removed for brevity.</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JCacheLoadBalancer</span> <span class="keyword">extends</span> <span class="title">ServiceSupport</span> <span class="keyword">implements</span> <span class="title">LoadBalancer</span>, <span class="title">CamelContextAware</span>, <span class="title">InitializingBean</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(JCacheLoadBalancer.class);</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LoadBalancer DEFAULT_DELEGATE = <span class="keyword">new</span> RoundRobinLoadBalancer();</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Cache&lt;String, Set&lt;String&gt;&gt; registry;</div><div class="line">  <span class="keyword">private</span> String groupId;</div><div class="line">  <span class="keyword">private</span> LoadBalancer delegate;</div><div class="line">  <span class="keyword">private</span> UriPreProcessor uriPreProcessor;</div><div class="line">  <span class="keyword">private</span> Boolean throwExceptionIfEmpty;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> Map&lt;String, Processor&gt; processorMap;</div><div class="line">  <span class="keyword">private</span> CacheEntryListenerConfiguration&lt;String, Set&lt;String&gt;&gt; registryListenerConfiguration;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> CamelContext camelContext;</div><div class="line"></div><div class="line">  <span class="comment">// Getters and setters removed for brevity.</span></div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addProcessor</span><span class="params">(Processor processor)</span> </span>&#123;</div><div class="line">    delegate.addProcessor(processor);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeProcessor</span><span class="params">(Processor processor)</span> </span>&#123;</div><div class="line">    delegate.removeProcessor(processor);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> List&lt;Processor&gt; <span class="title">getProcessors</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> delegate.getProcessors();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Exchange exchange, AsyncCallback callback)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> ((getProcessors() == <span class="keyword">null</span> || getProcessors().isEmpty()) &amp;&amp; throwExceptionIfEmpty) &#123;</div><div class="line">      <span class="keyword">if</span> (throwExceptionIfEmpty) &#123;</div><div class="line">        exchange.setException(<span class="keyword">new</span> LoadBalancerUnavailableException(String.format(<span class="string">"No URIs found for service '%s'."</span>, groupId)));</div><div class="line">      &#125;</div><div class="line">      callback.done(<span class="keyword">true</span>);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">return</span> delegate.process(exchange, callback);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Exchange exchange)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">if</span> ((getProcessors() == <span class="keyword">null</span> || getProcessors().isEmpty()) &amp;&amp; throwExceptionIfEmpty) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> LoadBalancerUnavailableException(String.format(<span class="string">"No URIs found for service '%s'."</span>, groupId));</div><div class="line">    &#125;</div><div class="line">    delegate.process(exchange);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doStart</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">if</span> (delegate == DEFAULT_DELEGATE) &#123;</div><div class="line">      ((Service) delegate).start();</div><div class="line">    &#125;</div><div class="line">    registry.registerCacheEntryListener(registryListenerConfiguration);</div><div class="line">    processUris(registry.get(groupId));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doStop</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    registry.deregisterCacheEntryListener(registryListenerConfiguration);</div><div class="line">    <span class="keyword">if</span> (delegate == DEFAULT_DELEGATE) &#123;</div><div class="line">      ((Service) delegate).stop();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Objects.requireNonNull(registry, <span class="string">"The registry property must not be null."</span>);</div><div class="line">    Objects.requireNonNull(groupId, <span class="string">"The groupId property must not be null."</span>);</div><div class="line">    Objects.requireNonNull(camelContext, <span class="string">"The camelContext property must not be null."</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (delegate == <span class="keyword">null</span>) &#123;</div><div class="line">      delegate = DEFAULT_DELEGATE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (throwExceptionIfEmpty == <span class="keyword">null</span>) &#123;</div><div class="line">      throwExceptionIfEmpty = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    processorMap = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    registryListenerConfiguration = <span class="keyword">new</span> MutableCacheEntryListenerConfiguration&lt;&gt;(<span class="keyword">new</span> LookupCacheListenerFactory(), <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processUris</span><span class="params">(Set&lt;String&gt; uris)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">if</span> (uris == <span class="keyword">null</span>) &#123;</div><div class="line">      uris = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (String uri : processorMap.keySet()) &#123;</div><div class="line">      <span class="keyword">if</span> (!uris.contains(uri)) &#123;</div><div class="line">        log.info(String.format(<span class="string">"Removing uri: %s"</span>, uri));</div><div class="line">        Processor processor = processorMap.remove(uri);</div><div class="line">        removeProcessor(processor);</div><div class="line">        <span class="keyword">if</span> (processor <span class="keyword">instanceof</span> Producer) &#123;</div><div class="line">          camelContext.removeEndpoint(((Producer) processor).getEndpoint());</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (String uri : uris) &#123;</div><div class="line">      <span class="keyword">if</span> (!processorMap.containsKey(uri)) &#123;</div><div class="line">        log.info(String.format(<span class="string">"Adding uri: %s"</span>, uri));</div><div class="line">        String processedUri = uri;</div><div class="line">        <span class="keyword">if</span> (uriPreProcessor != <span class="keyword">null</span>) &#123;</div><div class="line">          processedUri = uriPreProcessor.process(uri);</div><div class="line">        &#125;</div><div class="line">        Processor processor = camelContext.getEndpoint(processedUri).createProducer();</div><div class="line">        processorMap.put(uri, processor);</div><div class="line">        addProcessor(processor);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">LookupCacheListener</span> <span class="keyword">implements</span> <span class="title">CacheEntryCreatedListener</span>&lt;<span class="title">String</span>, <span class="title">Set</span>&lt;<span class="title">String</span>&gt;&gt;,</span></div><div class="line">          <span class="title">CacheEntryUpdatedListener</span>&lt;<span class="title">String</span>, <span class="title">Set</span>&lt;<span class="title">String</span>&gt;&gt;,</div><div class="line">          <span class="title">CacheEntryRemovedListener</span>&lt;<span class="title">String</span>, <span class="title">Set</span>&lt;<span class="title">String</span>&gt;&gt;,</div><div class="line">          <span class="title">CacheEntryExpiredListener</span>&lt;<span class="title">String</span>, <span class="title">Set</span>&lt;<span class="title">String</span>&gt;&gt;,</div><div class="line">          <span class="title">Serializable</span> &#123;</div><div class="line"></div><div class="line">    <span class="comment">// All listener methods removed for brevity. They just delegate to the onEvent method anyway.</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(Iterable&lt;CacheEntryEvent&lt;? extends String, ? extends Set&lt;String&gt;&gt;&gt; events)</span> <span class="keyword">throws</span> CacheEntryListenerException </span>&#123;</div><div class="line">      <span class="keyword">for</span> (CacheEntryEvent&lt;? extends String, ? extends Set&lt;String&gt;&gt; event : events) &#123;</div><div class="line">        log.debug(String.format(<span class="string">"Got a cache event: %s"</span>, event));</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          processUris(event.getValue());</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> CacheEntryListenerException(e);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">LookupCacheListenerFactory</span> <span class="keyword">implements</span> <span class="title">Factory</span>&lt;<span class="title">LookupCacheListener</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> LookupCacheListener <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> LookupCacheListener();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>You can see that it’s just delegating most of the methods (ie, the <code>addProcessor</code>, <code>getProcessor</code>, and <code>removeProcessor</code> methods) to whatever existing implementation that it’s decorating. The actual methods that do the load-balancing (ie, the <code>process</code> methods) do a little bit of work, but end up just delegating as well. So I didn’t actually have to do any algorithm work and I still get to use all the existing strategies. Pretty neat!</p>
<p>In addition to a delegate <code>LoadBalancer</code> implementation, this class expects that you will give it a fully-configured jCache instance. In my example, I used Infinispan. But I could have just as easily used any other spec compliant implementation. Here’s my Infinispan configuration:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">infinispan</span> <span class="attr">xmlns</span>=<span class="string">"..."</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">jgroups</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">stack-file</span> <span class="attr">name</span>=<span class="string">"external-file"</span> <span class="attr">path</span>=<span class="string">"default-configs/default-jgroups-tcp.xml"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">jgroups</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">cache-container</span> <span class="attr">default-cache</span>=<span class="string">"default"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">local-cache</span> <span class="attr">name</span>=<span class="string">"registry-cache"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">transport</span> <span class="attr">cluster</span>=<span class="string">"registry-cluster"</span> <span class="attr">stack</span>=<span class="string">"external-file"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">replicated-cache</span> <span class="attr">name</span>=<span class="string">"registry-cache"</span> <span class="attr">mode</span>=<span class="string">"SYNC"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">cache-container</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">infinispan</span>&gt;</span></div></pre></td></tr></table></figure>
<p>Now let’s get to the part that’s actually doing some work. The <code>LookupCacheListener</code> class just implements the various <code>CacheListener</code> interfaces from the jCache API. If it gets any events on the cache entry containing our endpoints, it simply updates the delegate’s internal list of processors. So as services come and go they can register their URIs in the cache, our listener will be notified, and our list of available load-balancer endpoints will be updated.</p>
<p>The final piece to discuss for this load-balancer implementation is the <code>UriPreProcessor</code>. This is an interface that I created to allow an implementation to customize the URI in some way before adding it to the list. The idea is that other services that are registering themselves might not know that they’re going to be invoked from a Camel endpoint. So they likely won’t add options like <code>bridgeEndpoint=true</code> to the URI. An implementation of this interface would allow you to add such options on their behalf. Here’s the interface itself:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.apache.camel.processor.loadbalancer;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UriPreProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">process</span><span class="params">(String uri)</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>And here’s a sample implementation that adds the options:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.jboss.poc.greeter.camel;</div><div class="line"></div><div class="line"><span class="comment">// Import statements removed for brevity.</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GreeterServiceUriPreProcessor</span> <span class="keyword">implements</span> <span class="title">UriPreProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">process</span><span class="params">(String uri)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Map&lt;String, Object&gt; options = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    options.put(<span class="string">"bridgeEndpoint"</span>, <span class="keyword">true</span>);</div><div class="line">    <span class="keyword">return</span> URISupport.appendParametersToURI(uri, options);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Now all that’s left is to actually use it in my Camel routes. To do so, I declare it just like any other bean. Then I use the <code>custom</code> element in my <code>loadBalance</code> to <code>ref</code> it. Looks something like this:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"..."</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"cachingProvider"</span></span></div><div class="line">        <span class="attr">class</span>=<span class="string">"javax.cache.Caching"</span> <span class="attr">factory-method</span>=<span class="string">"getCachingProvider"</span>/&gt;</div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"cacheManager"</span></span></div><div class="line">        <span class="attr">factory-bean</span>=<span class="string">"cachingProvider"</span> <span class="attr">factory-method</span>=<span class="string">"getCacheManager"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"META-INF/infinispan/infinispan-clustered.xml"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.util.ClassUtils"</span></span></div><div class="line">            <span class="attr">factory-method</span>=<span class="string">"getDefaultClassLoader"</span>/&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"registryCache"</span></span></div><div class="line">        <span class="attr">factory-bean</span>=<span class="string">"cacheManager"</span> <span class="attr">factory-method</span>=<span class="string">"getCache"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"registry-cache"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jCacheLoadBalancer"</span></span></div><div class="line">        <span class="attr">class</span>=<span class="string">"org.apache.camel.processor.loadbalancer.JCacheLoadBalancer"</span></div><div class="line">        <span class="attr">init-method</span>=<span class="string">"start"</span> <span class="attr">destroy-method</span>=<span class="string">"stop"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"registry"</span> <span class="attr">ref</span>=<span class="string">"registryCache"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"groupId"</span></span></div><div class="line">              <span class="attr">value</span>=<span class="string">"/services/soap-http/&#123;http://poc.jboss.org/greeter&#125;GreeterService"</span>/&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"delegate"</span> <span class="attr">ref</span>=<span class="string">"randomLoadBalancer"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"uriPreProcessor"</span> <span class="attr">ref</span>=<span class="string">"greeterServiceUriPreProcessor"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"greeterServiceUriPreProcessor"</span></span></div><div class="line">        <span class="attr">class</span>=<span class="string">"org.jboss.poc.greeter.camel.GreeterServiceUriPreProcessor"</span>/&gt;</div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"randomLoadBalancer"</span></span></div><div class="line">        <span class="attr">class</span>=<span class="string">"org.apache.camel.processor.loadbalancer.RandomLoadBalancer"</span>/&gt;</div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">camelContext</span> <span class="attr">id</span>=<span class="string">"greeterGateway"</span></span></div><div class="line">                <span class="attr">trace</span>=<span class="string">"false"</span> <span class="attr">xmlns</span>=<span class="string">"http://camel.apache.org/schema/spring"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">route</span> <span class="attr">id</span>=<span class="string">"proxyRoute"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">from</span> <span class="attr">uri</span>=<span class="string">"jetty:http://localhost:9000/gateway/GreeterService?matchOnUriPrefix=true&amp;amp;bridgeEndpoint=true"</span>/&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">onException</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">exception</span>&gt;</span>org.apache.camel.processor.loadbalancer.LoadBalancerUnavailableException<span class="tag">&lt;/<span class="name">exception</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">handled</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">constant</span>&gt;</span>true<span class="tag">&lt;/<span class="name">constant</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">handled</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">setHeader</span> <span class="attr">headerName</span>=<span class="string">"CamelHttpResponseCode"</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">constant</span>&gt;</span>404<span class="tag">&lt;/<span class="name">constant</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">setHeader</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">setBody</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">constant</span>&gt;</span>NOT FOUND<span class="tag">&lt;/<span class="name">constant</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">setBody</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">onException</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">loadBalance</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">custom</span> <span class="attr">ref</span>=<span class="string">"jCacheLoadBalancer"</span>/&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">loadBalance</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">route</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;/<span class="name">camelContext</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>That’s it for the Camel side of things. Now let’s discuss how to get some services registered.</p>
<p>In my example, I just created a simple JAX-WS service in JBoss WildFly. Here’s the code so you can see how simple it is:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.jboss.poc.greeter.impl;</div><div class="line"></div><div class="line"><span class="comment">// Import statements removed for brevity.</span></div><div class="line"></div><div class="line"><span class="meta">@WebService</span>(endpointInterface = <span class="string">"org.jboss.poc.greeter.Greeter"</span>,</div><div class="line">            serviceName = <span class="string">"GreeterService"</span>,</div><div class="line">            portName = <span class="string">"GreeterServicePort"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnglishGreeter</span> <span class="keyword">implements</span> <span class="title">Greeter</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getGreeting</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">    String greeting = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      greeting = String.format(<span class="string">"Hello %s from %s!"</span>, name, InetAddress.getLocalHost().getHostAddress());</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      greeting = String.format(<span class="string">"Hello %s! I was unable to find my IP :(..."</span>, name);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> greeting;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>For this service, I created a <code>ServletContextListener</code> to register/unregister it’s URI to/from the jCache.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.jboss.poc.greeter.impl;</div><div class="line"></div><div class="line"><span class="comment">// Import statements removed for brevity.</span></div><div class="line"></div><div class="line"><span class="meta">@WebListener</span>()</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GreeterServiceRegistrar</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVICE_NAMESPACE = <span class="string">"http://poc.jboss.org/greeter"</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVICE_NAME = <span class="string">"GreeterService"</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGISTRY_CACHE_NAME = <span class="string">"registry-cache"</span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(GreeterServiceRegistrar.class);</div><div class="line"></div><div class="line">  <span class="meta">@Inject</span></div><div class="line">  <span class="keyword">private</span> DefaultCacheManager cacheManager;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent sce)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> String key = getServiceKey();</div><div class="line">    <span class="keyword">final</span> String uri = getServiceURI(sce);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (cacheManager != <span class="keyword">null</span>) &#123;</div><div class="line">      log.info(String.format(<span class="string">"Registering service: &#123;'%s': '%s'&#125;"</span>, key, uri));</div><div class="line"></div><div class="line">      Cache&lt;String, Set&lt;String&gt;&gt; cache = cacheManager.getCache(REGISTRY_CACHE_NAME);</div><div class="line">      Set&lt;String&gt; uris = cache.getOrDefault(key, <span class="keyword">new</span> HashSet&lt;String&gt;());</div><div class="line">      uris.add(uri);</div><div class="line">      cache.put(key, uris);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      log.warn(String.format(<span class="string">"Unable to register service: &#123;'%s': '%s'&#125;. CacheManager is null."</span>, key, uri));</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextDestroyed</span><span class="params">(ServletContextEvent sce)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> String key = getServiceKey();</div><div class="line">    <span class="keyword">final</span> String uri = getServiceURI(sce);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (cacheManager != <span class="keyword">null</span>) &#123;</div><div class="line">      log.info(String.format(<span class="string">"Unregistering service: &#123;'%s': '%s'&#125;"</span>, key, uri));</div><div class="line">      Cache&lt;String, Set&lt;String&gt;&gt; cache = cacheManager.getCache(REGISTRY_CACHE_NAME);</div><div class="line">      Set&lt;String&gt; uris = cache.getOrDefault(key, <span class="keyword">new</span> HashSet&lt;String&gt;());</div><div class="line">      uris.remove(uri);</div><div class="line">      cache.put(key, uris);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      log.warn(String.format(<span class="string">"Unable to unregister service: &#123;'%s': '%s'&#125;. CacheManager is null."</span>, key, uri));</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> String <span class="title">getServiceKey</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// Contents removed for brevity. Method forms and returns the cache key where we'll store our URIs.</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> String <span class="title">getServiceURI</span><span class="params">(ServletContextEvent sce)</span> </span>&#123;</div><div class="line">    <span class="comment">// Contents removed for brevity. Method grabs the current IP and port that the server is bound to and forms a URI.</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>So now when my <code>ServletContext</code> is started, my JAX-WS service URI will be registered. And when it is stopped, my URI will be removed. Since I configured my Infinispan cache the same on both the JBoss WildFly and Camel sides, the local cache instances are connected and will receive events and updates.</p>
<p>That’s it! If you want to give it a go, check out the full source code at <a href="https://github.com/joshdreagan/infinispan-discovery" target="_blank" rel="noopener">https://github.com/joshdreagan/infinispan-discovery</a>. Hopefully it’s useful…</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blog.joshdreagan.com/2015/12/04/custom_camel_loadbalancer_with_infinispan/" data-id="cje9lbduz0008iwz7foejpbu7" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
        
<nav id="article-nav">
    
        <a href="../../../../2016/02/02/amqp_performance_testing/" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Newer</strong>
            <div class="article-nav-title">
                
                    AMQP Performance Testing With JBoss A-MQ
                
            </div>
        </a>
    
    
        <a href="../../../10/30/correcting_data_with_fuse_and_bpms/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Older</strong>
            <div class="article-nav-title">Correcting Malformed Data With Fuse+BPMS</div>
        </a>
    
</nav>


    
</article>


    
    <section id="comments">
    
    </section>

</section>
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">recent</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="../../../../2018/03/02/camel_cxfrs_contract_first/" class="thumbnail">
    
    
        <span style="background-image:url(../../../../2018/03/02/camel_cxfrs_contract_first//post-bg.jpg)" alt="Camel CXFRS Contract First" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="../../../../2018/03/02/camel_cxfrs_contract_first/" class="title">Camel CXFRS Contract First</a></p>
                            <p class="item-date"><time datetime="2018-03-02T07:00:51.000Z" itemprop="datePublished">2018-03-02</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="../../../../2017/12/01/upgrading_amq_6_to_amq_7/" class="thumbnail">
    
    
        <span style="background-image:url(../../../../2017/12/01/upgrading_amq_6_to_amq_7//post-bg.jpg)" alt="Upgrading AMQ 6 to AMQ 7" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="../../../../2017/12/01/upgrading_amq_6_to_amq_7/" class="title">Upgrading AMQ 6 to AMQ 7</a></p>
                            <p class="item-date"><time datetime="2017-12-01T22:30:03.000Z" itemprop="datePublished">2017-12-01</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="../../../../2017/08/16/bridging_apache_artemis/" class="thumbnail">
    
    
        <span style="background-image:url(../../../../2017/08/16/bridging_apache_artemis//post-bg.jpg)" alt="Bridging Apache Artemis" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="../../../../2017/08/16/bridging_apache_artemis/" class="title">Bridging Apache Artemis</a></p>
                            <p class="item-date"><time datetime="2017-08-16T20:18:37.000Z" itemprop="datePublished">2017-08-16</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="../../../../2017/08/14/transactions_and_alternatives_with_camel/" class="thumbnail">
    
    
        <span style="background-image:url(../../../../2017/08/14/transactions_and_alternatives_with_camel//post-bg.jpg)" alt="Transactions and Alternatives With Camel" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="../../../../2017/08/14/transactions_and_alternatives_with_camel/" class="title">Transactions and Alternatives With Camel</a></p>
                            <p class="item-date"><time datetime="2017-08-14T15:54:38.000Z" itemprop="datePublished">2017-08-14</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="../../../../2017/03/25/scaling_jboss_a-mq_on_openshift/" class="thumbnail">
    
    
        <span style="background-image:url(../../../../2017/03/25/scaling_jboss_a-mq_on_openshift//post-bg.jpg)" alt="Scaling JBoss A-MQ on OpenShift" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="../../../../2017/03/25/scaling_jboss_a-mq_on_openshift/" class="title">Scaling JBoss A-MQ on OpenShift</a></p>
                            <p class="item-date"><time datetime="2017-03-25T22:56:02.000Z" itemprop="datePublished">2017-03-25</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../../../../archives/2018/03/">March 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../archives/2017/12/">December 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../archives/2017/08/">August 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../archives/2017/03/">March 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../archives/2017/01/">January 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../archives/2016/10/">October 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../archives/2016/08/">August 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../archives/2016/07/">July 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../archives/2016/05/">May 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../archives/2016/02/">February 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../archives/2015/12/">December 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../archives/2015/10/">October 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../archives/2015/05/">May 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../archives/2015/04/">April 2015</a><span class="archive-list-count">2</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tags</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/a-mq/">a-mq</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/activemq/">activemq</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/amq/">amq</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/artemis/">artemis</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/bpms/">bpms</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/camel/">camel</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/cxf/">cxf</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/eap/">eap</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/fabric8/">fabric8</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/feedhenry/">feedhenry</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/fuse/">fuse</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/infinispan/">infinispan</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/jboss/">jboss</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/jbpm/">jbpm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/karaf/">karaf</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/narayana/">narayana</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/openshift/">openshift</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/spring-boot/">spring-boot</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/wildfly/">wildfly</a><span class="tag-list-count">3</span></li></ul>
        </div>
    </div>

    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2018 Josh Reagan<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        

    
        <script src="../../../../vendor/fancybox/jquery.fancybox.pack.js"></script>
    


<!-- Custom Scripts -->
<script src="../../../../js/main.js"></script>

    </div>
</body>
</html>